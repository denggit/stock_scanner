<!-- 图表分析部分 -->
<div class="chart-container">
    <h3><i class="fas fa-chart-area"></i> 累计收益率走势图</h3>
    
    <!-- 图表控制按钮 -->
    <div class="chart-controls">
        <button onclick="showAllFactors()" class="chart-controls button">
            <i class="fas fa-chart-line"></i> 显示所有因子
        </button>
        <button onclick="clearChart()" class="chart-controls button">
            <i class="fas fa-trash"></i> 清空图表
        </button>
        <button onclick="toggleLogScale()" class="chart-controls button" id="log-scale-btn">
            <i class="fas fa-chart-bar"></i> 对数坐标
        </button>
        <button onclick="exportChart()" class="chart-controls button">
            <i class="fas fa-download"></i> 导出图表
        </button>
    </div>
    
    <!-- 因子选择器 -->
    <div style="margin-bottom: 20px;">
        <label for="factor-selector-chart" style="font-weight: bold; margin-right: 10px;">快速选择因子:</label>
        <select id="factor-selector-chart" style="padding: 8px; border: 2px solid #e9ecef; border-radius: 5px; min-width: 200px;">
            <option value="">-- 选择因子 --</option>
            {% for factor_name in factor_names %}
            <option value="{{ factor_name }}">{{ factor_name }}</option>
            {% endfor %}
        </select>
    </div>
    
    <!-- 图表容器 -->
    <div id="cumulative-chart" style="width: 100%; height: 500px;"></div>
    
    <!-- 图表说明 -->
    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
        <h4><i class="fas fa-info-circle"></i> 图表说明</h4>
        <ul style="margin: 10px 0; padding-left: 20px;">
            <li>点击表格中的"添加"按钮可以将因子添加到图表中</li>
            <li>再次点击"添加"按钮可以移除该因子</li>
            <li>使用"显示所有因子"可以一次性显示所有因子的走势</li>
            <li>使用"对数坐标"可以更好地观察相对变化</li>
            <li>鼠标悬停可以查看具体数值</li>
        </ul>
    </div>
</div>

<!-- 统计图表 -->
<div class="chart-container">
    <h3><i class="fas fa-chart-bar"></i> 统计图表</h3>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
        <!-- 夏普比率分布 -->
        <div>
            <h4>夏普比率分布</h4>
            <div id="sharpe-distribution" style="height: 300px;"></div>
        </div>
        
        <!-- IC分布 -->
        <div>
            <h4>IC分布</h4>
            <div id="ic-distribution" style="height: 300px;"></div>
        </div>
        
        <!-- 收益率vs夏普比率散点图 -->
        <div>
            <h4>收益率 vs 夏普比率</h4>
            <div id="return-vs-sharpe" style="height: 300px;"></div>
        </div>
        
        <!-- 最大回撤分布 -->
        <div>
            <h4>最大回撤分布</h4>
            <div id="drawdown-distribution" style="height: 300px;"></div>
        </div>
    </div>
</div>

<script>
let isLogScale = false;

// 初始化图表
$(document).ready(function() {
    initializeCumulativeChart();
    initializeStatisticalCharts();
    initializeFactorSelector();
});

// 初始化累计收益率图表
function initializeCumulativeChart() {
    const layout = {
        title: '因子累计收益率对比',
        xaxis: { 
            title: '时间',
            showgrid: true,
            gridcolor: '#f0f0f0'
        },
        yaxis: { 
            title: '累计收益率',
            showgrid: true,
            gridcolor: '#f0f0f0',
            tickformat: ',.0%'
        },
        hovermode: 'x unified',
        showlegend: true,
        legend: {
            orientation: 'h',
            y: -0.2,
            x: 0.5,
            xanchor: 'center'
        },
        margin: {
            l: 60,
            r: 40,
            t: 60,
            b: 80
        },
        plot_bgcolor: 'white',
        paper_bgcolor: 'white'
    };
    
    Plotly.newPlot('cumulative-chart', [], layout);
    
    // 默认显示排名第一的因子
    const firstFactor = Object.keys(chartData)[0];
    if (firstFactor) {
        addFactorToChart(firstFactor);
    }
}

// 初始化统计图表
function initializeStatisticalCharts() {
    // 夏普比率分布
    const sharpeValues = Object.values(performanceData).map(p => p.sharpe_ratio || 0);
    const sharpeTrace = {
        x: sharpeValues,
        type: 'histogram',
        nbinsx: 20,
        name: '夏普比率分布',
        marker: {
            color: '#667eea',
            opacity: 0.7
        }
    };
    
    const sharpeLayout = {
        title: '夏普比率分布',
        xaxis: { title: '夏普比率' },
        yaxis: { title: '频次' },
        showlegend: false
    };
    
    Plotly.newPlot('sharpe-distribution', [sharpeTrace], sharpeLayout);
    
    // IC分布
    const icValues = Object.values(icData).map(ic => ic.mean_ic || 0);
    const icTrace = {
        x: icValues,
        type: 'histogram',
        nbinsx: 20,
        name: 'IC分布',
        marker: {
            color: '#28a745',
            opacity: 0.7
        }
    };
    
    const icLayout = {
        title: 'IC分布',
        xaxis: { title: 'IC值' },
        yaxis: { title: '频次' },
        showlegend: false
    };
    
    Plotly.newPlot('ic-distribution', [icTrace], icLayout);
    
    // 收益率vs夏普比率散点图
    const factorNames = Object.keys(performanceData);
    const returns = factorNames.map(name => performanceData[name].annual_return || 0);
    const sharpes = factorNames.map(name => performanceData[name].sharpe_ratio || 0);
    
    const scatterTrace = {
        x: returns,
        y: sharpes,
        mode: 'markers+text',
        type: 'scatter',
        text: factorNames,
        textposition: 'top center',
        marker: {
            size: 8,
            color: sharpes.map(s => s > 0 ? '#28a745' : '#dc3545'),
            opacity: 0.7
        },
        name: '因子分布'
    };
    
    const scatterLayout = {
        title: '年化收益率 vs 夏普比率',
        xaxis: { 
            title: '年化收益率',
            tickformat: ',.0%'
        },
        yaxis: { title: '夏普比率' },
        showlegend: false
    };
    
    Plotly.newPlot('return-vs-sharpe', [scatterTrace], scatterLayout);
    
    // 最大回撤分布
    const drawdownValues = Object.values(performanceData).map(p => p.max_drawdown || 0);
    const drawdownTrace = {
        x: drawdownValues,
        type: 'histogram',
        nbinsx: 20,
        name: '最大回撤分布',
        marker: {
            color: '#dc3545',
            opacity: 0.7
        }
    };
    
    const drawdownLayout = {
        title: '最大回撤分布',
        xaxis: { 
            title: '最大回撤',
            tickformat: ',.0%'
        },
        yaxis: { title: '频次' },
        showlegend: false
    };
    
    Plotly.newPlot('drawdown-distribution', [drawdownTrace], drawdownLayout);
}

// 初始化因子选择器
function initializeFactorSelector() {
    $('#factor-selector-chart').change(function() {
        const selectedFactor = $(this).val();
        if (selectedFactor) {
            // 清空图表
            Plotly.newPlot('cumulative-chart', [], {
                title: '因子累计收益率对比',
                xaxis: { title: '时间' },
                yaxis: { title: '累计收益率' }
            });
            
            // 添加选中的因子
            addFactorToChart(selectedFactor);
            
            // 重置所有按钮状态
            $('.chart-btn').removeClass('active').text('添加');
            $(`.chart-btn[data-factor="${selectedFactor}"]`).addClass('active').text('移除');
        }
    });
}

// 切换对数坐标
function toggleLogScale() {
    isLogScale = !isLogScale;
    const button = $('#log-scale-btn');
    
    if (isLogScale) {
        button.text('线性坐标');
        Plotly.relayout('cumulative-chart', {
            'yaxis.type': 'log',
            'yaxis.tickformat': ',.0%'
        });
    } else {
        button.text('对数坐标');
        Plotly.relayout('cumulative-chart', {
            'yaxis.type': 'linear',
            'yaxis.tickformat': ',.0%'
        });
    }
}

// 导出图表
function exportChart() {
    const chartDiv = document.getElementById('cumulative-chart');
    Plotly.downloadImage(chartDiv, {
        format: 'png',
        filename: 'factor_cumulative_returns',
        height: 600,
        width: 1200
    });
}

// 增强的添加因子到图表函数
function addFactorToChart(factorName) {
    if (!chartData[factorName]) return;
    
    const data = chartData[factorName];
    const trace = {
        x: data.dates,
        y: data.values,
        type: 'scatter',
        mode: 'lines',
        name: factorName,
        line: { 
            width: 2,
            color: getRandomColor(factorName)
        },
        hovertemplate: 
            '<b>%{fullData.name}</b><br>' +
            '时间: %{x}<br>' +
            '累计收益率: %{y:.2%}<br>' +
            '<extra></extra>'
    };
    
    Plotly.addTraces('cumulative-chart', trace);
    updateChartButtonState(factorName, true);
}

// 获取随机颜色（基于因子名称）
function getRandomColor(factorName) {
    const colors = [
        '#667eea', '#764ba2', '#f093fb', '#f5576c',
        '#4facfe', '#00f2fe', '#43e97b', '#38f9d7',
        '#fa709a', '#fee140', '#a8edea', '#fed6e3',
        '#ffecd2', '#fcb69f', '#ff9a9e', '#fecfef'
    ];
    
    let hash = 0;
    for (let i = 0; i < factorName.length; i++) {
        hash = factorName.charCodeAt(i) + ((hash << 5) - hash);
    }
    
    return colors[Math.abs(hash) % colors.length];
}

// 显示所有因子
function showAllFactors() {
    if (chartData) {
        // 清空图表
        Plotly.newPlot('cumulative-chart', [], {
            title: '因子累计收益率对比',
            xaxis: { title: '时间' },
            yaxis: { title: '累计收益率' }
        });
        
        // 添加所有因子
        Object.keys(chartData).forEach(factor => {
            addFactorToChart(factor);
        });
    }
}

// 清空图表
function clearChart() {
    Plotly.newPlot('cumulative-chart', [], {
        title: '因子累计收益率对比',
        xaxis: { title: '时间' },
        yaxis: { title: '累计收益率' }
    });
    
    // 重置所有按钮状态
    $('.chart-btn').removeClass('active').text('添加');
}
</script>
