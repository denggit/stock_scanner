<!-- 累计收益率走势图 -->
<div class="chart-container">
    <h3><i class="fas fa-chart-line"></i> 累计收益率走势图</h3>
    
    <div class="chart-controls">
        <div class="factor-selector">
            <label for="factor-selector">选择因子:</label>
            <select id="factor-selector">
                <!-- 动态填充因子选项 -->
            </select>
        </div>
        
        <div class="chart-buttons">
            <button id="show-all-btn" class="btn btn-primary">
                <i class="fas fa-eye"></i> 显示所有因子
            </button>
            <button id="clear-all-btn" class="btn btn-secondary">
                <i class="fas fa-trash"></i> 清除所有
            </button>
            <button id="log-scale-btn" class="btn btn-info">
                <i class="fas fa-chart-area"></i> 对数坐标
            </button>
        </div>
    </div>
    
    <!-- 累计收益率图表 -->
    <div id="cumulative-chart" style="height: 500px; margin: 20px 0;"></div>
    
    <!-- 因子选择按钮 -->
    <div class="factor-buttons">
        <!-- 动态生成因子按钮 -->
    </div>
    
    <!-- 图表说明 -->
    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
        <h4><i class="fas fa-info-circle"></i> 图表说明</h4>
        <ul style="margin: 10px 0; padding-left: 20px;">
            <li>点击表格中的"添加"按钮可以将因子添加到图表中</li>
            <li>再次点击"添加"按钮可以移除该因子</li>
            <li>使用"显示所有因子"可以一次性显示所有因子的走势</li>
            <li>使用"对数坐标"可以更好地观察相对变化</li>
            <li>鼠标悬停可以查看具体数值</li>
        </ul>
    </div>
</div>

<script>
let isLogScale = false;

// 初始化累计收益率图表
function initializeCumulativeChart() {
    if (!chartData || Object.keys(chartData).length === 0) {
        console.warn('chartData为空，跳过图表初始化');
        return;
    }
    
    // 初始化图表
    const layout = {
        title: '因子累计收益率对比',
        xaxis: { title: '时间' },
        yaxis: { 
            title: '累计收益率',
            tickformat: ',.0%',
            range: [0, null], // 确保Y轴从0开始
            zeroline: true,
            zerolinecolor: '#ccc'
        },
        hovermode: 'x unified',
        showlegend: true,
        legend: {
            orientation: 'h',
            y: -0.2
        }
    };
    
    Plotly.newPlot('cumulative-chart', [], layout);
    
    // 初始化因子选择器
    initializeFactorSelector();
    
    // 初始化因子按钮
    initializeFactorButtons();
    
    // 默认显示排名第一的因子
    const firstFactor = Object.keys(chartData)[0];
    if (firstFactor) {
        addFactorToChart(firstFactor);
    }
}

// 初始化因子选择器
function initializeFactorSelector() {
    const selector = $('#factor-selector');
    const factorNames = Object.keys(chartData);
    
    factorNames.forEach(factor => {
        selector.append(`<option value="${factor}">${factor}</option>`);
    });
    
    // 监听选择变化
    selector.change(function() {
        const selectedFactor = $(this).val();
        if (selectedFactor) {
            addFactorToChart(selectedFactor);
        }
    });
}

// 初始化因子按钮
function initializeFactorButtons() {
    const container = $('.factor-buttons');
    const factorNames = Object.keys(chartData);
    
    factorNames.forEach(factor => {
        const button = $(`
            <button class="chart-btn btn btn-outline-primary" data-factor="${factor}">
                <i class="fas fa-plus"></i> ${factor}
            </button>
        `);
        
        button.click(function() {
            const factorName = $(this).data('factor');
            const isActive = $(this).hasClass('active');
            
            if (isActive) {
                removeFactorFromChart(factorName);
            } else {
                addFactorToChart(factorName);
            }
        });
        
        container.append(button);
    });
}

// 添加因子到图表
function addFactorToChart(factorName) {
    if (!chartData[factorName]) return;
    
    const trace = {
        x: chartData[factorName].dates,
        y: chartData[factorName].values,
        type: 'scatter',
        mode: 'lines',
        name: factorName,
        line: { width: 2 }
    };
    
    Plotly.addTraces('cumulative-chart', trace);
    
    // 更新按钮状态
    updateChartButtonState(factorName, true);
}

// 从图表移除因子
function removeFactorFromChart(factorName) {
    const traces = document.getElementById('cumulative-chart').data;
    const traceIndex = traces.findIndex(trace => trace.name === factorName);
    
    if (traceIndex !== -1) {
        Plotly.deleteTraces('cumulative-chart', traceIndex);
    }
    
    // 更新按钮状态
    updateChartButtonState(factorName, false);
}

// 更新图表按钮状态
function updateChartButtonState(factorName, isActive) {
    const button = $(`.chart-btn[data-factor="${factorName}"]`);
    if (isActive) {
        button.addClass('active').text('移除');
    } else {
        button.removeClass('active').text('添加');
    }
}

// 显示所有因子
$('#show-all-btn').click(function() {
    const factorNames = Object.keys(chartData);
    factorNames.forEach(factor => {
        addFactorToChart(factor);
    });
});

// 清除所有因子
$('#clear-all-btn').click(function() {
    Plotly.newPlot('cumulative-chart', [], {
        title: '因子累计收益率对比',
        xaxis: { title: '时间' },
        yaxis: { 
            title: '累计收益率',
            tickformat: ',.0%'
        }
    });
    
    // 重置所有按钮状态
    $('.chart-btn').removeClass('active').text('添加');
});

// 切换对数坐标
$('#log-scale-btn').click(function() {
    isLogScale = !isLogScale;
    
    const yaxis = {
        title: '累计收益率',
        tickformat: ',.0%'
    };
    
    if (isLogScale) {
        yaxis.type = 'log';
        $(this).text('线性坐标');
    } else {
        yaxis.type = 'linear';
        $(this).text('对数坐标');
    }
    
    Plotly.relayout('cumulative-chart', { yaxis: yaxis });
});

// 页面加载完成后初始化
$(document).ready(function() {
    initializeCumulativeChart();
});
</script>
