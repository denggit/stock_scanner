<!-- 详细分析部分 -->
<div class="details-panel">
    <h3><i class="fas fa-search"></i> 因子详细分析</h3>
    
    <!-- 因子选择器 -->
    <div class="factor-selector">
        <label for="factor-selector" style="font-weight: bold; margin-bottom: 10px; display: block;">
            选择要分析的因子:
        </label>
        <select id="factor-selector" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1em;">
            <option value="">-- 请选择因子 --</option>
            {% for factor_name in factor_names %}
            <option value="{{ factor_name }}">{{ factor_name }}</option>
            {% endfor %}
        </select>
    </div>
    
    <!-- 选项卡 -->
    <div class="tabs">
        <div class="tab active" data-tab="overview">
            <i class="fas fa-chart-pie"></i> 概览
        </div>
        <div class="tab" data-tab="performance">
            <i class="fas fa-trophy"></i> 表现分析
        </div>
        <div class="tab" data-tab="group">
            <i class="fas fa-layer-group"></i> 分组回测
        </div>
        <div class="tab" data-tab="ic">
            <i class="fas fa-chart-line"></i> IC分析
        </div>
        <div class="tab" data-tab="risk">
            <i class="fas fa-shield-alt"></i> 风险分析
        </div>
    </div>
    
    <!-- 选项卡内容 -->
    <div class="tab-content active" id="overview">
        <div class="card">
            <h4><i class="fas fa-info-circle"></i> 因子概览</h4>
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value" id="metric-total-return">--</div>
                    <div class="metric-label">总收益率</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="metric-annual-return">--</div>
                    <div class="metric-label">年化收益率</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="metric-sharpe">--</div>
                    <div class="metric-label">夏普比率</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="metric-volatility">--</div>
                    <div class="metric-label">年化波动率</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="metric-max-drawdown">--</div>
                    <div class="metric-label">最大回撤</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="metric-trading-days">--</div>
                    <div class="metric-label">交易天数</div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h4><i class="fas fa-chart-bar"></i> 关键指标对比</h4>
            <div id="overview-chart" style="height: 300px;"></div>
        </div>
    </div>
    
    <div class="tab-content" id="performance">
        <div class="card">
            <h4><i class="fas fa-chart-area"></i> 收益率走势</h4>
            <div id="performance-chart" style="height: 400px;"></div>
        </div>
        
        <div class="card">
            <h4><i class="fas fa-chart-line"></i> 回撤分析</h4>
            <div id="drawdown-chart" style="height: 300px;"></div>
        </div>
        
        <div class="card">
            <h4><i class="fas fa-table"></i> 月度表现</h4>
            <div id="monthly-table" style="overflow-x: auto;">
                <table class="table" style="width: 100%;">
                    <thead>
                        <tr>
                            <th>月份</th>
                            <th>收益率</th>
                            <th>累计收益率</th>
                            <th>最大回撤</th>
                        </tr>
                    </thead>
                    <tbody id="monthly-table-body">
                        <tr><td colspan="4" style="text-align: center;">请选择因子查看详细数据</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="tab-content" id="group">
        <div class="card">
            <h4><i class="fas fa-layer-group"></i> 分组回测结果</h4>
            <div id="group-chart" style="height: 300px;"></div>
        </div>
        
        <div class="card">
            <h4><i class="fas fa-table"></i> 分组详细数据</h4>
            <div style="overflow-x: auto;">
                <table class="table" style="width: 100%;">
                    <thead>
                        <tr>
                            <th>分组</th>
                            <th>总收益率</th>
                            <th>年化收益率</th>
                            <th>夏普比率</th>
                            <th>最大回撤</th>
                            <th>波动率</th>
                        </tr>
                    </thead>
                    <tbody id="group-table">
                        <tr><td colspan="6" style="text-align: center;">请选择因子查看分组数据</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="tab-content" id="ic">
        <div class="card">
            <h4><i class="fas fa-chart-line"></i> IC时间序列</h4>
            <div id="ic-chart" style="height: 300px;"></div>
        </div>
        
        <div class="card">
            <h4><i class="fas fa-table"></i> IC统计指标</h4>
            <div style="overflow-x: auto;">
                <table class="table" style="width: 100%;">
                    <thead>
                        <tr>
                            <th>指标</th>
                            <th>值</th>
                        </tr>
                    </thead>
                    <tbody id="ic-table">
                        <tr><td colspan="2" style="text-align: center;">请选择因子查看IC数据</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="card">
            <h4><i class="fas fa-chart-bar"></i> IC分布</h4>
            <div id="ic-distribution-chart" style="height: 300px;"></div>
        </div>
    </div>
    
    <div class="tab-content" id="risk">
        <div class="card">
            <h4><i class="fas fa-shield-alt"></i> 风险指标</h4>
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value" id="metric-var">--</div>
                    <div class="metric-label">VaR (95%)</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="metric-cvar">--</div>
                    <div class="metric-label">CVaR (95%)</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="metric-beta">--</div>
                    <div class="metric-label">Beta</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="metric-alpha">--</div>
                    <div class="metric-label">Alpha</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="metric-information-ratio">--</div>
                    <div class="metric-label">信息比率</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="metric-calmar">--</div>
                    <div class="metric-label">Calmar比率</div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h4><i class="fas fa-chart-line"></i> 风险分析图表</h4>
            <div id="risk-chart" style="height: 400px;"></div>
        </div>
    </div>
</div>

<script>
// 选项卡切换功能
$(document).ready(function() {
    $('.tab').click(function() {
        const tabId = $(this).data('tab');
        
        // 更新选项卡状态
        $('.tab').removeClass('active');
        $(this).addClass('active');
        
        // 更新内容显示
        $('.tab-content').removeClass('active');
        $('#' + tabId).addClass('active');
        
        // 如果选择了因子，更新对应内容
        const selectedFactor = $('#factor-selector').val();
        if (selectedFactor) {
            updateTabContent(tabId, selectedFactor);
        }
    });
    
    // 因子选择器变化事件
    $('#factor-selector').change(function() {
        const selectedFactor = $(this).val();
        if (selectedFactor) {
            updateAllTabContent(selectedFactor);
        }
    });
});

// 更新所有选项卡内容
function updateAllTabContent(factorName) {
    const tabs = ['overview', 'performance', 'group', 'ic', 'risk'];
    tabs.forEach(tab => {
        updateTabContent(tab, factorName);
    });
}

// 更新特定选项卡内容
function updateTabContent(tabId, factorName) {
    if (!detailedData[factorName]) return;
    
    const data = detailedData[factorName];
    
    switch(tabId) {
        case 'overview':
            updateOverviewTab(data);
            break;
        case 'performance':
            updatePerformanceTab(data);
            break;
        case 'group':
            updateGroupTab(data);
            break;
        case 'ic':
            updateICTab(data);
            break;
        case 'risk':
            updateRiskTab(data);
            break;
    }
}

// 更新概览选项卡
function updateOverviewTab(data) {
    const metrics = data.metrics || {};
    
    // 更新指标卡片
    $('#metric-total-return').text(formatPercentage(metrics.total_return || 0));
    $('#metric-annual-return').text(formatPercentage(metrics.annual_return || 0));
    $('#metric-sharpe').text(formatNumber(metrics.sharpe_ratio || 0, 2));
    $('#metric-volatility').text(formatPercentage(metrics.volatility || 0));
    $('#metric-max-drawdown').text(formatPercentage(metrics.max_drawdown || 0));
    $('#metric-trading-days').text(metrics.trading_days || 0);
    
    // 更新概览图表
    updateOverviewChart(data);
}

// 更新表现选项卡
function updatePerformanceTab(data) {
    // 更新收益率走势图
    if (data.returns_series) {
        updatePerformanceChart(data.returns_series);
    }
    
    // 更新回撤图
    if (data.drawdown_series) {
        updateDrawdownChart(data.drawdown_series);
    }
    
    // 更新月度表现表格
    if (data.monthly_returns) {
        updateMonthlyTable(data.monthly_returns);
    }
}

// 更新分组选项卡
function updateGroupTab(data) {
    if (data.group_results) {
        updateGroupChart(data.group_results);
        updateGroupTable(data.group_results);
    }
}

// 更新IC选项卡
function updateICTab(data) {
    if (data.ic_series) {
        updateICChart(data.ic_series);
    }
    
    if (data.ic_stats) {
        updateICTable(data.ic_stats);
    }
    
    if (data.ic_distribution) {
        updateICDistributionChart(data.ic_distribution);
    }
}

// 更新风险选项卡
function updateRiskTab(data) {
    const riskMetrics = data.risk_metrics || {};
    
    // 更新风险指标
    $('#metric-var').text(formatPercentage(riskMetrics.var_95 || 0));
    $('#metric-cvar').text(formatPercentage(riskMetrics.cvar_95 || 0));
    $('#metric-beta').text(formatNumber(riskMetrics.beta || 0, 4));
    $('#metric-alpha').text(formatPercentage(riskMetrics.alpha || 0));
    $('#metric-information-ratio').text(formatNumber(riskMetrics.information_ratio || 0, 2));
    $('#metric-calmar').text(formatNumber(riskMetrics.calmar_ratio || 0, 2));
    
    // 更新风险分析图表
    updateRiskChart(data);
}

// 更新概览图表
function updateOverviewChart(data) {
    const metrics = data.metrics || {};
    const values = [
        metrics.total_return || 0,
        metrics.annual_return || 0,
        metrics.sharpe_ratio || 0,
        metrics.volatility || 0,
        Math.abs(metrics.max_drawdown || 0)
    ];
    
    const labels = ['总收益率', '年化收益率', '夏普比率', '波动率', '最大回撤'];
    const colors = ['#28a745', '#17a2b8', '#ffc107', '#6c757d', '#dc3545'];
    
    const trace = {
        x: labels,
        y: values,
        type: 'bar',
        marker: {
            color: colors,
            opacity: 0.7
        },
        name: '关键指标'
    };
    
    const layout = {
        title: '关键指标概览',
        xaxis: { title: '指标' },
        yaxis: { title: '数值' },
        showlegend: false
    };
    
    Plotly.newPlot('overview-chart', [trace], layout);
}

// 更新表现图表
function updatePerformanceChart(returnsSeries) {
    const dates = returnsSeries.index;
    const cumulative = (1 + returnsSeries).cumprod();
    
    const trace = {
        x: dates,
        y: cumulative,
        type: 'scatter',
        mode: 'lines',
        name: '累计收益率',
        line: { color: '#667eea', width: 2 }
    };
    
    const layout = {
        title: '累计收益率走势',
        xaxis: { title: '时间' },
        yaxis: { 
            title: '累计收益率',
            tickformat: ',.0%'
        },
        showlegend: false
    };
    
    Plotly.newPlot('performance-chart', [trace], layout);
}

// 更新回撤图表
function updateDrawdownChart(drawdownSeries) {
    const trace = {
        x: drawdownSeries.index,
        y: drawdownSeries,
        type: 'scatter',
        mode: 'lines',
        fill: 'tonexty',
        name: '回撤',
        line: { color: '#dc3545', width: 1 },
        fillcolor: 'rgba(220, 53, 69, 0.3)'
    };
    
    const layout = {
        title: '回撤分析',
        xaxis: { title: '时间' },
        yaxis: { 
            title: '回撤',
            tickformat: ',.0%'
        },
        showlegend: false
    };
    
    Plotly.newPlot('drawdown-chart', [trace], layout);
}

// 更新月度表现表格
function updateMonthlyTable(monthlyReturns) {
    const tbody = $('#monthly-table-body');
    tbody.empty();
    
    let cumulative = 1;
    monthlyReturns.forEach(month => {
        cumulative *= (1 + month.return);
        const row = `
            <tr>
                <td>${month.month}</td>
                <td class="${month.return > 0 ? 'positive' : 'negative'}">
                    ${formatPercentage(month.return)}
                </td>
                <td class="${cumulative > 1 ? 'positive' : 'negative'}">
                    ${formatPercentage(cumulative - 1)}
                </td>
                <td class="negative">
                    ${formatPercentage(month.max_drawdown)}
                </td>
            </tr>
        `;
        tbody.append(row);
    });
}

// 更新分组图表
function updateGroupChart(groupResults) {
    const groups = Object.keys(groupResults);
    const returns = groups.map(group => groupResults[group].total_return);
    
    const trace = {
        x: groups,
        y: returns,
        type: 'bar',
        marker: {
            color: returns.map(r => r > 0 ? '#28a745' : '#dc3545'),
            opacity: 0.7
        },
        name: '分组收益率'
    };
    
    const layout = {
        title: '分组回测收益率',
        xaxis: { title: '分组' },
        yaxis: { 
            title: '总收益率',
            tickformat: ',.0%'
        },
        showlegend: false
    };
    
    Plotly.newPlot('group-chart', [trace], layout);
}

// 更新分组表格
function updateGroupTable(groupResults) {
    const tbody = $('#group-table');
    tbody.empty();
    
    Object.keys(groupResults).forEach(group => {
        const result = groupResults[group];
        const row = `
            <tr>
                <td>${group}</td>
                <td class="${result.total_return > 0 ? 'positive' : 'negative'}">
                    ${formatPercentage(result.total_return)}
                </td>
                <td class="${result.annual_return > 0 ? 'positive' : 'negative'}">
                    ${formatPercentage(result.annual_return)}
                </td>
                <td class="${result.sharpe_ratio > 0 ? 'positive' : 'negative'}">
                    ${formatNumber(result.sharpe_ratio, 2)}
                </td>
                <td class="negative">
                    ${formatPercentage(result.max_drawdown)}
                </td>
                <td>${formatPercentage(result.volatility)}</td>
            </tr>
        `;
        tbody.append(row);
    });
}

// 更新IC图表
function updateICChart(icSeries) {
    const trace = {
        x: icSeries.index,
        y: icSeries,
        type: 'scatter',
        mode: 'lines+markers',
        name: 'IC时间序列',
        line: { color: '#17a2b8', width: 1 },
        marker: { size: 3 }
    };
    
    const layout = {
        title: 'IC时间序列',
        xaxis: { title: '时间' },
        yaxis: { title: 'IC值' },
        showlegend: false
    };
    
    Plotly.newPlot('ic-chart', [trace], layout);
}

// 更新IC表格
function updateICTable(icStats) {
    const tbody = $('#ic-table');
    tbody.empty();
    
    const stats = [
        { name: 'IC均值', value: icStats.mean_ic || 0 },
        { name: 'IC标准差', value: icStats.std_ic || 0 },
        { name: 'IC IR', value: icStats.ic_ir || 0 },
        { name: 'IC胜率', value: icStats.win_rate || 0 },
        { name: 'IC偏度', value: icStats.skew || 0 },
        { name: 'IC峰度', value: icStats.kurtosis || 0 }
    ];
    
    stats.forEach(stat => {
        const row = `
            <tr>
                <td>${stat.name}</td>
                <td>${typeof stat.value === 'number' ? formatNumber(stat.value, 4) : stat.value}</td>
            </tr>
        `;
        tbody.append(row);
    });
}

// 更新IC分布图表
function updateICDistributionChart(icDistribution) {
    const trace = {
        x: icDistribution.bins,
        y: icDistribution.counts,
        type: 'bar',
        name: 'IC分布',
        marker: {
            color: '#17a2b8',
            opacity: 0.7
        }
    };
    
    const layout = {
        title: 'IC分布直方图',
        xaxis: { title: 'IC值' },
        yaxis: { title: '频次' },
        showlegend: false
    };
    
    Plotly.newPlot('ic-distribution-chart', [trace], layout);
}

// 更新风险图表
function updateRiskChart(data) {
    // 这里可以添加风险分析相关的图表
    // 例如：风险收益散点图、风险指标雷达图等
    const layout = {
        title: '风险分析',
        xaxis: { title: '风险指标' },
        yaxis: { title: '数值' },
        showlegend: false
    };
    
    Plotly.newPlot('risk-chart', [], layout);
}

// 工具函数
function formatPercentage(value) {
    return (value * 100).toFixed(2) + '%';
}

function formatNumber(value, decimals = 4) {
    return value.toFixed(decimals);
}
</script>
