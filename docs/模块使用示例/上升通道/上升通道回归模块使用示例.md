# 上升通道回归模块使用示例

## 1. 基本使用

### 1.1 单点通道拟合

```python
import pandas as pd
from backend.quant.core.factor_engine.factor_library.channel_analysis.ascending_channel import AscendingChannelRegression

# 准备数据
df = pd.DataFrame({
    'trade_date': pd.date_range('2023-01-01', periods=200, freq='D'),
    'open': [10 + i*0.01 + np.random.normal(0, 0.1) for i in range(200)],
    'high': [10 + i*0.01 + np.random.normal(0, 0.2) for i in range(200)],
    'low': [10 + i*0.01 - np.random.normal(0, 0.2) for i in range(200)],
    'close': [10 + i*0.01 + np.random.normal(0, 0.1) for i in range(200)],
    'volume': [np.random.randint(1000000, 10000000) for _ in range(200)]
})

# 初始化分析器
analyzer = AscendingChannelRegression()

# 拟合通道
state = analyzer.fit_channel(df)

# 获取结果
result = state.to_dict()
print(result)
```

**返回结果字段说明：**

```python
{
    # 回归参数
    "beta": 0.0216,           # 斜率 β_t
    "sigma": 0.4717,          # 标准差 σ_t
    "r2": 0.6832,             # 回归拟合优度 R² (新增)
    
    # 通道边界（当前）
    "mid_today": 14.7545,     # 今日中轴价
    "upper_today": 15.6980,   # 今日上沿价
    "lower_today": 13.8111,   # 今日下沿价
    
    # 通道边界（明日预测）
    "mid_tomorrow": 14.7762,  # 明日预测中轴价
    "upper_tomorrow": 15.7197, # 明日预测上沿价
    "lower_tomorrow": 13.8327, # 明日预测下沿价
    
    # 通道状态
    "channel_status": "NORMAL", # 通道状态 (NORMAL/BROKEN/ACCEL_BREAKOUT/BREAKDOWN)
    
    # 锚点信息
    "anchor_date": "2023-03-31T00:00:00",  # 锚点日期
    "anchor_price": 11.5916,               # 锚点价格
    
    # 突破计数器
    "break_cnt_up": 0,        # 连续突破上沿次数
    "break_cnt_down": 0,      # 连续突破下沿次数
    
    # 重锚失败计数器
    "reanchor_fail_up": 0,    # 重锚失败（上沿）
    "reanchor_fail_down": 0,  # 重锚失败（下沿）
    
    # 其他信息
    "cumulative_gain": 0.3445, # 累计涨幅
    "last_update": "2023-07-19T00:00:00", # 最后更新时间
    "window_size": 108,       # 窗口大小 (新增)
    "days_since_anchor": 107, # 距离锚点天数 (新增)
    
    # 分析字段 (新增)
    "width_pct": 0.1229,      # 通道宽度百分比 (上沿-下沿)/中轴价
    "slope_deg": 1.4052,      # 斜率角度（度）
    "volatility": 0.0320      # 波动率 σ/中轴价
}
```

### 1.2 历史通道拟合

```python
# 计算历史通道数据
history_df = analyzer.fit_channel_history(df, min_window_size=60)

print(f"历史数据形状: {history_df.shape}")
print(f"历史数据列: {list(history_df.columns)}")
```

**历史数据新增字段：**

```python
# 新增字段说明
{
    "r2": 0.6832,             # 回归拟合优度 R²
    "break_reason": "invalid_width",  # 通道失效原因 (insufficient_data/no_valid_anchor/invalid_regression/invalid_width)
    "width_pct": 0.1229,      # 通道宽度百分比 (上沿-下沿)/中轴价
    "slope_deg": 1.4052,      # 斜率角度（度）
    "volatility": 0.0320      # 波动率 σ/中轴价
}
```

## 2. 高级使用

### 2.1 自定义参数

```python
# 自定义配置参数
analyzer = AscendingChannelRegression(
    k=2.5,                    # 通道宽度倍数
    L_max=150,                # 最大窗口长度
    delta_cut=3,              # 滑动窗口删除天数
    pivot_m=5,                # 锚点检测参数
    gain_trigger=0.25,        # 重锚涨幅触发阈值
    beta_delta=0.20,          # 斜率变化阈值
    break_days=5,             # 连续突破天数
    reanchor_fail_max=3,      # 重锚失败最大次数
    min_data_points=80,       # 最小数据点数
    R2_min=0.25,              # 最小回归拟合优度
    width_pct_min=0.05,       # 通道宽度下限
    width_pct_max=0.15        # 通道宽度上限
)
```

### 2.2 通道状态监控

```python
# 检查通道状态
if result['channel_status'] == 'NORMAL':
    print("通道正常，可以进行交易")
elif result['channel_status'] == 'BROKEN':
    print(f"通道失效，原因: {result.get('break_reason', 'unknown')}")
elif result['channel_status'] == 'ACCEL_BREAKOUT':
    print("加速突破状态")
elif result['channel_status'] == 'BREAKDOWN':
    print("跌破下沿状态")

# 检查通道质量
if result['r2'] > 0.7:
    print("通道拟合质量良好")
elif result['r2'] > 0.5:
    print("通道拟合质量一般")
else:
    print("通道拟合质量较差")

# 检查通道宽度
width_pct = result['width_pct']
if width_pct < 0.05:
    print("通道过窄，容易假突破")
elif width_pct > 0.15:
    print("通道过宽，信号不够明确")
else:
    print("通道宽度适中")
```

### 2.3 交易信号生成

```python
def generate_trading_signals(result):
    """生成交易信号"""
    signals = []
    
    if result['channel_status'] != 'NORMAL':
        return signals
    
    current_price = 15.0  # 当前价格
    mid_today = result['mid_today']
    upper_today = result['upper_today']
    lower_today = result['lower_today']
    
    # 价格位置判断
    if current_price > upper_today:
        signals.append({
            'type': 'SELL',
            'reason': '突破上沿',
            'strength': 'strong' if result['r2'] > 0.7 else 'weak'
        })
    elif current_price < lower_today:
        signals.append({
            'type': 'BUY',
            'reason': '跌破下沿',
            'strength': 'strong' if result['r2'] > 0.7 else 'weak'
        })
    elif current_price > mid_today:
        signals.append({
            'type': 'HOLD',
            'reason': '价格在中轴上方',
            'strength': 'neutral'
        })
    else:
        signals.append({
            'type': 'HOLD',
            'reason': '价格在中轴下方',
            'strength': 'neutral'
        })
    
    return signals

# 使用示例
signals = generate_trading_signals(result)
for signal in signals:
    print(f"信号: {signal['type']}, 原因: {signal['reason']}, 强度: {signal['strength']}")
```

## 3. 性能优化

### 3.1 批量计算优化

```python
# 使用步长优化批量计算
history_df = analyzer.fit_channel_history_optimized(
    df, 
    min_window_size=60, 
    step_days=5  # 每5天计算一次，提高性能
)
```

### 3.2 增量更新

```python
# 增量更新历史数据
new_data = pd.DataFrame({
    'trade_date': pd.date_range('2023-08-01', periods=10, freq='D'),
    'open': [15 + i*0.01 + np.random.normal(0, 0.1) for i in range(10)],
    'high': [15 + i*0.01 + np.random.normal(0, 0.2) for i in range(10)],
    'low': [15 + i*0.01 - np.random.normal(0, 0.2) for i in range(10)],
    'close': [15 + i*0.01 + np.random.normal(0, 0.1) for i in range(10)],
    'volume': [np.random.randint(1000000, 10000000) for _ in range(10)]
})

# 增量更新
updated_history = analyzer.update_channel_history_incremental(history_df, new_data)
```

## 4. 错误处理

```python
try:
    result = analyzer.fit_channel(df)
except Exception as e:
    print(f"通道计算失败: {e}")
    # 处理错误情况
```

## 5. 字段完整性说明

当前上升通道模块返回的结果包含以下完整字段：

### 5.1 核心字段
- `beta`: 斜率
- `sigma`: 标准差
- `r2`: 回归拟合优度 (新增)
- `mid_today/upper_today/lower_today`: 当前通道边界
- `mid_tomorrow/upper_tomorrow/lower_tomorrow`: 明日预测边界

### 5.2 状态字段
- `channel_status`: 通道状态
- `break_reason`: 失效原因 (新增)
- `break_cnt_up/break_cnt_down`: 突破计数器
- `reanchor_fail_up/reanchor_fail_down`: 重锚失败计数器

### 5.3 信息字段
- `anchor_date/anchor_price`: 锚点信息
- `cumulative_gain`: 累计涨幅
- `window_size`: 窗口大小 (新增)
- `days_since_anchor`: 距离锚点天数 (新增)

### 5.4 分析字段
- `width_pct`: 通道宽度百分比 (新增)
- `slope_deg`: 斜率角度 (新增)
- `volatility`: 波动率 (新增)

所有字段都已补齐，可以满足各种分析需求。 