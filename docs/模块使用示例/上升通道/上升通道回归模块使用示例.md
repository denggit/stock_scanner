# ä¸Šå‡é€šé“å›å½’æ¨¡å—ä½¿ç”¨ç¤ºä¾‹

## ğŸ“‹ æ¨¡å—æ¦‚è¿°

ä¸Šå‡é€šé“å›å½’æ¨¡å—æ˜¯ä¸€ä¸ªç”¨äºè‡ªåŠ¨æ£€æµ‹ã€ç»´æŠ¤å¹¶è¾“å‡ºæœ€æ–°**ä¸Šå‡å›å½’é€šé“**ä¿¡æ¯çš„é‡åŒ–åˆ†æå·¥å…·ã€‚è¯¥æ¨¡å—åŸºäºçº¿æ€§å›å½’ç®—æ³•ï¼Œèƒ½å¤Ÿè‡ªåŠ¨è¯†åˆ«è‚¡ç¥¨ä»·æ ¼çš„ä¸Šå‡è¶‹åŠ¿é€šé“ï¼Œå¹¶æä¾›å®æ—¶çš„é€šé“è¾¹ç•Œé¢„æµ‹ã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. åŸºæœ¬ä½¿ç”¨

```python
import pandas as pd
from backend.quant.core.factor_engine.factor_library.channel_analysis import AscendingChannelRegression

# åˆå§‹åŒ–åˆ†æå™¨
channel_analyzer = AscendingChannelRegression()

# å‡†å¤‡æ•°æ®ï¼ˆè‡³å°‘éœ€è¦60ä¸ªäº¤æ˜“æ—¥çš„æ•°æ®ï¼‰
df = pd.DataFrame({
    'trade_date': [...],  # æ—¥æœŸåºåˆ—
    'open': [...],        # å¼€ç›˜ä»·
    'high': [...],        # æœ€é«˜ä»·
    'low': [...],         # æœ€ä½ä»·
    'close': [...],       # æ”¶ç›˜ä»·
    'volume': [...]       # æˆäº¤é‡
})

# æ‹Ÿåˆä¸Šå‡é€šé“
state = channel_analyzer.fit_channel(df)

# è·å–é€šé“ä¿¡æ¯
channel_info = state.to_dict()
print(f"æ–œç‡: {channel_info['beta']:.4f}")
print(f"ä»Šæ—¥ä¸­è½´: {channel_info['mid_today']:.2f}")
print(f"ä»Šæ—¥ä¸Šæ²¿: {channel_info['upper_today']:.2f}")
print(f"ä»Šæ—¥ä¸‹æ²¿: {channel_info['lower_today']:.2f}")
print(f"é€šé“çŠ¶æ€: {channel_info['channel_status']}")
```

### 2. å®æ—¶æ›´æ–°

```python
# æ¯æ—¥æ›´æ–°é€šé“çŠ¶æ€
new_bar = {
    'trade_date': '2024-12-19',
    'open': 45.20,
    'high': 46.50,
    'low': 44.80,
    'close': 45.90,
    'volume': 5000000
}

# æ›´æ–°é€šé“
result = channel_analyzer.update(state, new_bar)

# æ£€æŸ¥æ›´æ–°ç»“æœ
print(f"æ›´æ–°åæ–œç‡: {result['beta']:.4f}")
print(f"æ˜æ—¥é¢„æµ‹ä¸­è½´: {result['mid_tomorrow']:.2f}")
print(f"æ˜æ—¥é¢„æµ‹ä¸Šæ²¿: {result['upper_tomorrow']:.2f}")
print(f"æ˜æ—¥é¢„æµ‹ä¸‹æ²¿: {result['lower_tomorrow']:.2f}")
```

## ğŸ“Š è¾“å‡ºæ ¼å¼

### é€šé“ä¿¡æ¯å­—å…¸

```python
{
    "beta": 0.0427,              # æœ€æ–°æ–œç‡ beta_t
    "mid_today": 34.89,          # ä»Šæ—¥ä¸­è½´ä»·
    "upper_today": 36.51,        # ä»Šæ—¥ä¸Šæ²¿ä»·
    "lower_today": 33.28,        # ä»Šæ—¥ä¸‹æ²¿ä»·
    "mid_tomorrow": 34.93,       # é¢„ä¼°ä¸‹ä¸€äº¤æ˜“æ—¥ä¸­è½´ä»·
    "upper_tomorrow": 36.55,     # é¢„ä¼°ä¸‹ä¸€äº¤æ˜“æ—¥ä¸Šæ²¿ä»·
    "lower_tomorrow": 33.31,     # é¢„ä¼°ä¸‹ä¸€äº¤æ˜“æ—¥ä¸‹æ²¿ä»·
    "channel_status": "NORMAL",  # é€šé“çŠ¶æ€
    "anchor_date": "2024-01-15T00:00:00",  # é”šç‚¹æ—¥æœŸ
    "anchor_price": 30.50,       # é”šç‚¹ä»·æ ¼
    "break_cnt_up": 0,           # è¿ç»­çªç ´ä¸Šæ²¿æ¬¡æ•°
    "break_cnt_down": 0,         # è¿ç»­çªç ´ä¸‹æ²¿æ¬¡æ•°
    "reanchor_fail_up": 0,       # é‡é”šå¤±è´¥æ¬¡æ•°ï¼ˆä¸Šæ²¿ï¼‰
    "reanchor_fail_down": 0,     # é‡é”šå¤±è´¥æ¬¡æ•°ï¼ˆä¸‹æ²¿ï¼‰
    "cumulative_gain": 0.1575,   # ç´¯è®¡æ¶¨å¹…
    "last_update": "2024-12-19T00:00:00"  # æœ€åæ›´æ–°æ—¶é—´
}
```

### é€šé“çŠ¶æ€è¯´æ˜

| çŠ¶æ€ | æè¿° | å«ä¹‰ |
|------|------|------|
| `NORMAL` | é€šé“æ­£å¸¸ | ä»·æ ¼åœ¨é€šé“å†…æ­£å¸¸æ³¢åŠ¨ |
| `ACCEL_BREAKOUT` | åŠ é€Ÿçªç ´ | è¿ç»­çªç ´ä¸Šæ²¿ï¼Œå¯èƒ½è¿›å…¥åŠ é€Ÿä¸Šæ¶¨ |
| `BREAKDOWN` | è·Œç ´ä¸‹æ²¿ | è¿ç»­è·Œç ´ä¸‹æ²¿ï¼Œè¶‹åŠ¿å¯èƒ½åè½¬ |
| `BROKEN` | é€šé“å¤±æ•ˆ | é€šé“å·²å¤±æ•ˆï¼Œéœ€è¦é‡æ–°å»ºç«‹ |

## âš™ï¸ é…ç½®å‚æ•°

### é»˜è®¤é…ç½®

```yaml
ascending_channel:
  k: 2.0                    # é€šé“å®½åº¦å€æ•° (Â±kÂ·Ïƒ)
  L_max: 120                # çª—å£æœ€é•¿å¤©æ•°
  delta_cut: 5              # æ»‘åŠ¨æ—¶ä¸€æ¬¡å‰”é™¤å¤©æ•°
  pivot_m: 3                # åˆ¤æ–­pivotçš„å®½åº¦å‚æ•°
  gain_trigger: 0.30        # ç´¯è®¡æ¶¨å¹…è§¦å‘é‡é”š
  beta_delta: 0.15          # æ–œç‡å˜åŒ–é˜ˆå€¼
  break_days: 3             # è¿ç»­çªç ´å¤©æ•°
  reanchor_fail_max: 2      # é‡é”šå¤±è´¥æœ€å¤§æ¬¡æ•°
  min_data_points: 60       # æœ€å°æ•°æ®è¦æ±‚
```

### è‡ªå®šä¹‰é…ç½®

```python
# ä½¿ç”¨è‡ªå®šä¹‰é…ç½®æ–‡ä»¶
channel_analyzer = AscendingChannelRegression(
    config_path="path/to/custom_config.yaml"
)

# æˆ–è€…ä¿®æ”¹é»˜è®¤å‚æ•°
channel_analyzer.k = 2.5  # è°ƒæ•´é€šé“å®½åº¦
channel_analyzer.gain_trigger = 0.25  # è°ƒæ•´é‡é”šè§¦å‘æ¡ä»¶
```

## ğŸ”§ é«˜çº§åŠŸèƒ½

### 1. å¼ºåˆ¶é‡é”š

```python
# åœ¨ç‰¹æ®Šæƒ…å†µä¸‹å¼ºåˆ¶é‡é”š
channel_analyzer.force_reanchor(state)
```

### 2. é”šç‚¹æ£€æµ‹

```python
from backend.quant.core.factor_engine.factor_library.channel_analysis import PivotDetector

# åˆå§‹åŒ–é”šç‚¹æ£€æµ‹å™¨
detector = PivotDetector(pivot_m=3)

# æ£€æµ‹pivot low
pivot_low = detector.find_pivot_low(df)
if pivot_low:
    date, price = pivot_low
    print(f"æ‰¾åˆ°pivot low: {date} @ {price:.2f}")

# æ£€æµ‹pivot high
pivot_high = detector.find_pivot_high(df)
if pivot_high:
    date, price = pivot_high
    print(f"æ‰¾åˆ°pivot high: {date} @ {price:.2f}")
```

### 3. é”šç‚¹éªŒè¯

```python
# éªŒè¯é”šç‚¹çš„æœ‰æ•ˆæ€§
is_valid = detector.validate_anchor(df, anchor_date, anchor_price, min_gain=0.05)
if is_valid:
    print("é”šç‚¹éªŒè¯é€šè¿‡")
else:
    print("é”šç‚¹éªŒè¯å¤±è´¥")
```

## ğŸ“ˆ å®é™…åº”ç”¨åœºæ™¯

### 1. ç­–ç•¥æ‰«æ

```python
# åœ¨ç­–ç•¥æ‰«æä¸­ä½¿ç”¨
def scan_ascending_channels(stock_list):
    results = []
    
    for stock_code in stock_list:
        # è·å–è‚¡ç¥¨æ•°æ®
        df = get_stock_data(stock_code, days=252)
        
        try:
            # åˆ†æä¸Šå‡é€šé“
            state = channel_analyzer.fit_channel(df)
            channel_info = state.to_dict()
            
            # ç­›é€‰ç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨
            if (channel_info['channel_status'] == 'NORMAL' and 
                channel_info['beta'] > 0.02 and  # æ–œç‡å¤§äº2%
                channel_info['cumulative_gain'] > 0.1):  # ç´¯è®¡æ¶¨å¹…å¤§äº10%
                
                results.append({
                    'code': stock_code,
                    'beta': channel_info['beta'],
                    'gain': channel_info['cumulative_gain'],
                    'status': channel_info['channel_status']
                })
                
        except Exception as e:
            print(f"åˆ†æè‚¡ç¥¨ {stock_code} å¤±è´¥: {e}")
    
    return results
```

### 2. å›æµ‹ç³»ç»Ÿ

```python
# åœ¨å›æµ‹ç³»ç»Ÿä¸­ä½¿ç”¨
def backtest_ascending_channel_strategy(df):
    # åˆå§‹åŒ–é€šé“åˆ†æå™¨
    analyzer = AscendingChannelRegression()
    
    # æ‹Ÿåˆåˆå§‹é€šé“
    state = analyzer.fit_channel(df.iloc[:100])  # ä½¿ç”¨å‰100å¤©æ•°æ®
    
    signals = []
    
    # é€æ—¥æ›´æ–°
    for i in range(100, len(df)):
        bar = df.iloc[i].to_dict()
        result = analyzer.update(state, bar)
        
        # ç”Ÿæˆäº¤æ˜“ä¿¡å·
        if result['channel_status'] == 'ACCEL_BREAKOUT':
            signals.append(('BUY', bar['trade_date'], bar['close']))
        elif result['channel_status'] == 'BREAKDOWN':
            signals.append(('SELL', bar['trade_date'], bar['close']))
    
    return signals
```

### 3. å®æ—¶ç›‘æ§

```python
# å®æ—¶ç›‘æ§è‚¡ç¥¨é€šé“çŠ¶æ€
def monitor_channel_status(stock_code):
    analyzer = AscendingChannelRegression()
    
    # è·å–å†å²æ•°æ®
    df = get_stock_data(stock_code, days=252)
    state = analyzer.fit_channel(df)
    
    # å®æ—¶æ›´æ–°
    while True:
        # è·å–æœ€æ–°æ•°æ®
        latest_bar = get_latest_bar(stock_code)
        
        # æ›´æ–°é€šé“
        result = analyzer.update(state, latest_bar)
        
        # æ£€æŸ¥çŠ¶æ€å˜åŒ–
        if result['channel_status'] != 'NORMAL':
            send_alert(f"è‚¡ç¥¨ {stock_code} é€šé“çŠ¶æ€å˜åŒ–: {result['channel_status']}")
        
        time.sleep(60)  # æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ•°æ®è¦æ±‚**: è‡³å°‘éœ€è¦60ä¸ªäº¤æ˜“æ—¥çš„æ•°æ®
2. **æ•°æ®è´¨é‡**: ç¡®ä¿æ•°æ®æŒ‰æ—¶é—´æ’åºï¼Œæ— ç¼ºå¤±å€¼
3. **å‚æ•°è°ƒä¼˜**: æ ¹æ®å…·ä½“è‚¡ç¥¨ç‰¹æ€§è°ƒæ•´é…ç½®å‚æ•°
4. **çŠ¶æ€ç›‘æ§**: åŠæ—¶å…³æ³¨é€šé“çŠ¶æ€å˜åŒ–
5. **å¼‚å¸¸å¤„ç†**: å¦¥å–„å¤„ç†æ•°æ®ä¸è¶³ç­‰å¼‚å¸¸æƒ…å†µ

## ğŸ› å¸¸è§é—®é¢˜

### Q: ä¸ºä»€ä¹ˆæ‰¾ä¸åˆ°æœ‰æ•ˆçš„é”šç‚¹ï¼Ÿ
A: æ£€æŸ¥æ•°æ®æ˜¯å¦è¶³å¤Ÿï¼ˆè‡³å°‘60ä¸ªäº¤æ˜“æ—¥ï¼‰ï¼Œä»¥åŠæ˜¯å¦åŒ…å«æ˜æ˜¾çš„ä¸Šå‡è¶‹åŠ¿ã€‚

### Q: é€šé“çŠ¶æ€ä¸€ç›´æ˜¾ç¤ºBROKENï¼Ÿ
A: å¯èƒ½æ˜¯è‚¡ç¥¨å¤„äºä¸‹è·Œè¶‹åŠ¿ï¼Œæˆ–è€…å‚æ•°è®¾ç½®è¿‡äºä¸¥æ ¼ï¼Œå¯ä»¥è°ƒæ•´ `break_days` å’Œ `reanchor_fail_max` å‚æ•°ã€‚

### Q: å¦‚ä½•æé«˜æ£€æµ‹ç²¾åº¦ï¼Ÿ
A: å¯ä»¥è°ƒæ•´ `pivot_m` å‚æ•°æ¥æ”¹å˜é”šç‚¹æ£€æµ‹çš„æ•æ„Ÿåº¦ï¼Œæˆ–è€…è°ƒæ•´ `k` å‚æ•°æ¥æ”¹å˜é€šé“å®½åº¦ã€‚

---

**æœ€åæ›´æ–°**: 2024å¹´12æœˆ19æ—¥
**ç‰ˆæœ¬**: v1.0 

# ã€v0.2è¡¥å……ã€‘æœ¬æ¨¡å—ä¸¥æ ¼åªåšâ€œä¸Šå‡é€šé“â€
- æ‰€æœ‰é”šç‚¹åªç”¨pivot_lowï¼Œä¸å†åšä»»ä½•è¶‹åŠ¿åˆ†æµã€‚
- fit_channel/fit_channel_historyç­‰æ–¹æ³•åªä¼šè¾“å‡ºâ€œä¸Šå‡é€šé“â€æˆ–BROKENã€‚
- ä¸å†æ ¹æ®30å¤©æ–œç‡/æ¶¨å¹…åˆ¤æ–­è¶‹åŠ¿ï¼Œä¹Ÿä¸ä¼šç”¨pivot_highã€‚

## ã€v0.2è¡¥å……ã€‘æ ¸å¿ƒå‚æ•°è¡¨

| å‚æ•°å           | é»˜è®¤å€¼ | è¯´æ˜                                                         |
|------------------|--------|--------------------------------------------------------------|
| k                | 2.0    | é€šé“å®½åº¦å€æ•° (Â±kÂ·Ïƒ)                                          |
| L_max            | 120    | æœ€å¤§çª—å£é•¿åº¦ï¼ˆåªåœ¨æœ€åL_maxå¤©å†…æ‰¾pivot_lowï¼‰                 |
| delta_cut        | 5      | æ»‘åŠ¨çª—å£å‰”é™¤å¤©æ•°                                             |
| pivot_m          | 3      | pivot_lowæ£€æµ‹çµæ•åº¦                                          |
| gain_trigger     | 0.30   | ç´¯è®¡æ¶¨å¹…è§¦å‘é‡é”š                                             |
| beta_delta       | 0.15   | æ–œç‡å˜åŒ–é˜ˆå€¼                                                 |
| break_days       | 3      | è¿ç»­çªç ´ä¸Šä¸‹æ²¿å¤©æ•°                                           |
| reanchor_fail_max| 2      | è¿ç»­é‡é”šå¤±è´¥æœ€å¤§æ¬¡æ•°                                         |
| min_data_points  | 60     | æœ€å°æœ‰æ•ˆæ•°æ®ç‚¹                                               |
| R2_min           | 0.20   | æœ€å°å›å½’æ‹Ÿåˆä¼˜åº¦ï¼Œä½äºæ­¤è§†ä¸ºæ— æ•ˆé€šé“                         |
| width_pct_min    | 0.04   | é€šé“å®½åº¦ä¸‹é™ï¼Œè¿‡çª„è§†ä¸ºæ— æ•ˆ                                   |
| width_pct_max    | 0.12   | é€šé“å®½åº¦ä¸Šé™ï¼Œè¿‡å®½è§†ä¸ºæ— æ•ˆ                                   |

## ã€v0.2è¡¥å……ã€‘fit_channelåˆ¤å®šé€»è¾‘

1. åªåœ¨æœ€åL_maxå¤©å†…æ‰¾æ‰€æœ‰pivot_lowã€‚
2. é€‰æœ€é å‰ä¸”è·ä»Šæ—¥â‰¥min_data_pointsçš„æœ€ä½pivot_lowä¸ºé”šç‚¹ã€‚
3. ä»é”šç‚¹åˆ°æœ€æ–°åšçº¿æ€§å›å½’ï¼Œå¾—åˆ°betaã€sigmaã€r2ã€‚
4. è‹¥betaâ‰¤0æˆ–r2<R2_minï¼Œç›´æ¥BROKENã€‚
5. è®¡ç®—é€šé“ä¸Šä¸‹æ²¿ï¼Œè‹¥(upper_today-lower_today)/mid_todayä¸åœ¨[width_pct_min, width_pct_max]ï¼Œä¹Ÿç›´æ¥BROKENã€‚
6. åªæœ‰å…¨éƒ¨é€šè¿‡æ‰è¾“å‡ºNORMALã€‚

## ã€v0.2è¡¥å……ã€‘FAQ

- Q: ä¸ºä»€ä¹ˆæœ‰æ—¶é€šé“ç›´æ¥BROKENï¼Ÿ
  A: åªè¦betaâ‰¤0ï¼ˆä¸æ˜¯ä¸Šå‡é€šé“ï¼‰æˆ–å›å½’RÂ²å¤ªä½ï¼ˆè¶‹åŠ¿ä¸å¯é ï¼‰ï¼Œæˆ–é€šé“å®½åº¦è¿‡çª„/è¿‡å®½ï¼Œéƒ½ä¼šç›´æ¥BROKENã€‚
- Q: è¿˜èƒ½åšä¸‹é™é€šé“å—ï¼Ÿ
  A: ä¸èƒ½ï¼Œæœ¬æ¨¡å—åªåšä¸Šå‡é€šé“ã€‚
- Q: fit_channel_historyä¹Ÿæ˜¯ä¸€æ ·çš„è§„åˆ™å—ï¼Ÿ
  A: æ˜¯çš„ï¼Œå†å²æ‰¹é‡è®¡ç®—ä¸¥æ ¼ç”¨åŒæ ·çš„pivot_low+è¿‡æ»¤é€»è¾‘ã€‚

## ã€v0.2è¡¥å……ã€‘é…ç½®æ–‡ä»¶ç¤ºä¾‹

```yaml
ascending_channel:
  k: 2.0
  L_max: 120
  delta_cut: 5
  pivot_m: 3
  gain_trigger: 0.30
  beta_delta: 0.15
  break_days: 3
  reanchor_fail_max: 2
  min_data_points: 60
  R2_min: 0.20
  width_pct_min: 0.04
  width_pct_max: 0.12
```

---

# å…¶ä½™åŸæœ‰å†…å®¹ä¿ç•™ï¼Œä¾›API/ç”¨æ³•å‚è€ƒã€‚ 