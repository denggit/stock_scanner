# 上升通道回测策略使用指南

## 概述

上升通道回测策略是一个基于上升通道回归分析的月度调仓策略，专门为A股市场设计。该策略通过识别处于有效上升通道的股票，进行定期调仓和资金管理。

## 策略特点

### 核心逻辑
1. **月度调仓**：每月最后一天扫描所有股票，找出通道状态为NORMAL的股票
2. **平均分配**：符合条件的股票平均分配资金
3. **通道筛选**：只买入通道状态为NORMAL的股票
4. **A股规则**：严格遵守A股交易规则

### 技术特点
- 基于上升通道回归分析
- 支持多股票组合管理
- 完整的交易记录和性能分析
- 灵活的参数配置

## 参数配置

### 基本策略参数

| 参数名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `max_positions` | int | 10 | 最大持仓数量 |
| `min_channel_score` | float | 60.0 | 最小通道评分 |

### 上升通道计算参数

| 参数名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `k` | float | 2.0 | 通道斜率参数 |
| `L_max` | int | 120 | 最大通道长度 |
| `delta_cut` | int | 5 | 通道宽度参数 |
| `pivot_m` | int | 3 | 枢轴点参数 |
| `gain_trigger` | float | 0.30 | 收益触发阈值 |
| `beta_delta` | float | 0.15 | Beta变化阈值 |
| `break_days` | int | 3 | 突破确认天数 |
| `reanchor_fail_max` | int | 2 | 重新锚定最大失败次数 |
| `min_data_points` | int | 60 | 最小数据点数 |
| `R2_min` | float/None | 0.20 | 最小R²值（通道有效性下限） |
| `R2_max` | float/None | None | 最大R²值上限（选股过滤用） |
| `R2_range` | list[float/None, float/None] | None | R²过滤区间 `[min, max]`（优先于单独的 R2_min/R2_max） |
| `width_pct_min` | float | 0.04 | 最小通道宽度百分比 |
| `width_pct_max` | float | 0.15 | 最大通道宽度百分比 |

### 环境参数 vs 参数优化参数（重要）

在使用 `environment=optimization` 时，系统会先加载 `ENVIRONMENTS['optimization']` 作为“基线”。

但当运行“参数优化”流程时：
- 股票抽样使用 `OPTIMIZATION_CONFIG['max_stocks_for_optimization']`（而不是 `ENVIRONMENTS['optimization']['max_stocks']`）。
- 参与穷举的策略参数来自 `OPTIMIZATION_RANGES`；未列入网格的键不会自动继承环境值，会回退到策略类默认值（如 `max_positions` 默认 50）。

建议：
- 希望“优化”与“开发/生产”样本一致：把 `OPTIMIZATION_CONFIG['max_stocks_for_optimization']` 设成与环境一致。
- 希望“优化”沿用环境的关键参数：将其写入 `OPTIMIZATION_RANGES`（哪怕是单值，如 `max_positions: [20]`），或在优化循环中合并“基线参数 + 网格参数”。

## 使用方法

### 1. 基本使用

```python
from backend.business.backtest.strategies.implementations.channel.rising_channel import (
   RisingChannelBacktestStrategy,
   create_rising_channel_backtest_strategy
)

# 方法1：直接创建策略实例
strategy = RisingChannelBacktestStrategy(
   max_positions=5,
   min_channel_score=65.0,
   k=2.0,
   L_max=120
)

# 方法2：使用便捷函数
strategy = create_rising_channel_backtest_strategy(
   max_positions=5,
   min_channel_score=65.0,
   k=2.0,
   L_max=120
)
```

### 2. 参数优化示例

```python
# 保守策略
conservative_strategy = create_rising_channel_backtest_strategy(
    max_positions=3,
    min_channel_score=80.0,
    k=2.5,
    L_max=100
)

# 平衡策略
balanced_strategy = create_rising_channel_backtest_strategy(
    max_positions=5,
    min_channel_score=65.0,
    k=2.0,
    L_max=120
)

# 激进策略
aggressive_strategy = create_rising_channel_backtest_strategy(
    max_positions=8,
    min_channel_score=50.0,
    k=1.8,
    L_max=150
)
```

### 3. 获取策略信息

```python
# 获取策略基本信息
info = strategy.get_strategy_info()
print(f"策略名称: {info['strategy_name']}")
print(f"最大持仓数量: {info['parameters']['max_positions']}")
print(f"最小通道评分: {info['parameters']['min_channel_score']}")
```

### 4. 执行调仓

```python
from datetime import datetime

# 执行调仓
current_date = datetime.now().date()
strategy._perform_rebalance(current_date)

# 获取调仓记录
record = strategy.rebalance_records[-1]
print(f"候选股票数量: {record['candidate_count']}")
print(f"实际持仓数量: {record['position_count']}")
print(f"总资产价值: {record['total_value']:.2f}")
```

### 5. 性能分析

```python
# 获取性能摘要
summary = strategy.get_performance_summary()
print(f"总调仓次数: {summary['total_rebalances']}")
print(f"总交易次数: {summary['total_trades']}")
print(f"当前持仓数量: {summary['current_positions']}")
print(f"当前总资产: {summary['portfolio_value']:.2f}")
```

## 策略配置建议

### 不同风险偏好的配置

#### 保守型配置
- `max_positions`: 3-5
- `min_channel_score`: 75.0-80.0
- `k`: 2.5-3.0
- `L_max`: 100-120

#### 平衡型配置
- `max_positions`: 5-8
- `min_channel_score`: 60.0-70.0
- `k`: 2.0-2.5
- `L_max`: 120-150

#### 激进型配置
- `max_positions`: 8-12
- `min_channel_score`: 50.0-60.0
- `k`: 1.8-2.0
- `L_max`: 150-180

### 市场环境适配

#### 牛市环境
- 降低 `min_channel_score` 到 50.0-60.0
- 增加 `max_positions` 到 8-12
- 适当降低 `k` 值到 1.8-2.0

#### 熊市环境
- 提高 `min_channel_score` 到 75.0-80.0
- 减少 `max_positions` 到 3-5
- 适当提高 `k` 值到 2.5-3.0

## 交易规则说明

### A股交易规则集成

策略自动遵守以下A股交易规则：

1. **交易数量**：自动调整为100的整数倍
2. **交易费用**：
   - 佣金：万分之三（最低5元）
   - 印花税：千分之一（仅卖出时）
   - 过户费：十万分之二
3. **涨跌停**：自动检查价格是否触及涨跌停

### 示例

```python
from backend.business.backtest.core.trading_rules import ASHARE_RULES

# 数量调整
original_quantity = 1234
adjusted_quantity = ASHARE_RULES.adjust_trade_quantity(original_quantity)
print(f"调整后数量: {adjusted_quantity}")  # 输出: 1200

# 费用计算
trade_amount = 10000.0
buy_fees = ASHARE_RULES.calculate_total_fees(trade_amount, is_buy=True)
sell_fees = ASHARE_RULES.calculate_total_fees(trade_amount, is_buy=False)
print(f"买入费用: {buy_fees:.2f}")   # 输出: 5.20
print(f"卖出费用: {sell_fees:.2f}")  # 输出: 15.20
```

## 性能监控

### 关键指标

1. **调仓频率**：每月一次
2. **持仓集中度**：通过 `max_positions` 控制
3. **通道质量**：通过 `min_channel_score` 控制
4. **交易成本**：自动计算并记录

### 风险控制

1. **止损机制**：可设置-10%止损
2. **分散投资**：最多持有指定数量的股票
3. **质量筛选**：只买入高质量通道股票

## 注意事项

### 使用限制

1. **数据要求**：需要足够的历史数据（至少60个交易日）
2. **计算复杂度**：通道分析计算量较大
3. **实时性**：建议在收盘后执行调仓

### 最佳实践

1. **参数调优**：根据市场环境调整参数
2. **定期评估**：每月评估策略表现
3. **风险控制**：设置合理的止损和仓位限制
4. **成本控制**：注意交易费用的影响

## 故障排除

### 常见问题

1. **候选股票为空**
   - 检查 `min_channel_score` 设置是否过高
   - 确认市场环境是否适合策略

2. **调仓频率异常**
   - 检查日期格式是否正确
   - 确认调仓逻辑是否正常

3. **性能异常**
   - 检查参数设置是否合理
   - 分析市场环境变化

### 调试建议

1. 启用详细日志记录
2. 定期检查策略状态
3. 对比不同参数组合的效果
4. 监控交易成本和收益

## 更新日志

### v1.0.0 (2024-01-31)
- 初始版本发布
- 支持基本调仓功能
- 集成A股交易规则
- 提供完整的性能分析

### 计划功能
- 支持更多技术指标
- 增加风险控制模块
- 优化计算性能
- 提供可视化界面 