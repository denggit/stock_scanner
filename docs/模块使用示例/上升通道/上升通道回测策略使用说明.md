# 上升通道回测策略使用说明

## 概述

上升通道回测策略是基于 `ascending_channel.py` 中的上升通道回归分析算法实现的多股票组合量化交易策略。该策略通过实时分析股票价格的上升通道状态，基于通道状态和评分进行多股票组合管理。

## 策略特点

### 核心算法
- **真实上升通道分析**：使用 `AscendingChannelRegression` 进行实时通道分析
- **多股票组合管理**：同时管理多只股票，目标持仓50只股票
- **动态选股机制**：按距离下沿百分比排序选股
- **智能调仓**：非NORMAL状态立即卖出，动态补充持仓

### 交易逻辑
- **选股条件**：
  - 通道状态为 NORMAL
  - 通道评分达到要求（默认60.0）
  - 按股价距离下沿的百分比距离排序（从小到大）
- **买入策略**：
  - 平均买入前50只股票至满仓
  - 平均分配资金给每只股票
- **卖出策略**：
  - 通道状态非NORMAL时立即卖出
  - 动态调仓，保持50只股票持仓

## 参数配置

### 基本参数
```python
strategy_params = {
    'max_positions': 50,           # 最大持仓数量（50只股票）
    'min_channel_score': 60.0,     # 最小通道评分
}
```

### 通道分析参数
```python
channel_params = {
    'k': 2.0,                      # 通道斜率
    'L_max': 120,                  # 最大通道长度
    'delta_cut': 5,                # 数据截断参数
    'pivot_m': 3,                  # 枢轴参数
    'gain_trigger': 0.30,          # 收益触发阈值
    'beta_delta': 0.15,            # Beta变化阈值
    'break_days': 3,               # 突破天数
    'reanchor_fail_max': 2,        # 重锚失败最大次数
    'min_data_points': 60,         # 最小数据点数
    'R2_min': 0.20,                # 最小R²值（通道有效性判定）
    'R2_max': None,                # 选股过滤的 R² 上限（None 表示不限制）
    'R2_range': None,              # 选股过滤的 R² 区间 [min, max]，两端可为 None；若提供则优先
    'width_pct_min': 0.04,         # 最小通道宽度
    'width_pct_max': 0.15          # 最大通道宽度
}
```

## 策略执行流程

### 1. 初始化阶段
- 设置策略参数和通道分析器
- 初始化持仓管理数据结构

### 2. 每日执行流程
```python
def next(self):
    # 1. 记录当前数据
    self._record_current_data(current_date)
    
    # 2. 更新所有股票的通道状态
    self._update_all_channel_states(current_date)
    
    # 3. 检查持仓股票状态，卖出非NORMAL状态的股票
    self._check_and_sell_positions(current_date)
    
    # 4. 如果持仓不足50只，重新选股并买入
    if len(self.current_positions) < self.max_positions:
        self._select_and_buy_stocks(current_date)
```

### 3. 选股逻辑
```python
def _select_and_buy_stocks(self, current_date):
    # 1. 筛选NORMAL状态的股票
    normal_stocks = []
    for stock_code, analysis in all_stocks_analysis.items():
        if (channel_state.channel_status.value == 'NORMAL' and
            channel_score >= self.min_channel_score):
            
            # 计算距离下沿的百分比
            distance_to_lower = (current_price - lower_today) / lower_today * 100
            normal_stocks.append({
                'stock_code': stock_code,
                'distance_to_lower': distance_to_lower,
                'channel_score': channel_score,
                'current_price': current_price
            })
    
    # 2. 按距离下沿百分比排序（从小到大）
    normal_stocks.sort(key=lambda x: x['distance_to_lower'])
    
    # 3. 买入前N只股票
    need_to_buy = min(self.max_positions - current_position_count, len(normal_stocks))
    for i in range(need_to_buy):
        self._buy_stock(stock_code, current_price, current_date)
```

### 4. 卖出逻辑
```python
def _check_and_sell_positions(self, current_date):
    for stock_code, position in self.current_positions.items():
        channel_state = self.channel_states.get(stock_code)
        
        # 如果不是NORMAL状态，卖出
        if channel_state.channel_status.value != 'NORMAL':
            self._sell_stock(stock_code, current_date)
```

## 通道评分计算

### 评分组成
```python
def _calculate_channel_score(self) -> float:
    score = 0.0
    
    # 基础分数：通道状态
    if channel_status == 'NORMAL':
        score += 40.0
    elif channel_status == 'BROKEN':
        score += 20.0
    elif channel_status == 'ACCEL_BREAKOUT':
        score += 30.0
    elif channel_status == 'BREAKDOWN':
        score += 10.0
    
    # R²分数：回归质量
    r2_score = min(r2 * 100, 30.0)
    score += r2_score
    
    # 斜率分数：上升趋势强度
    beta_score = min(beta * 100, 20.0)
    score += beta_score
    
    # 累积收益分数
    gain_score = min(cumulative_gain * 100, 10.0)
    score += gain_score
    
    return min(score, 100.0)
```

## 使用示例

### 基础回测
```python
from backend.business.backtest.execution.rising_channel_backtest import RisingChannelBacktestRunner

# 创建回测运行器
runner = RisingChannelBacktestRunner()

# 运行基础回测
results = runner.run_basic_backtest()
```

### 参数优化
```python
# 运行参数优化
optimization_results = runner.run_parameter_optimization()
```

### 对比回测
```python
# 运行对比回测
comparison_results = runner.run_comparison_backtest()
```

## 策略优势

### 1. 多股票分散风险
- 同时持有50只股票，有效分散个股风险
- 避免单只股票大幅波动对组合的影响

### 2. 动态选股机制
- 基于实时通道状态选股
- 按距离下沿百分比排序，优先选择相对安全的股票

### 3. 快速止损
- 通道状态变化立即卖出
- 避免通道失效带来的持续亏损

### 4. 平均分配资金
- 每只股票平均分配资金
- 避免重仓单只股票的风险

## 注意事项

### 1. 数据要求
- 需要足够的历史数据（至少60个交易日）
- 数据质量影响通道分析的准确性

### 2. 参数调优
- 通道评分阈值影响选股数量
- 持仓数量影响风险分散效果

### 3. 交易成本
- 频繁调仓可能产生较高交易成本
- 需要平衡调仓频率和策略效果

### 4. 市场环境
- 策略在上升趋势市场中表现更好
- 震荡市场中可能产生较多无效交易

## 回测结果分析

### 关键指标
- **总收益率**：策略整体收益表现
- **年化收益率**：年化后的收益率
- **最大回撤**：最大亏损幅度
- **夏普比率**：风险调整后收益
- **胜率**：盈利交易占比
- **平均持仓数量**：实际持仓股票数量

### 交易统计
- **总交易次数**：买入和卖出总次数
- **平均持仓时间**：单只股票平均持仓天数
- **换手率**：组合换手频率

## 策略调优建议

### 1. 参数优化
- 使用参数优化功能找到最优参数组合
- 重点关注通道评分阈值和持仓数量

### 2. 市场适应性
- 根据市场环境调整策略参数
- 牛市可适当降低评分要求，熊市提高评分要求

### 3. 风险控制
- 设置最大回撤限制
- 考虑加入止损机制

### 4. 交易成本控制
- 设置最小调仓间隔
- 考虑交易成本对收益的影响 