# åŽ†å²é€šé“æ•°æ®è®¡ç®—ç¤ºä¾‹

## ðŸ“‹ æ¦‚è¿°

åŽ†å²é€šé“æ•°æ®è®¡ç®—åŠŸèƒ½å¯ä»¥è®¡ç®—è‚¡ç¥¨åœ¨æ¯ä¸ªåŽ†å²æ—¶ç‚¹çš„ä¸Šå‡é€šé“çŠ¶æ€ï¼Œä¸ºå›žæµ‹åˆ†æžã€ç­–ç•¥ç ”ç©¶æä¾›å®Œæ•´çš„æ—¶é—´åºåˆ—æ•°æ®ã€‚

**æ ¸å¿ƒç‰¹ç‚¹ï¼š**

- âœ… **çŠ¶æ€è¿žç»­æ€§**ï¼šæ¯ä¸ªæ—¶ç‚¹åŸºäºŽå‰ä¸€æ—¶ç‚¹çŠ¶æ€æ›´æ–°ï¼Œä¿æŒé€šé“è¿žç»­æ€§
- âœ… **é‡é”šæœºåˆ¶**ï¼šæ”¯æŒåŠ¨æ€é‡é”šï¼Œé€‚åº”å¸‚åœºå˜åŒ–
- âœ… **å¢žé‡æ›´æ–°**ï¼šæ”¯æŒåŸºäºŽåŽ†å²ç»“æžœæ·»åŠ æ–°æ•°æ®ï¼Œé¿å…é‡æ–°è®¡ç®—
- âœ… **é«˜æ•ˆè®¡ç®—**ï¼šæ”¯æŒæ­¥é•¿è®¡ç®—ï¼Œæé«˜å¤§æ•°æ®é‡å¤„ç†æ•ˆçŽ‡
- âœ… **å‹å¥½è¾“å‡º**ï¼šå‡å°‘ä¸å¿…è¦çš„é”™è¯¯æ—¥å¿—ï¼Œä¸ºæ•°æ®ä¸è¶³æ—¶ç‚¹ä¿ç•™è®°å½•ï¼ˆé€šé“æ•°æ®å¡«Noneï¼‰
- âœ… **å®Œæ•´è¦†ç›–**ï¼šæ‰€æœ‰æ—¶ç‚¹éƒ½æœ‰è®°å½•ï¼Œä¾¿äºŽæ—¶é—´åºåˆ—åˆ†æž

## ðŸš€ å¿«é€Ÿå¼€å§‹

### åŸºæœ¬ä½¿ç”¨

```python
import datetime
from backend.data.data_fetcher import StockDataFetcher
from backend.utils.indicators import CalIndicators

# èŽ·å–è‚¡ç¥¨æ•°æ®
fetcher = StockDataFetcher()
df = fetcher.fetch_stock_data('sh.600900',
                              start_date=(datetime.date.today() - datetime.timedelta(days=1000)).strftime("%Y-%m-%d"))
df = df[['trade_date', 'open', 'high', 'low', 'close', 'volume']].copy()

# è®¡ç®—åŽ†å²é€šé“æ•°æ®ï¼ˆé€æ—¥è®¡ç®—ï¼‰
history_df = CalIndicators.ascending_channel_history(df, min_window_size=60)

# æŸ¥çœ‹ç»“æžœ
print(f"åŽ†å²é€šé“æ•°æ®è®¡ç®—å®Œæˆï¼Œå…±{len(history_df)}æ¡è®°å½•")
print(history_df[['trade_date', 'close', 'beta', 'mid_today', 'upper_today', 'lower_today', 'channel_status']].tail(10))
print(history_df[['trade_date', 'beta', 'channel_status', 'anchor_date', 'window_size']])
```

### ä¼˜åŒ–ç‰ˆæœ¬ï¼ˆæŒ‰æ­¥é•¿è®¡ç®—ï¼‰

```python
# æŒ‰5å¤©æ­¥é•¿è®¡ç®—ï¼Œæé«˜æ•ˆçŽ‡
history_df = CalIndicators.ascending_channel_history_optimized(
    df,
    min_window_size=60,
    step_days=5
)

# æŸ¥çœ‹ç»“æžœ
print(f"ä¼˜åŒ–åŽ†å²é€šé“æ•°æ®è®¡ç®—å®Œæˆï¼Œå…±{len(history_df)}æ¡è®°å½•")
print(history_df[['trade_date', 'close', 'beta', 'mid_today', 'channel_status']].head())
```

## ðŸ”„ å¢žé‡æ›´æ–°åŠŸèƒ½

### ä¸ºä»€ä¹ˆéœ€è¦å¢žé‡æ›´æ–°ï¼Ÿ

å½“æ‚¨æœ‰æ–°çš„äº¤æ˜“æ—¥æ•°æ®æ—¶ï¼Œä¸éœ€è¦é‡æ–°è®¡ç®—æ•´ä¸ªåŽ†å²é€šé“ï¼Œå¯ä»¥ä½¿ç”¨å¢žé‡æ›´æ–°åŠŸèƒ½ï¼š

```python
# å‡è®¾æ‚¨å·²ç»æœ‰äº†åŽ†å²é€šé“æ•°æ®
history_df = CalIndicators.ascending_channel_history(df, min_window_size=60)

# èŽ·å–æ–°çš„ä¸€å¤©æ•°æ®
new_data = pd.DataFrame({
    'trade_date': ['2025-07-19'],
    'open': [38.80],
    'high': [39.20],
    'low': [38.50],
    'close': [38.95],
    'volume': [1000000]
})

# å¢žé‡æ›´æ–°ï¼ˆåŸºäºŽDataFrameï¼‰
updated_df = CalIndicators.ascending_channel_history_incremental(history_df, new_data)

print(f"æ›´æ–°å‰: {len(history_df)}æ¡è®°å½•")
print(f"æ›´æ–°åŽ: {len(updated_df)}æ¡è®°å½•")
print(f"æ–°å¢ž: {len(updated_df) - len(history_df)}æ¡è®°å½•")
```

### å¢žé‡æ›´æ–°çš„ä¼˜åŠ¿

1. **æ€§èƒ½æå‡**ï¼šé¿å…é‡æ–°è®¡ç®—åŽ†å²æ•°æ®ï¼Œå¤§å¹…æå‡æ•ˆçŽ‡
2. **çŠ¶æ€ä¿æŒ**ï¼šä¿æŒé€šé“çŠ¶æ€çš„è¿žç»­æ€§ï¼Œä¸ä¼šä¸¢å¤±åŽ†å²çŠ¶æ€
3. **å®žæ—¶æ›´æ–°**ï¼šæ”¯æŒæ¯æ—¥å®žæ—¶æ›´æ–°ï¼Œé€‚åˆå®žæ—¶äº¤æ˜“ç³»ç»Ÿ
4. **å†…å­˜å‹å¥½**ï¼šä¸éœ€è¦ä¿å­˜å¤§é‡åŽ†å²æ•°æ®ï¼ŒèŠ‚çœå†…å­˜

### å¢žé‡æ›´æ–°ä½¿ç”¨åœºæ™¯

```python
# åœºæ™¯1ï¼šæ¯æ—¥æ›´æ–°
def daily_update(history_df, new_day_data):
    """æ¯æ—¥æ›´æ–°åŽ†å²é€šé“æ•°æ®"""
    return CalIndicators.ascending_channel_history_incremental(history_df, new_day_data)


# åœºæ™¯2ï¼šæ‰¹é‡æ›´æ–°
def batch_update(history_df, new_batch_data):
    """æ‰¹é‡æ›´æ–°å¤šå¤©æ•°æ®"""
    return CalIndicators.ascending_channel_history_incremental(history_df, new_batch_data)


# åœºæ™¯3ï¼šå®žæ—¶äº¤æ˜“ç³»ç»Ÿ
class RealTimeChannelTracker:
    def __init__(self, initial_history_df):
        self.history_df = initial_history_df

    def update_with_new_bar(self, new_bar):
        """å®žæ—¶æ›´æ–°å•ä¸ªKçº¿æ•°æ®"""
        new_data = pd.DataFrame([new_bar])
        self.history_df = CalIndicators.ascending_channel_history_incremental(
            self.history_df, new_data
        )
        return self.history_df.iloc[-1]  # è¿”å›žæœ€æ–°çŠ¶æ€
```

## ðŸ“Š è¾“å‡ºæ•°æ®è¯´æ˜Ž

### åŽ†å²é€šé“DataFrameåˆ—è¯´æ˜Ž

| åˆ—å | ç±»åž‹ | è¯´æ˜Ž |
|------|------|------|
| `trade_date` | datetime | äº¤æ˜“æ—¥æœŸ |
| `close` | float | æ”¶ç›˜ä»· |
| `beta` | float | é€šé“æ–œçŽ‡ |
| `sigma` | float | å›žå½’æ ‡å‡†å·® |
| `mid_today` | float | å½“æ—¥ä¸­è½´ä»· |
| `upper_today` | float | å½“æ—¥ä¸Šæ²¿ä»· |
| `lower_today` | float | å½“æ—¥ä¸‹æ²¿ä»· |
| `mid_tomorrow` | float | æ˜Žæ—¥é¢„æµ‹ä¸­è½´ä»· |
| `upper_tomorrow` | float | æ˜Žæ—¥é¢„æµ‹ä¸Šæ²¿ä»· |
| `lower_tomorrow` | float | æ˜Žæ—¥é¢„æµ‹ä¸‹æ²¿ä»· |
| `channel_status` | str | é€šé“çŠ¶æ€ |
| `anchor_date` | datetime | é”šç‚¹æ—¥æœŸ |
| `anchor_price` | float | é”šç‚¹ä»·æ ¼ |
| `break_cnt_up` | int | è¿žç»­çªç ´ä¸Šæ²¿æ¬¡æ•° |
| `break_cnt_down` | int | è¿žç»­çªç ´ä¸‹æ²¿æ¬¡æ•° |
| `reanchor_fail_up` | int | é‡é”šå¤±è´¥æ¬¡æ•°ï¼ˆä¸Šæ²¿ï¼‰ |
| `reanchor_fail_down` | int | é‡é”šå¤±è´¥æ¬¡æ•°ï¼ˆä¸‹æ²¿ï¼‰ |
| `cumulative_gain` | float | ç´¯è®¡æ¶¨å¹… |
| `window_size` | int | çª—å£å¤§å° |
| `days_since_anchor` | int | è·ç¦»é”šç‚¹å¤©æ•° |

## ðŸ”§ é«˜çº§åŠŸèƒ½

### 1. é€šé“çŠ¶æ€åˆ†æž

```python
# åˆ†æžé€šé“çŠ¶æ€åˆ†å¸ƒ
status_counts = history_df['channel_status'].value_counts()
print("é€šé“çŠ¶æ€åˆ†å¸ƒ:")
print(status_counts)

# åˆ†æžæ–œçŽ‡å˜åŒ–
beta_stats = history_df['beta'].describe()
print("æ–œçŽ‡ç»Ÿè®¡:")
print(beta_stats)
```

### 2. é€šé“çªç ´åˆ†æž

```python
# æ‰¾å‡ºçªç ´ä¸Šæ²¿çš„æ—¶ç‚¹
breakout_up = history_df[history_df['break_cnt_up'] > 0]
print(f"çªç ´ä¸Šæ²¿æ¬¡æ•°: {len(breakout_up)}")

# æ‰¾å‡ºè·Œç ´ä¸‹æ²¿çš„æ—¶ç‚¹
breakout_down = history_df[history_df['break_cnt_down'] > 0]
print(f"è·Œç ´ä¸‹æ²¿æ¬¡æ•°: {len(breakout_down)}")
```

### 3. é€šé“æœ‰æ•ˆæ€§åˆ†æž

```python
# è®¡ç®—ä»·æ ¼åœ¨é€šé“å†…çš„æ¯”ä¾‹
def calculate_channel_accuracy(row):
    """è®¡ç®—ä»·æ ¼æ˜¯å¦åœ¨é€šé“å†…"""
    if row['close'] >= row['lower_today'] and row['close'] <= row['upper_today']:
        return 1
    return 0


history_df['in_channel'] = history_df.apply(calculate_channel_accuracy, axis=1)
accuracy = history_df['in_channel'].mean()
print(f"ä»·æ ¼åœ¨é€šé“å†…çš„æ¯”ä¾‹: {accuracy:.2%}")
```

## ðŸ“ˆ å®žé™…åº”ç”¨åœºæ™¯

### 1. å›žæµ‹åˆ†æž

```python
def backtest_channel_strategy(history_df):
    """åŸºäºŽåŽ†å²é€šé“æ•°æ®çš„å›žæµ‹ç­–ç•¥"""
    signals = []

    for i in range(1, len(history_df)):
        prev_row = history_df.iloc[i - 1]
        curr_row = history_df.iloc[i]

        # ä¹°å…¥ä¿¡å·ï¼šçªç ´ä¸Šæ²¿
        if (prev_row['break_cnt_up'] == 0 and curr_row['break_cnt_up'] == 1 and
                curr_row['channel_status'] == 'NORMAL'):
            signals.append({
                'date': curr_row['trade_date'],
                'action': 'BUY',
                'price': curr_row['close'],
                'reason': 'çªç ´ä¸Šæ²¿'
            })

        # å–å‡ºä¿¡å·ï¼šè·Œç ´ä¸‹æ²¿
        elif (prev_row['break_cnt_down'] == 0 and curr_row['break_cnt_down'] == 1 and
              curr_row['channel_status'] == 'NORMAL'):
            signals.append({
                'date': curr_row['trade_date'],
                'action': 'SELL',
                'price': curr_row['close'],
                'reason': 'è·Œç ´ä¸‹æ²¿'
            })

    return pd.DataFrame(signals)


# æ‰§è¡Œå›žæµ‹
signals_df = backtest_channel_strategy(history_df)
print("äº¤æ˜“ä¿¡å·:")
print(signals_df)
```

### 2. é€šé“è´¨é‡è¯„ä¼°

```python
def evaluate_channel_quality(history_df):
    """è¯„ä¼°é€šé“è´¨é‡"""
    # è®¡ç®—é€šé“å®½åº¦ç¨³å®šæ€§
    channel_width = history_df['upper_today'] - history_df['lower_today']
    width_cv = channel_width.std() / channel_width.mean()

    # è®¡ç®—æ–œçŽ‡ç¨³å®šæ€§
    beta_cv = history_df['beta'].std() / abs(history_df['beta'].mean())

    # è®¡ç®—ä»·æ ¼åœ¨é€šé“å†…çš„æ¯”ä¾‹
    accuracy = history_df['in_channel'].mean()

    return {
        'width_cv': width_cv,
        'beta_cv': beta_cv,
        'accuracy': accuracy,
        'total_points': len(history_df)
    }


quality = evaluate_channel_quality(history_df)
print("é€šé“è´¨é‡è¯„ä¼°:")
for key, value in quality.items():
    print(f"{key}: {value:.4f}")
```

### 3. æ‰¹é‡è‚¡ç¥¨åˆ†æž

```python
def analyze_multiple_stocks(stock_codes):
    """æ‰¹é‡åˆ†æžå¤šåªè‚¡ç¥¨çš„é€šé“æ•°æ®"""
    results = {}

    for code in stock_codes:
        try:
            # èŽ·å–æ•°æ®
            df = fetcher.fetch_stock_data(code)
            df = df[['trade_date', 'open', 'high', 'low', 'close', 'volume']].copy()

            # è®¡ç®—åŽ†å²é€šé“
            history_df = CalIndicators.ascending_channel_history_optimized(
                df, min_window_size=60, step_days=5
            )

            # è¯„ä¼°è´¨é‡
            quality = evaluate_channel_quality(history_df)
            results[code] = quality

        except Exception as e:
            print(f"åˆ†æžè‚¡ç¥¨ {code} å¤±è´¥: {e}")

    return pd.DataFrame(results).T


# æ‰¹é‡åˆ†æž
stock_codes = ['sz.301383', 'sz.000001', 'sh.600000']
results_df = analyze_multiple_stocks(stock_codes)
print("æ‰¹é‡åˆ†æžç»“æžœ:")
print(results_df)
```

### 4. å®žæ—¶ç›‘æŽ§ç³»ç»Ÿ

```python
class ChannelMonitor:
    """å®žæ—¶é€šé“ç›‘æŽ§ç³»ç»Ÿ"""

    def __init__(self, stock_code, min_window_size=60):
        self.stock_code = stock_code
        self.min_window_size = min_window_size
        self.history_df = None
        self.fetcher = StockDataFetcher()

    def initialize(self):
        """åˆå§‹åŒ–åŽ†å²æ•°æ®"""
        df = self.fetcher.fetch_stock_data(self.stock_code)
        df = df[['trade_date', 'open', 'high', 'low', 'close', 'volume']].copy()
        self.history_df = CalIndicators.ascending_channel_history(
            df, min_window_size=self.min_window_size
        )
        print(f"åˆå§‹åŒ–å®Œæˆï¼ŒåŽ†å²æ•°æ®é•¿åº¦: {len(self.history_df)}")

    def update_daily(self, new_data):
        """æ¯æ—¥æ›´æ–°"""
        if self.history_df is None:
            raise ValueError("è¯·å…ˆè°ƒç”¨ initialize() æ–¹æ³•")

        self.history_df = CalIndicators.ascending_channel_history_incremental(
            self.history_df, new_data
        )

        # èŽ·å–æœ€æ–°çŠ¶æ€
        latest = self.history_df.iloc[-1]

        # æ£€æŸ¥ä¿¡å·
        signals = []
        if latest['break_cnt_up'] == 1:
            signals.append("çªç ´ä¸Šæ²¿")
        if latest['break_cnt_down'] == 1:
            signals.append("è·Œç ´ä¸‹æ²¿")
        if latest['channel_status'] != 'NORMAL':
            signals.append(f"é€šé“çŠ¶æ€å¼‚å¸¸: {latest['channel_status']}")

        return {
            'date': latest['trade_date'],
            'close': latest['close'],
            'beta': latest['beta'],
            'mid_today': latest['mid_today'],
            'upper_today': latest['upper_today'],
            'lower_today': latest['lower_today'],
            'channel_status': latest['channel_status'],
            'signals': signals
        }


# ä½¿ç”¨ç¤ºä¾‹
monitor = ChannelMonitor('sz.301383')
monitor.initialize()

# æ¨¡æ‹Ÿæ¯æ—¥æ›´æ–°
new_day_data = pd.DataFrame({
    'trade_date': ['2025-07-19'],
    'open': [38.80],
    'high': [39.20],
    'low': [38.50],
    'close': [38.95],
    'volume': [1000000]
})

status = monitor.update_daily(new_day_data)
print("ä»Šæ—¥çŠ¶æ€:", status)
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### æ€§èƒ½ä¼˜åŒ–

1. **æ­¥é•¿è®¾ç½®**: å¯¹äºŽå¤§é‡æ•°æ®ï¼Œå»ºè®®ä½¿ç”¨ `step_days=5` æˆ– `step_days=10` æé«˜è®¡ç®—æ•ˆçŽ‡
2. **çª—å£å¤§å°**: `min_window_size` å»ºè®®è®¾ç½®ä¸º60-120å¤©ï¼Œå¹³è¡¡ç²¾åº¦å’Œæ•ˆçŽ‡
3. **æ•°æ®è´¨é‡**: ç¡®ä¿è¾“å…¥æ•°æ®æŒ‰æ—¶é—´æŽ’åºï¼Œæ— ç¼ºå¤±å€¼
4. **å¢žé‡æ›´æ–°**: å¯¹äºŽé¢‘ç¹æ›´æ–°çš„åœºæ™¯ï¼Œä¼˜å…ˆä½¿ç”¨å¢žé‡æ›´æ–°åŠŸèƒ½

### æ•°æ®è¦æ±‚

1. **æœ€å°æ•°æ®é‡**: è‡³å°‘éœ€è¦ `min_window_size + 20` ä¸ªæ•°æ®ç‚¹
2. **å¿…éœ€åˆ—**: `trade_date`, `open`, `high`, `low`, `close`, `volume`
3. **æ—¶é—´æ ¼å¼**: `trade_date` åº”ä¸º `datetime` ç±»åž‹
4. **å¢žé‡æ›´æ–°**: æ–°æ•°æ®çš„æ—¶é—´å¿…é¡»æ™šäºŽåŽ†å²æ•°æ®çš„æœ€åŽæ—¶é—´

### å¼‚å¸¸å¤„ç†

```python
try:
    history_df = CalIndicators.ascending_channel_history(df)
    # å¤„ç†ç»“æžœ
except InsufficientDataError as e:
    print(f"æ•°æ®ä¸è¶³: {e}")
except Exception as e:
    print(f"è®¡ç®—å¤±è´¥: {e}")

# å¢žé‡æ›´æ–°å¼‚å¸¸å¤„ç†
try:
    updated_df = CalIndicators.ascending_channel_history_incremental(history_df, new_data)
    # å¤„ç†æ›´æ–°ç»“æžœ
except ValueError as e:
    print(f"å¢žé‡æ›´æ–°å¤±è´¥: {e}")
    # å›žé€€åˆ°å®Œæ•´è®¡ç®—
    full_df = CalIndicators.ascending_channel_history(combined_df)
```

### æ•°æ®ä¸è¶³æ—¶ç‚¹çš„å¤„ç†

åŽ†å²é€šé“è®¡ç®—ä¼šä¸ºæ‰€æœ‰æ—¶ç‚¹ä¿ç•™è®°å½•ï¼Œå³ä½¿æŸäº›æ—¶ç‚¹æ•°æ®ä¸è¶³æ— æ³•è®¡ç®—é€šé“ï¼š

```python
# æŸ¥çœ‹æ•°æ®ä¸è¶³çš„æ—¶ç‚¹
invalid_records = history_df[history_df['beta'].isna()]
print(f"æ•°æ®ä¸è¶³çš„æ—¶ç‚¹æ•°: {len(invalid_records)}")

# æŸ¥çœ‹æœ‰æ•ˆé€šé“è®°å½•
valid_records = history_df[history_df['beta'].notna()]
print(f"æœ‰æ•ˆé€šé“è®°å½•æ•°: {len(valid_records)}")

# æ•°æ®ä¸è¶³æ—¶ç‚¹çš„ç¤ºä¾‹
print("æ•°æ®ä¸è¶³æ—¶ç‚¹ç¤ºä¾‹:")
print(invalid_records[['trade_date', 'close', 'beta', 'channel_status']].head())
```

**è¾“å‡ºç¤ºä¾‹ï¼š**

```
æ•°æ®ä¸è¶³çš„æ—¶ç‚¹æ•°: 2
æœ‰æ•ˆé€šé“è®°å½•æ•°: 179
æ•°æ®ä¸è¶³æ—¶ç‚¹ç¤ºä¾‹:
   trade_date  close  beta channel_status
0 2024-10-23  34.86   NaN           None
1 2024-10-24  34.69   NaN           None
```

**ç‰¹ç‚¹ï¼š**

- æ•°æ®ä¸è¶³æ—¶ç‚¹ä¿ç•™ `trade_date` å’Œ `close` ä¿¡æ¯
- é€šé“ç›¸å…³å­—æ®µï¼ˆ`beta`, `mid_today`, `upper_today`, `lower_today` ç­‰ï¼‰å¡«å……ä¸º `None`
- `channel_status` ä¸º `None`
- ä¾¿äºŽåŽç»­åˆ†æžå’Œå¯è§†åŒ–

## ðŸ“ å®Œæ•´ç¤ºä¾‹

```python
import pandas as pd
import numpy as np
from backend.data.data_fetcher import StockDataFetcher
from backend.utils.indicators import CalIndicators


def main():
    # èŽ·å–æ•°æ®
    fetcher = StockDataFetcher()
    df = fetcher.fetch_stock_data('sz.301383')
    df = df[['trade_date', 'open', 'high', 'low', 'close', 'volume']].copy()

    # è®¡ç®—åŽ†å²é€šé“æ•°æ®
    history_df = CalIndicators.ascending_channel_history_optimized(
        df, min_window_size=60, step_days=5
    )

    # åˆ†æžç»“æžœ
    print("=== åŽ†å²é€šé“åˆ†æžç»“æžœ ===")
    print(f"æ€»è®¡ç®—æ—¶ç‚¹: {len(history_df)}")
    print(f"æ—¶é—´èŒƒå›´: {history_df['trade_date'].min()} åˆ° {history_df['trade_date'].max()}")

    # é€šé“çŠ¶æ€åˆ†å¸ƒ
    print("\né€šé“çŠ¶æ€åˆ†å¸ƒ:")
    print(history_df['channel_status'].value_counts())

    # æ–œçŽ‡ç»Ÿè®¡
    print("\næ–œçŽ‡ç»Ÿè®¡:")
    print(history_df['beta'].describe())

    # æœ€æ–°é€šé“ä¿¡æ¯
    latest = history_df.iloc[-1]
    print(f"\næœ€æ–°é€šé“ä¿¡æ¯ ({latest['trade_date']}):")
    print(f"æ”¶ç›˜ä»·: {latest['close']:.2f}")
    print(f"æ–œçŽ‡: {latest['beta']:.4f}")
    print(f"ä¸­è½´: {latest['mid_today']:.2f}")
    print(f"ä¸Šæ²¿: {latest['upper_today']:.2f}")
    print(f"ä¸‹æ²¿: {latest['lower_today']:.2f}")
    print(f"é€šé“çŠ¶æ€: {latest['channel_status']}")

    # å¢žé‡æ›´æ–°ç¤ºä¾‹
    print("\n=== å¢žé‡æ›´æ–°ç¤ºä¾‹ ===")
    new_data = pd.DataFrame({
        'trade_date': ['2025-07-19', '2025-07-20'],
        'open': [38.80, 38.95],
        'high': [39.20, 39.50],
        'low': [38.50, 38.80],
        'close': [38.95, 39.30],
        'volume': [1000000, 1200000]
    })

    updated_df = CalIndicators.ascending_channel_history_incremental(history_df, new_data)
    print(f"å¢žé‡æ›´æ–°åŽæ€»è®°å½•æ•°: {len(updated_df)}")
    print(f"æ–°å¢žè®°å½•æ•°: {len(updated_df) - len(history_df)}")

    return history_df, updated_df


if __name__ == "__main__":
    history_df, updated_df = main()
```

---

**æœ€åŽæ›´æ–°**: 2024å¹´12æœˆ19æ—¥  
**ç‰ˆæœ¬**: v2.0  
**æ–°å¢žåŠŸèƒ½**: å¢žé‡æ›´æ–°ã€å®žæ—¶ç›‘æŽ§ã€æ‰¹é‡åˆ†æž

### è‡ªå®šä¹‰å‚æ•°ä½¿ç”¨

æ‰€æœ‰æ–¹æ³•éƒ½æ”¯æŒé€šè¿‡ `**params` å‚æ•°è‡ªå®šä¹‰é…ç½®ï¼Œè¦†ç›–é…ç½®æ–‡ä»¶ä¸­çš„é»˜è®¤å‚æ•°ï¼š

```python
# ä½¿ç”¨è‡ªå®šä¹‰å‚æ•°è®¡ç®—ä¸Šå‡é€šé“
custom_params = {
    'k': 2.5,  # é€šé“å®½åº¦å€æ•°
    'L_max': 100,  # æœ€å¤§çª—å£é•¿åº¦
    'gain_trigger': 0.4,  # é‡é”šæ¶¨å¹…è§¦å‘é˜ˆå€¼
    'break_days': 5,  # è¿žç»­çªç ´å¤©æ•°
    'pivot_m': 5  # é”šç‚¹æ£€æµ‹å‚æ•°
}

# å•æ¬¡è®¡ç®—
result = CalIndicators.ascending_channel(df, **custom_params)

# åŽ†å²é€šé“è®¡ç®—
history_df = CalIndicators.ascending_channel_history(
    df,
    min_window_size=60,
    **custom_params
)

# ä¼˜åŒ–åŽ†å²é€šé“è®¡ç®—
history_df = CalIndicators.ascending_channel_history_optimized(
    df,
    min_window_size=60,
    step_days=5,
    **custom_params
)
```

### æ”¯æŒçš„å‚æ•°åˆ—è¡¨

| å‚æ•°å | ç±»åž‹ | é»˜è®¤å€¼ | è¯´æ˜Ž |
|--------|------|--------|------|
| `k` | float | 2.0 | é€šé“å®½åº¦å€æ•°ï¼ŒæŽ§åˆ¶é€šé“ä¸Šä¸‹æ²¿çš„å®½åº¦ |
| `L_max` | int | 120 | æœ€å¤§çª—å£é•¿åº¦ï¼Œè¶…è¿‡æ­¤é•¿åº¦ä¼šæ»‘åŠ¨çª—å£ |
| `delta_cut` | int | 5 | æ»‘åŠ¨çª—å£åˆ é™¤å¤©æ•° |
| `pivot_m` | int | 3 | é”šç‚¹æ£€æµ‹å‚æ•°ï¼Œåˆ¤æ–­pivotçš„å®½åº¦ |
| `gain_trigger` | float | 0.30 | é‡é”šæ¶¨å¹…è§¦å‘é˜ˆå€¼ |
| `beta_delta` | float | 0.15 | æ–œçŽ‡å˜åŒ–é˜ˆå€¼ |
| `break_days` | int | 3 | è¿žç»­çªç ´å¤©æ•° |
| `reanchor_fail_max` | int | 2 | é‡é”šå¤±è´¥æœ€å¤§æ¬¡æ•° |
| `min_data_points` | int | 60 | æœ€å°æ•°æ®ç‚¹æ•° |

### å‚æ•°ä½¿ç”¨ç¤ºä¾‹

```python
# ç¤ºä¾‹1ï¼šè°ƒæ•´é€šé“å®½åº¦
narrow_channel = CalIndicators.ascending_channel(df, k=1.5)  # çª„é€šé“
wide_channel = CalIndicators.ascending_channel(df, k=3.0)  # å®½é€šé“

# ç¤ºä¾‹2ï¼šè°ƒæ•´é‡é”šæ•æ„Ÿåº¦
sensitive = CalIndicators.ascending_channel(df, gain_trigger=0.2)  # æ›´æ•æ„Ÿ
stable = CalIndicators.ascending_channel(df, gain_trigger=0.5)  # æ›´ç¨³å®š

# ç¤ºä¾‹3ï¼šè°ƒæ•´çª—å£é•¿åº¦
short_window = CalIndicators.ascending_channel(df, L_max=60)  # çŸ­çª—å£
long_window = CalIndicators.ascending_channel(df, L_max=200)  # é•¿çª—å£

# ç¤ºä¾‹4ï¼šç»„åˆå‚æ•°
custom_config = {
    'k': 2.5,
    'L_max': 100,
    'gain_trigger': 0.4,
    'break_days': 5,
    'pivot_m': 5
}

result = CalIndicators.ascending_channel(df, **custom_config)
``` 

# ã€è¡¥å……ã€‘å‚æ•°ä½œç”¨ä¸Žè°ƒä¼˜å»ºè®®

## å…³é”®å‚æ•°è¯´æ˜Ž

| å‚æ•°å           | ä½œç”¨/å»ºè®®                                                         |
|------------------|-------------------------------------------------------------------|
| min_window_size  | æŽ§åˆ¶åŽ†å²é€šé“è®¡ç®—çš„èµ·ç‚¹ï¼Œè¶Šå°è¶Šæ—©å°è¯•ï¼Œä½†æœ‰æ•ˆé€šé“èµ·ç‚¹ç”±æ•°æ®å†³å®š      |
| pivot_m          | é”šç‚¹æ£€æµ‹çµæ•åº¦ï¼Œè¶Šå°è¶Šå®¹æ˜“æ‰¾åˆ°é”šç‚¹ï¼Œè¶Šå¤§è¶Šä¸¥æ ¼ï¼Œé€‚åˆå¤§æ³¢åŠ¨å“ç§      |
| min_data_points  | æœ€å°æœ‰æ•ˆæ•°æ®ç‚¹ï¼Œå½±å“èƒ½å¦æ‰¾åˆ°æœ‰æ•ˆé€šé“ï¼Œè°ƒå°å¯è®©é€šé“æ›´æ—©å‡ºçŽ°           |
| k                | é€šé“å®½åº¦å€æ•°ï¼Œå½±å“é€šé“ä¸Šä¸‹æ²¿å®½çª„                                   |
| L_max            | æœ€å¤§çª—å£é•¿åº¦ï¼Œå½±å“é€šé“çš„â€œè®°å¿†â€é•¿åº¦                                 |

## æŽ¨èè®¾ç½®

- min_window_size: 60~120ï¼ˆä¸€èˆ¬ä¸å»ºè®®å°äºŽ60ï¼Œé™¤éžæ•°æ®å¾ˆçŸ­ï¼‰
- pivot_m: 2~5ï¼ˆå°ç¥¨/é«˜æ³¢åŠ¨å¯ç”¨2ï¼Œå¤§ç¥¨/ä½Žæ³¢åŠ¨å¯ç”¨3~5ï¼‰
- min_data_points: 30~60ï¼ˆæƒ³è®©é€šé“æ›´æ—©å‡ºçŽ°å¯è°ƒå°ï¼Œä½†ä¼šé™ä½Žç¨³å¥æ€§ï¼‰

---

# ã€è¡¥å……ã€‘å¦‚ä½•è®©é€šé“æ›´æ—©å‡ºçŽ°ï¼Ÿ

1. **è°ƒå°pivot_m**ï¼š
   ```python
   # æ›´çµæ•çš„é”šç‚¹æ£€æµ‹
   analyzer = AscendingChannelRegression(pivot_m=1)
   ```
2. **è°ƒå°min_data_points**ï¼š
   ```python
   analyzer = AscendingChannelRegression(min_data_points=20)
   ```
3. **è°ƒå°min_window_size**ï¼š
   ```python
   history_df = CalIndicators.ascending_channel_history(df, min_window_size=10)
   ```
4. **æ•°æ®æœ¬èº«è¦æœ‰æ˜Žæ˜¾è¶‹åŠ¿**ï¼šå¦‚æžœå‰æœŸæ•°æ®æ¨ªç›˜æˆ–æ³¢åŠ¨å¤ªå°ï¼Œé€šé“å¾ˆéš¾æ—©å‡ºçŽ°ã€‚

---

# ã€è¡¥å……ã€‘å¸¸è§è¯¯åŒºä¸Žè°ƒä¼˜å»ºè®®

- è¯¯åŒº1ï¼šä»¥ä¸ºmin_window_sizeè¶Šå°é€šé“è¶Šæ—©å‡ºçŽ°ã€‚å®žé™…ä¸Šï¼Œ**æœ‰æ•ˆé€šé“èµ·ç‚¹ç”±æ•°æ®å’Œé”šç‚¹å‚æ•°å†³å®š**ã€‚
- è¯¯åŒº2ï¼šä»¥ä¸ºæ‰€æœ‰å‚æ•°éƒ½èƒ½éšæ—¶ç”Ÿæ•ˆã€‚**åªæœ‰å®žä¾‹åŒ–æ—¶ä¼ å…¥çš„å‚æ•°æ‰ä¼šå…¨é“¾è·¯ç”Ÿæ•ˆ**ã€‚
- è¯¯åŒº3ï¼šä»¥ä¸ºæ‰€æœ‰æ—¶ç‚¹éƒ½èƒ½ç®—å‡ºé€šé“ã€‚**å‰æœŸæ•°æ®ä¸è¶³/æ‰¾ä¸åˆ°é”šç‚¹æ—¶ï¼Œé€šé“å­—æ®µä¼šæ˜¯None**ã€‚

**è°ƒä¼˜å»ºè®®**ï¼š

- å…ˆç”¨é»˜è®¤å‚æ•°ï¼Œè§‚å¯Ÿæœ‰æ•ˆé€šé“èµ·ç‚¹ï¼Œå†é€æ­¥è°ƒå°pivot_mã€min_data_pointsã€‚
- å¦‚æžœé€šé“å¤ªâ€œè·³â€ï¼Œå¯é€‚å½“å¢žå¤§pivot_mã€min_data_pointsã€‚
- å…³æ³¨betaã€window_sizeã€channel_statusç­‰å­—æ®µï¼Œè¾…åŠ©åˆ¤æ–­é€šé“è´¨é‡ã€‚

---

# ã€è¡¥å……ã€‘å‚æ•°è°ƒä¼˜å¯¹æ¯”å®žéªŒ

```python
# å¯¹æ¯”ä¸åŒpivot_må’Œmin_data_pointsçš„æ•ˆæžœ
for m in [1, 2, 3]:
    analyzer = AscendingChannelRegression(pivot_m=m, min_data_points=20)
    history_df = analyzer.fit_channel_history(df, min_window_size=10)
    valid_cnt = history_df['beta'].notna().sum()
    print(f"pivot_m={m}, æœ‰æ•ˆé€šé“ç‚¹æ•°: {valid_cnt}")
```

---

# ã€è¡¥å……ã€‘å¼‚å¸¸æ•°æ®å¤„ç†ä¸Žå®¹é”™æœºåˆ¶

- æ‰€æœ‰åŽ†å²æ—¶ç‚¹éƒ½ä¼šä¿ç•™ä¸€æ¡è®°å½•ï¼Œæ•°æ®ä¸è¶³/é”šç‚¹æ‰¾ä¸åˆ°æ—¶é€šé“å­—æ®µä¸ºNoneã€‚
- å¢žé‡æ›´æ–°æ—¶å¦‚é‡å¼‚å¸¸ï¼Œä¼šè‡ªåŠ¨é™çº§ä¸ºNoneå¹¶é‡ç½®çŠ¶æ€ï¼Œä¿è¯åŽç»­å¯æ¢å¤ã€‚
- å»ºè®®å¯¹history_dfåšå¦‚ä¸‹æ£€æŸ¥ï¼š
  ```python
  # æ£€æŸ¥æ— æ•ˆç‚¹
  print(history_df[history_df['beta'].isna()][['trade_date','close']].head())
  # æ£€æŸ¥æœ‰æ•ˆç‚¹
  print(history_df[history_df['beta'].notna()][['trade_date','close','beta']].head())
  ```

---

# ã€è¡¥å……ã€‘FAQä¸Žå®žç”¨åœºæ™¯å°ç»“

## Q: ä¸ºä»€ä¹ˆå‰é¢å‡ åä¸ªç‚¹é€šé“éƒ½æ˜¯Noneï¼Ÿ

A: æ•°æ®ä¸è¶³/æ‰¾ä¸åˆ°æœ‰æ•ˆé”šç‚¹/çª—å£å¤ªå°ï¼Œå±žäºŽæ­£å¸¸çŽ°è±¡ã€‚

## Q: å¦‚ä½•è®©é€šé“æ›´æ—©å‡ºçŽ°ï¼Ÿ

A: è°ƒå°pivot_mã€min_data_pointsï¼Œæˆ–ç”¨æ›´æœ‰è¶‹åŠ¿æ€§çš„æ•°æ®ã€‚

## Q: ä¸ºä»€ä¹ˆmin_window_sizeæ€Žä¹ˆè°ƒéƒ½æ²¡ç”¨ï¼Ÿ

A: å®ƒåªå½±å“å¾ªçŽ¯èµ·ç‚¹ï¼Œå®žé™…æœ‰æ•ˆé€šé“èµ·ç‚¹ç”±æ•°æ®å’Œé”šç‚¹å‚æ•°å†³å®šã€‚

## Q: å¦‚ä½•æ‰¹é‡åˆ†æžå¤šåªè‚¡ç¥¨ï¼Ÿ

A: ç”¨CalIndicators.ascending_channel_batch(df_list)å³å¯ã€‚

## Q: å¦‚ä½•åˆ¤æ–­é€šé“è´¨é‡ï¼Ÿ

A: å…³æ³¨window_sizeã€betaã€channel_statusï¼Œç»“åˆå®žé™…èµ°åŠ¿åˆ†æžã€‚

---

ã€å¦‚éœ€æ›´è¯¦ç»†çš„è°ƒä¼˜å»ºè®®æˆ–é‡åˆ°ç‰¹æ®Šæ•°æ®é—®é¢˜ï¼Œæ¬¢è¿Žéšæ—¶è”ç³»å¼€å‘è€…ï¼ã€‘ 