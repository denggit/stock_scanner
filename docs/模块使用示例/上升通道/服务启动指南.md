# 服务启动指南

## 概述

本文档介绍如何正确启动上升通道策略回测系统的前后端服务。

## 启动步骤

### 1. 启动后端服务

#### 方法一：直接启动
```bash
# 在项目根目录下运行
python run_backend.py
```

#### 方法二：使用uvicorn启动
```bash
# 在项目根目录下运行
uvicorn backend.app:app --host 0.0.0.0 --port 8000 --reload
```

#### 验证后端服务
启动成功后，你应该看到类似以下的输出：
```
INFO:     Started server process [xxxxx]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
```

你可以通过浏览器访问 `http://localhost:8000` 来验证服务是否正常运行。

### 2. 启动前端服务

#### 启动Streamlit应用
```bash
# 在项目根目录下运行
python run_frontend.py
```

或者：
```bash
# 直接启动回测页面
streamlit run pages/backtest.py
```

#### 验证前端服务
启动成功后，你应该看到类似以下的输出：
```
You can now view your Streamlit app in your browser.

Local URL: http://localhost:8501
Network URL: http://192.168.x.x:8501
```

### 3. 访问应用

1. 打开浏览器
2. 访问 `http://localhost:8501`
3. 导航到回测页面
4. 选择"上升通道策略"
5. 设置参数并开始回测

## 常见问题

### 1. 端口冲突

如果遇到端口冲突，可以修改端口：

#### 修改后端端口
```bash
# 修改run_backend.py中的端口
uvicorn backend.app:app --host 0.0.0.0 --port 8001 --reload
```

#### 修改前端端口
```bash
# 使用自定义端口启动Streamlit
streamlit run pages/backtest.py --server.port 8502
```

### 2. 连接失败

如果前端无法连接到后端，请检查：

1. **后端服务是否正在运行**
   ```bash
   # 检查8000端口是否被占用
   lsof -i :8000
   ```

2. **防火墙设置**
   - 确保防火墙允许8000端口访问

3. **环境变量设置**
   ```bash
   # 设置后端URL和端口
   export BACKEND_URL=http://localhost
   export BACKEND_PORT=8000
   ```

### 3. 依赖问题

如果遇到依赖问题，请安装必要的包：

```bash
# 安装依赖
pip install -r requirements.txt

# 或者手动安装主要依赖
pip install fastapi uvicorn streamlit requests pandas plotly
```

### 4. 权限问题

在某些系统上可能需要管理员权限：

```bash
# Linux/Mac
sudo python run_backend.py

# Windows (以管理员身份运行命令提示符)
python run_backend.py
```

## 开发模式

### 热重载

在开发过程中，建议使用热重载模式：

```bash
# 后端热重载
uvicorn backend.app:app --host 0.0.0.0 --port 8000 --reload

# 前端热重载（Streamlit默认支持）
streamlit run pages/backtest.py
```

### 调试模式

启用调试模式以获取更详细的错误信息：

```bash
# 后端调试模式
uvicorn backend.app:app --host 0.0.0.0 --port 8000 --reload --log-level debug

# 前端调试模式
streamlit run pages/backtest.py --logger.level debug
```

## 生产部署

### Docker部署

创建 `Dockerfile`：

```dockerfile
FROM python:3.9-slim

WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt

COPY . .

EXPOSE 8000 8501

CMD ["python", "run_backend.py"]
```

### 系统服务

创建系统服务文件：

```ini
# /etc/systemd/system/stock-scanner.service
[Unit]
Description=Stock Scanner Backend
After=network.target

[Service]
Type=simple
User=your-user
WorkingDirectory=/path/to/stock_scanner
ExecStart=/usr/bin/python run_backend.py
Restart=always

[Install]
WantedBy=multi-user.target
```

## 监控和日志

### 查看日志

```bash
# 查看后端日志
tail -f logs/backtest_service.log

# 查看前端日志
streamlit run pages/backtest.py --logger.level info
```

### 健康检查

```bash
# 检查后端服务状态
curl http://localhost:8000/

# 检查API接口
curl http://localhost:8000/api/backtest/run?strategy=上升通道策略
```

## 故障排除

### 1. 服务无法启动

检查错误信息：
```bash
# 查看详细错误
python run_backend.py 2>&1 | tee error.log
```

### 2. 连接超时

增加超时时间：
```python
# 在pages/backtest.py中修改timeout参数
response = requests.get(url, params=request_params, timeout=60)
```

### 3. 内存不足

减少并发请求：
```python
# 在backend/app.py中限制并发
app = FastAPI(title="Stock Screener API", max_concurrent_requests=10)
```

## 联系支持

如果遇到其他问题，请：

1. 查看错误日志
2. 检查系统资源使用情况
3. 确认网络连接
4. 联系技术支持团队 