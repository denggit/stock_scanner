# ä¸Šå‡é€šé“å¿«æ·è°ƒç”¨ä½¿ç”¨ç¤ºä¾‹

## ğŸ“‹ æ¦‚è¿°

åœ¨ `backend/utils/indicators.py` ä¸­æ–°å¢äº†ä¸Šå‡é€šé“å›å½’åˆ†æçš„å¿«æ·è°ƒç”¨æ–¹æ³•ï¼Œè®©æ‚¨å¯ä»¥åƒä½¿ç”¨å…¶ä»–æŠ€æœ¯æŒ‡æ ‡ä¸€æ ·ç®€å•åœ°è°ƒç”¨ä¸Šå‡é€šé“åˆ†æåŠŸèƒ½ã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

### åŸºæœ¬ä½¿ç”¨

```python
import pandas as pd
from backend.utils.indicators import CalIndicators

# å‡†å¤‡æ•°æ®ï¼ˆå¿…é¡»åŒ…å« trade_date, open, high, low, close, volume åˆ—ï¼‰
df = pd.DataFrame({
    'trade_date': [...],  # æ—¥æœŸåºåˆ—
    'open': [...],        # å¼€ç›˜ä»·
    'high': [...],        # æœ€é«˜ä»·
    'low': [...],         # æœ€ä½ä»·
    'close': [...],       # æ”¶ç›˜ä»·
    'volume': [...]       # æˆäº¤é‡
})

# è®¡ç®—ä¸Šå‡é€šé“å›å½’åˆ†æ
channel_info = CalIndicators.ascending_channel(df)

# æŸ¥çœ‹ç»“æœ
print(f"æ–œç‡: {channel_info['beta']:.4f}")
print(f"ä»Šæ—¥ä¸­è½´: {channel_info['mid_today']:.2f}")
print(f"ä»Šæ—¥ä¸Šæ²¿: {channel_info['upper_today']:.2f}")
print(f"ä»Šæ—¥ä¸‹æ²¿: {channel_info['lower_today']:.2f}")
print(f"é€šé“çŠ¶æ€: {channel_info['channel_status']}")
print(f"ç´¯è®¡æ¶¨å¹…: {channel_info['cumulative_gain']:.2%}")
```

### ä½¿ç”¨è‡ªå®šä¹‰é…ç½®

```python
# ä½¿ç”¨è‡ªå®šä¹‰é…ç½®æ–‡ä»¶
custom_config_path = "path/to/custom_config.yaml"
channel_info = CalIndicators.ascending_channel(df, config_path=custom_config_path)
```

## ğŸ“Š è¿”å›ç»“æœè¯´æ˜

### é€šé“ä¿¡æ¯å­—å…¸

```python
{
    "beta": 0.0427,              # æœ€æ–°æ–œç‡ beta_t
    "mid_today": 34.89,          # ä»Šæ—¥ä¸­è½´ä»·
    "upper_today": 36.51,        # ä»Šæ—¥ä¸Šæ²¿ä»·
    "lower_today": 33.28,        # ä»Šæ—¥ä¸‹æ²¿ä»·
    "mid_tomorrow": 34.93,       # é¢„ä¼°ä¸‹ä¸€äº¤æ˜“æ—¥ä¸­è½´ä»·
    "upper_tomorrow": 36.55,     # é¢„ä¼°ä¸‹ä¸€äº¤æ˜“æ—¥ä¸Šæ²¿ä»·
    "lower_tomorrow": 33.31,     # é¢„ä¼°ä¸‹ä¸€äº¤æ˜“æ—¥ä¸‹æ²¿ä»·
    "channel_status": "NORMAL",  # é€šé“çŠ¶æ€
    "anchor_date": "2024-01-15T00:00:00",  # é”šç‚¹æ—¥æœŸ
    "anchor_price": 30.50,       # é”šç‚¹ä»·æ ¼
    "break_cnt_up": 0,           # è¿ç»­çªç ´ä¸Šæ²¿æ¬¡æ•°
    "break_cnt_down": 0,         # è¿ç»­çªç ´ä¸‹æ²¿æ¬¡æ•°
    "reanchor_fail_up": 0,       # é‡é”šå¤±è´¥æ¬¡æ•°ï¼ˆä¸Šæ²¿ï¼‰
    "reanchor_fail_down": 0,     # é‡é”šå¤±è´¥æ¬¡æ•°ï¼ˆä¸‹æ²¿ï¼‰
    "cumulative_gain": 0.1575,   # ç´¯è®¡æ¶¨å¹…
    "last_update": "2024-12-19T00:00:00"  # æœ€åæ›´æ–°æ—¶é—´
}
```

### é€šé“çŠ¶æ€è¯´æ˜

| çŠ¶æ€ | æè¿° | å«ä¹‰ |
|------|------|------|
| `NORMAL` | é€šé“æ­£å¸¸ | ä»·æ ¼åœ¨é€šé“å†…æ­£å¸¸æ³¢åŠ¨ |
| `ACCEL_BREAKOUT` | åŠ é€Ÿçªç ´ | è¿ç»­çªç ´ä¸Šæ²¿ï¼Œå¯èƒ½è¿›å…¥åŠ é€Ÿä¸Šæ¶¨ |
| `BREAKDOWN` | è·Œç ´ä¸‹æ²¿ | è¿ç»­è·Œç ´ä¸‹æ²¿ï¼Œè¶‹åŠ¿å¯èƒ½åè½¬ |
| `BROKEN` | é€šé“å¤±æ•ˆ | é€šé“å·²å¤±æ•ˆï¼Œéœ€è¦é‡æ–°å»ºç«‹ |

## ğŸ”§ é«˜çº§åŠŸèƒ½

### æ‰¹é‡è®¡ç®—

```python
# å‡†å¤‡å¤šä¸ªæ•°æ®é›†
df_list = [df1, df2, df3, ...]  # å¤šä¸ªDataFrameçš„åˆ—è¡¨

# æ‰¹é‡è®¡ç®—ä¸Šå‡é€šé“
results = CalIndicators.ascending_channel_batch(df_list)

# å¤„ç†ç»“æœ
for i, result in enumerate(results):
    if result:
        print(f"æ•°æ®é›† {i+1}: æ–œç‡={result['beta']:.4f}, çŠ¶æ€={result['channel_status']}")
    else:
        print(f"æ•°æ®é›† {i+1}: è®¡ç®—å¤±è´¥")
```

### ä¸å…¶ä»–æŒ‡æ ‡ç»“åˆä½¿ç”¨

```python
# è®¡ç®—å¤šä¸ªæŒ‡æ ‡
macd, macd_signal, macd_hist = CalIndicators.macd(df)
rsi = CalIndicators.rsi(df)
channel_info = CalIndicators.ascending_channel(df)

# ç»¼åˆåˆ†æ
if (channel_info['channel_status'] == 'NORMAL' and 
    channel_info['beta'] > 0.02 and  # æ–œç‡å¤§äº2%
    rsi.iloc[-1] < 70 and           # RSIä¸è¿‡çƒ­
    macd.iloc[-1] > macd_signal.iloc[-1]):  # MACDé‡‘å‰
    
    print("ç¬¦åˆä¹°å…¥æ¡ä»¶")
```

## ğŸ“ˆ å®é™…åº”ç”¨åœºæ™¯

### 1. ç­–ç•¥æ‰«æ

```python
def scan_ascending_channels(stock_list):
    """æ‰«æä¸Šå‡é€šé“è‚¡ç¥¨"""
    results = []
    
    for stock_code in stock_list:
        try:
            # è·å–è‚¡ç¥¨æ•°æ®
            df = get_stock_data(stock_code, days=252)
            
            # è®¡ç®—ä¸Šå‡é€šé“
            channel_info = CalIndicators.ascending_channel(df)
            
            # ç­›é€‰ç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨
            if (channel_info['channel_status'] == 'NORMAL' and 
                channel_info['beta'] > 0.02 and  # æ–œç‡å¤§äº2%
                channel_info['cumulative_gain'] > 0.1):  # ç´¯è®¡æ¶¨å¹…å¤§äº10%
                
                results.append({
                    'code': stock_code,
                    'beta': channel_info['beta'],
                    'gain': channel_info['cumulative_gain'],
                    'status': channel_info['channel_status'],
                    'upper': channel_info['upper_today'],
                    'lower': channel_info['lower_today']
                })
                
        except Exception as e:
            print(f"åˆ†æè‚¡ç¥¨ {stock_code} å¤±è´¥: {e}")
    
    return results
```

### 2. é£é™©ç›‘æ§

```python
def monitor_channel_risk(df):
    """ç›‘æ§é€šé“é£é™©"""
    channel_info = CalIndicators.ascending_channel(df)
    
    risk_level = "LOW"
    risk_reasons = []
    
    # æ£€æŸ¥å„ç§é£é™©ä¿¡å·
    if channel_info['channel_status'] == 'BREAKDOWN':
        risk_level = "HIGH"
        risk_reasons.append("è·Œç ´é€šé“ä¸‹æ²¿")
    
    if channel_info['break_cnt_down'] >= 2:
        risk_level = "MEDIUM"
        risk_reasons.append("è¿ç»­è·Œç ´ä¸‹æ²¿")
    
    if channel_info['cumulative_gain'] > 0.5:
        risk_level = "MEDIUM"
        risk_reasons.append("ç´¯è®¡æ¶¨å¹…è¿‡å¤§")
    
    return {
        'risk_level': risk_level,
        'reasons': risk_reasons,
        'channel_info': channel_info
    }
```

### 3. äº¤æ˜“ä¿¡å·ç”Ÿæˆ

```python
def generate_trading_signals(df):
    """ç”Ÿæˆäº¤æ˜“ä¿¡å·"""
    channel_info = CalIndicators.ascending_channel(df)
    current_price = df['close'].iloc[-1]
    
    signals = []
    
    # ä¹°å…¥ä¿¡å·
    if (channel_info['channel_status'] == 'ACCEL_BREAKOUT' and
        current_price > channel_info['upper_today']):
        signals.append({
            'type': 'BUY',
            'reason': 'åŠ é€Ÿçªç ´ä¸Šæ²¿',
            'price': current_price,
            'target': channel_info['upper_tomorrow']
        })
    
    # å–å‡ºä¿¡å·
    elif (channel_info['channel_status'] == 'BREAKDOWN' and
          current_price < channel_info['lower_today']):
        signals.append({
            'type': 'SELL',
            'reason': 'è·Œç ´ä¸‹æ²¿',
            'price': current_price,
            'stop_loss': channel_info['lower_tomorrow']
        })
    
    return signals
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### æ•°æ®è¦æ±‚

1. **å¿…éœ€åˆ—**: æ•°æ®å¿…é¡»åŒ…å« `trade_date`, `open`, `high`, `low`, `close`, `volume` åˆ—
2. **æ•°æ®é•¿åº¦**: è‡³å°‘éœ€è¦60ä¸ªäº¤æ˜“æ—¥çš„æ•°æ®
3. **æ•°æ®è´¨é‡**: ç¡®ä¿æ•°æ®æŒ‰æ—¶é—´æ’åºï¼Œæ— ç¼ºå¤±å€¼
4. **æ•°æ®æ ¼å¼**: æ—¥æœŸåˆ—åº”ä¸º `datetime` ç±»å‹ï¼Œä»·æ ¼åˆ—åº”ä¸ºæ•°å€¼ç±»å‹

### é”™è¯¯å¤„ç†

```python
try:
    channel_info = CalIndicators.ascending_channel(df)
    # å¤„ç†ç»“æœ
except ImportError as e:
    print("ä¸Šå‡é€šé“æ¨¡å—ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥å®‰è£…")
except ValueError as e:
    print(f"æ•°æ®æ ¼å¼é”™è¯¯: {e}")
except Exception as e:
    print(f"è®¡ç®—å¤±è´¥: {e}")
```

### æ€§èƒ½ä¼˜åŒ–

```python
# å¯¹äºå¤§é‡æ•°æ®ï¼Œå»ºè®®ä½¿ç”¨æ‰¹é‡è®¡ç®—
df_list = [df1, df2, df3, ...]
results = CalIndicators.ascending_channel_batch(df_list)

# æˆ–è€…å¹¶è¡Œå¤„ç†
import concurrent.futures

def process_single_df(df):
    return CalIndicators.ascending_channel(df)

with concurrent.futures.ThreadPoolExecutor(max_workers=4) as executor:
    results = list(executor.map(process_single_df, df_list))
```

## ğŸ” è°ƒè¯•æŠ€å·§

### æ£€æŸ¥æ¨¡å—å¯ç”¨æ€§

```python
from backend.utils.indicators import ASCENDING_CHANNEL_AVAILABLE

if ASCENDING_CHANNEL_AVAILABLE:
    print("ä¸Šå‡é€šé“æ¨¡å—å¯ç”¨")
else:
    print("ä¸Šå‡é€šé“æ¨¡å—ä¸å¯ç”¨")
```

### éªŒè¯æ•°æ®æ ¼å¼

```python
def validate_data(df):
    """éªŒè¯æ•°æ®æ ¼å¼"""
    required_columns = ['trade_date', 'open', 'high', 'low', 'close', 'volume']
    
    # æ£€æŸ¥å¿…éœ€åˆ—
    missing_columns = [col for col in required_columns if col not in df.columns]
    if missing_columns:
        print(f"ç¼ºå°‘å¿…éœ€åˆ—: {missing_columns}")
        return False
    
    # æ£€æŸ¥æ•°æ®é•¿åº¦
    if len(df) < 60:
        print(f"æ•°æ®ä¸è¶³ï¼Œéœ€è¦è‡³å°‘60æ¡ï¼Œå½“å‰åªæœ‰{len(df)}æ¡")
        return False
    
    # æ£€æŸ¥æ•°æ®ç±»å‹
    if not pd.api.types.is_datetime64_any_dtype(df['trade_date']):
        print("æ—¥æœŸåˆ—æ ¼å¼ä¸æ­£ç¡®")
        return False
    
    return True
```

## ğŸ“ å®Œæ•´ç¤ºä¾‹

```python
import pandas as pd
import numpy as np
from datetime import datetime, timedelta
from backend.utils.indicators import CalIndicators

# ç”Ÿæˆç¤ºä¾‹æ•°æ®
def generate_sample_data(n_days=100):
    dates = pd.date_range('2023-01-01', periods=n_days, freq='D')
    
    # ç”Ÿæˆä¸Šå‡è¶‹åŠ¿æ•°æ®
    base_trend = np.linspace(10, 50, n_days)
    noise = np.random.normal(0, 1, n_days)
    prices = base_trend + noise
    
    data = []
    for i, (date, price) in enumerate(zip(dates, prices)):
        data.append({
            'trade_date': date,
            'open': price * (1 + np.random.uniform(-0.02, 0.02)),
            'high': price * (1 + np.random.uniform(0.01, 0.05)),
            'low': price * (1 - np.random.uniform(0.01, 0.05)),
            'close': price,
            'volume': np.random.randint(1000000, 10000000)
        })
    
    return pd.DataFrame(data)

# ä¸»ç¨‹åº
def main():
    # ç”Ÿæˆæ•°æ®
    df = generate_sample_data(120)
    
    # è®¡ç®—ä¸Šå‡é€šé“
    channel_info = CalIndicators.ascending_channel(df)
    
    # è¾“å‡ºç»“æœ
    print("=== ä¸Šå‡é€šé“åˆ†æç»“æœ ===")
    print(f"æ–œç‡: {channel_info['beta']:.4f}")
    print(f"ä»Šæ—¥ä¸­è½´: {channel_info['mid_today']:.2f}")
    print(f"ä»Šæ—¥ä¸Šæ²¿: {channel_info['upper_today']:.2f}")
    print(f"ä»Šæ—¥ä¸‹æ²¿: {channel_info['lower_today']:.2f}")
    print(f"æ˜æ—¥é¢„æµ‹ä¸­è½´: {channel_info['mid_tomorrow']:.2f}")
    print(f"é€šé“çŠ¶æ€: {channel_info['channel_status']}")
    print(f"ç´¯è®¡æ¶¨å¹…: {channel_info['cumulative_gain']:.2%}")
    print(f"é”šç‚¹æ—¥æœŸ: {channel_info['anchor_date']}")
    print(f"é”šç‚¹ä»·æ ¼: {channel_info['anchor_price']:.2f}")

if __name__ == "__main__":
    main()
```

---

**æœ€åæ›´æ–°**: 2024å¹´12æœˆ19æ—¥  
**ç‰ˆæœ¬**: v1.0 