# 交易记录功能说明

## 概述

回测系统现在支持详细的交易记录功能，能够记录每一笔交易的详细信息，并保存到Excel报告的"交易记录"sheet中。

## 功能特性

### 1. 详细交易记录
每笔交易都会记录以下信息：
- **交易日期**: 交易发生的具体日期
- **交易动作**: BUY（买入）或SELL（卖出）
- **股票代码**: 交易的股票代码
- **交易数量**: 买入或卖出的股票数量
- **交易价格**: 交易时的股票价格
- **交易金额**: 交易的总金额
- **收益率**: 卖出时的收益率（买入时为N/A）
- **通道信息（交易记录sheet）**: 将在“收益率(%)”之后按固定顺序追加以下字段（若存在）：
  - 通道状态（NORMAL/BREAKOUT/BREAKDOWN）
  - 通道评分
  - 斜率β
  - R²
  - 今日中轴、今日上沿、今日下沿
  - 通道宽度：今日上沿-今日下沿（价格差，单位：元）
  - 距下沿(%)
- **资金状况**: 交易后的可用资金（若记录）

说明：数值类字段（价格、金额、收益率及通道数值）将统一保留两位小数展示，通道字段只会在策略提供相应数据时出现，且严格位于“收益率(%)”之后，便于阅读。

### 2. 自动记录
- 系统会自动记录所有买入和卖出交易
- 无需手动配置，集成在策略执行过程中
- 实时记录，确保数据准确性

### 3. Excel报告集成
- 交易记录自动保存到Excel报告的"交易记录"sheet
- 支持中文字段名，便于阅读和分析
- 包含完整的交易历史
- 新增：报告包含“每日收益”sheet，列包括：
  - 日期：交易日
  - 买入次数：当日BUY数量
  - 卖出次数：当日SELL数量
  - 今日收益率：基于组合当日收益（来自日频TimeReturn分析器）
  - 整体收益率：从回测开始至当日的累积收益率
  - 起始规则：当策略设置 `min_data_points` 时，“每日收益”会从策略实际生效日开始（跳过前 `min_data_points` 个交易日的记录）。

### 4. 交易分析表（Trade Analysis）
- "交易分析"sheet 会对买卖配对后的每笔交易追加通道信息，并提供两种通道宽度形态：
  - 通道宽度(绝对值)：买入当日（今日上沿 - 今日下沿），单位：元
  - 通道宽度(%)：[(买入当日今日上沿 - 今日下沿)/买入当日今日中轴] × 100
- **新增：总持仓交易日列**：在"收益率(%)"后添加"总持仓交易日"列，显示每笔交易从买入到卖出的持仓天数
  - 优先使用卖出交易记录中的持仓天数信息（如存在）
  - 如无持仓天数记录，则根据买入和卖出日期自动计算
  - 至少为1天，确保数据合理性

### 4. 报告目录管理
- **统一报告目录**: 所有回测报告都保存在项目根目录的 `backtest_reports/` 目录下
- **自动路径管理**: 系统自动使用绝对路径，避免在不同工作目录下运行时创建多个报告目录
- **文件命名规范**: 报告文件名包含策略名称、回测类型和时间戳，便于识别和管理

## 使用方法

### 1. 运行回测
```python
from backend.business.backtest.execution.rising_channel_backtest import RisingChannelBacktestRunner

# 创建回测运行器
runner = RisingChannelBacktestRunner(log_level=logging.INFO, environment="development")

# 运行回测
results = runner.run_basic_backtest()
```

### 2. 查看交易记录
```python
# 从回测结果中获取交易记录
trades = results.get('trades', [])

# 打印交易记录
for i, trade in enumerate(trades[:5]):  # 显示前5笔交易
    print(trade)
```

### 3. 通道信息透传
- 上升通道策略会在生成买入/卖出信号时将通道相关信息附加到信号中；
- 基类在记录交易时会把这些附加字段一并写入交易记录；
- 报告生成时会把上述通道字段放置在“收益率(%)”之后并格式化。

## 数据格式

### 交易记录数据结构
```python
{
    '交易日期': '2025-04-03',
    '交易动作': 'BUY',
    '股票代码': 'sh.600072',
    '交易数量': 16059,
    '交易价格': 12.45,
    '交易金额': 199934.55,
    '收益率(%)': None,  # 买入时为None
    '通道状态': 'NORMAL',
    '通道评分': 60.0,
    '当前资金': 800065.45,
    '总资产': 1000000.0,
    '当前持仓数量': 1
}
```

### 卖出交易记录
```python
{
    '交易日期': '2025-04-07',
    '交易动作': 'SELL',
    '股票代码': 'sh.600118',
    '交易数量': 7539,
    '交易价格': 9.65,
    '交易金额': 72751.35,
    '收益率(%)': -63.61,  # 卖出时显示收益率
    '通道状态': 'BREAKDOWN',
    '通道评分': 0.0,
    '当前资金': 872816.80,
    '总资产': 872816.80,
    '当前持仓数量': 4
}
```

## 故障排除

### 1. 报告生成失败
**问题**: "arg must be a list, tuple, 1-d array, or Series" 错误
**解决方案**: 
- 已修复DataFrame创建时的数据格式问题
- 添加了完整的错误处理和数据验证
- 确保所有数值都有正确的默认值

### 2. 报告目录问题
**问题**: 出现多个 `backtest_reports` 目录
**解决方案**:
- 已修复配置文件中的路径设置
- 使用绝对路径确保报告目录的一致性
- 所有报告现在都保存在项目根目录的 `backtest_reports/` 目录下

### 3. 交易记录为空
**可能原因**:
- 策略参数设置过于严格，没有产生交易信号
- 数据时间范围过短，没有足够的交易机会
- 通道分析器配置不当

**解决方案**:
- 检查策略参数设置
- 扩大数据时间范围
- 调整通道分析器参数

## 最佳实践

### 1. 参数配置
- 根据市场环境调整 `min_channel_score` 参数
- 合理设置 `max_positions` 控制持仓数量
- 调整 `gain_trigger` 和 `beta_delta` 优化交易时机

### 2. 数据分析
- 定期查看交易记录，分析策略表现
- 关注胜率和平均收益率
- 分析不同市场环境下的表现

### 3. 报告管理
- 定期清理旧的报告文件
- 为重要回测结果添加描述性文件名
- 备份重要的回测报告

## 更新日志

### v2.1 (2025-08-07)
- ✅ 修复报告生成失败问题
- ✅ 统一报告目录管理
- ✅ 增强交易记录功能
- ✅ 完善错误处理机制
- ✅ 优化Excel报告格式

### v2.0 (2025-08-05)
- ✅ 实现详细交易记录功能
- ✅ 集成Excel报告生成
- ✅ 支持中文字段名
- ✅ 添加交易统计分析 