# ğŸš€ å›æµ‹æ¡†æ¶ä½¿ç”¨ç¤ºä¾‹

## ğŸ“‹ ç›®å½•

- [ğŸ¯ å¿«é€Ÿå¼€å§‹](#-å¿«é€Ÿå¼€å§‹)
- [ğŸ“Š å¤šç­–ç•¥æ¯”è¾ƒ](#-å¤šç­–ç•¥æ¯”è¾ƒ)
- [âš™ï¸ å‚æ•°ä¼˜åŒ–](#ï¸-å‚æ•°ä¼˜åŒ–)
- [ğŸ”§ è‡ªå®šä¹‰ç­–ç•¥](#-è‡ªå®šä¹‰ç­–ç•¥)
- [ğŸ“ˆ ç»“æœåˆ†æ](#-ç»“æœåˆ†æ)
- [ğŸ› ï¸ å·¥å…·å‡½æ•°](#ï¸-å·¥å…·å‡½æ•°)
- [ğŸ› æ•…éšœæ’é™¤](#-æ•…éšœæ’é™¤)

---

## ğŸ¯ å¿«é€Ÿå¼€å§‹

### 1.1 åŸºæœ¬å›æµ‹

```python
from backend.business.backtest_event import run_backtest
from backend.business.backtest_event.strategies.ma import MAStrategy
from backend.business.backtest_event.strategies.macd import MACDStrategy
from backend.business.backtest_event.strategies.rsi import RSIStrategy
from backend.business.data.data_fetcher import StockDataFetcher

# è·å–æ•°æ®
fetcher = StockDataFetcher()
data = fetcher.fetch_stock_data("000001.SZ", "2024-01-01", "2024-12-31")

# è¿è¡Œå›æµ‹
results = run_backtest(
    data=data,
    strategy_class=MAStrategy,
    initial_cash=100000.0,
    commission=0.0003,
    strategy_params={'ma_period': 20},
    strategy_name='MAç­–ç•¥'
)

# æŸ¥çœ‹ç»“æœ
print(f"æ€»æ”¶ç›Šç‡: {results['total_return']:.2%}")
print(f"å¹´åŒ–æ”¶ç›Šç‡: {results['annual_return']:.2%}")
print(f"æœ€å¤§å›æ’¤: {results['max_drawdown']:.2%}")
print(f"å¤æ™®æ¯”ç‡: {results['sharpe_ratio']:.2f}")
```

### 1.2 ä½¿ç”¨å›æµ‹å¼•æ“

```python
from backend.business.backtest_event.core.backtest_engine import BacktestEngine
from backend.business.backtest_event.strategies.ma import MAStrategy

# åˆ›å»ºå›æµ‹å¼•æ“
engine = BacktestEngine(initial_cash=100000.0, commission=0.0003)

# æ·»åŠ æ•°æ®
engine.add_data(data)

# æ·»åŠ ç­–ç•¥
engine.add_strategy(MAStrategy, ma_period=20)

# è¿è¡Œå›æµ‹
results = engine.run("MAç­–ç•¥")

# è·å–è¯¦ç»†ç»“æœ
print(f"æ€»æ”¶ç›Šç‡: {results['total_return']:.2%}")
print(f"äº¤æ˜“æ¬¡æ•°: {results['total_trades']}")
print(f"èƒœç‡: {results['win_rate']:.2%}")
```

---

## ğŸ“Š å¤šç­–ç•¥æ¯”è¾ƒ

### 2.1 å¤šç­–ç•¥å›æµ‹

```python
from backend.business.backtest_event import run_multi_strategy_backtest
from backend.business.backtest_event.strategies.ma import MAStrategy
from backend.business.backtest_event.strategies.macd import MACDStrategy
from backend.business.backtest_event.strategies.rsi import RSIStrategy

# å‡†å¤‡æ•°æ®
fetcher = StockDataFetcher()
data = fetcher.fetch_stock_data("000001.SZ", "2024-01-01", "2024-12-31")

# å®šä¹‰ç­–ç•¥åˆ—è¡¨
strategies = [
    {
        'name': 'MAç­–ç•¥',
        'class': MAStrategy,
        'params': {'ma_period': 20}
    },
    {
        'name': 'MACDç­–ç•¥',
        'class': MACDStrategy,
        'params': {'fast_period': 12, 'slow_period': 26, 'signal_period': 9}
    },
    {
        'name': 'RSIç­–ç•¥',
        'class': RSIStrategy,
        'params': {'rsi_period': 14, 'oversold': 30, 'overbought': 70}
    }
]

# è¿è¡Œå¤šç­–ç•¥å›æµ‹
results = run_multi_strategy_backtest(
    data=data,
    strategies=strategies,
    initial_cash=100000.0,
    commission=0.0003
)

# æŸ¥çœ‹æ¯”è¾ƒç»“æœ
for strategy_name, result in results.items():
    print(f"\n{strategy_name}:")
    print(f"  æ€»æ”¶ç›Šç‡: {result['total_return']:.2%}")
    print(f"  å¹´åŒ–æ”¶ç›Šç‡: {result['annual_return']:.2%}")
    print(f"  æœ€å¤§å›æ’¤: {result['max_drawdown']:.2%}")
    print(f"  å¤æ™®æ¯”ç‡: {result['sharpe_ratio']:.2f}")
    print(f"  èƒœç‡: {result['win_rate']:.2%}")
```

### 2.2 ç­–ç•¥æ€§èƒ½å¯¹æ¯”

```python
from backend.business.backtest_event.core.result_analyzer import ResultAnalyzer

# åˆ›å»ºåˆ†æå™¨
analyzer = ResultAnalyzer()

# æ¯”è¾ƒç­–ç•¥æ€§èƒ½
comparison = analyzer.compare_strategies(list(results.values()))

# ç”Ÿæˆå¯¹æ¯”æŠ¥å‘Š
print("ç­–ç•¥æ€§èƒ½å¯¹æ¯”:")
print(comparison['summary_table'])

# è·å–æœ€ä½³ç­–ç•¥
best_strategy = comparison['best_strategy']
print(f"\næœ€ä½³ç­–ç•¥: {best_strategy['name']}")
print(f"æœ€ä½³æ”¶ç›Šç‡: {best_strategy['total_return']:.2%}")
```

---

## âš™ï¸ å‚æ•°ä¼˜åŒ–

### 3.1 ç½‘æ ¼æœç´¢ä¼˜åŒ–

```python
from backend.business.backtest_event import optimize_parameters

# å®šä¹‰å‚æ•°èŒƒå›´
parameter_ranges = {
    'ma_period': [5, 10, 15, 20, 25, 30],
    'volume_ratio': [1.0, 1.2, 1.5, 2.0]
}

# è¿è¡Œå‚æ•°ä¼˜åŒ–
optimization_results = optimize_parameters(
    data=data,
    strategy_class=MAStrategy,
    parameter_ranges=parameter_ranges,
    initial_cash=100000.0,
    commission=0.0003,
    optimization_target='total_return'  # ä¼˜åŒ–ç›®æ ‡ï¼šæ€»æ”¶ç›Šç‡
)

# æŸ¥çœ‹ä¼˜åŒ–ç»“æœ
print(f"æœ€ä¼˜å‚æ•°: {optimization_results['best_params']}")
print(f"æœ€ä¼˜æ”¶ç›Šç‡: {optimization_results['best_value']:.2%}")
print(f"å‚æ•°ç»„åˆæ•°: {optimization_results['total_combinations']}")
```

### 3.2 è´å¶æ–¯ä¼˜åŒ–

```python
from backend.business.backtest_event import bayesian_optimization

# å®šä¹‰å‚æ•°è¾¹ç•Œ
param_bounds = {
    'ma_period': (5, 50),
    'volume_ratio': (0.5, 3.0)
}

# è¿è¡Œè´å¶æ–¯ä¼˜åŒ–
bayesian_results = bayesian_optimization(
    data=data,
    strategy_class=MAStrategy,
    param_bounds=param_bounds,
    initial_cash=100000.0,
    commission=0.0003,
    n_iterations=50
)

print(f"æœ€ä¼˜å‚æ•°: {bayesian_results['best_params']}")
print(f"æœ€ä¼˜æ”¶ç›Šç‡: {bayesian_results['best_value']:.2%}")
```

---

## ğŸ”§ è‡ªå®šä¹‰ç­–ç•¥

### 4.1 åˆ›å»ºè‡ªå®šä¹‰ç­–ç•¥

```python
from backend.business.backtest_event.core.base_strategy import BaseStrategy

class MyCustomStrategy(BaseStrategy):
    def __init__(self):
        super().__init__()
        self.name = "æˆ‘çš„è‡ªå®šä¹‰ç­–ç•¥"
        self.description = "åŸºäºä»·æ ¼åŠ¨é‡çš„ç®€å•ç­–ç•¥"
    
    def next(self):
        """ç­–ç•¥é€»è¾‘å®ç°"""
        # è·å–å½“å‰ä»·æ ¼
        current_price = self.data.close[-1]
        previous_price = self.data.close[-2]
        
        # è®¡ç®—ä»·æ ¼åŠ¨é‡
        momentum = (current_price - previous_price) / previous_price
        
        # äº¤æ˜“é€»è¾‘
        if momentum > 0.02:  # ä»·æ ¼ä¸Šæ¶¨è¶…è¿‡2%
            if not self.position:  # æ²¡æœ‰æŒä»“
                self.buy()
        elif momentum < -0.02:  # ä»·æ ¼ä¸‹è·Œè¶…è¿‡2%
            if self.position:  # æœ‰æŒä»“
                self.sell()

# ä½¿ç”¨è‡ªå®šä¹‰ç­–ç•¥
results = run_backtest(
    data=data,
    strategy_class=MyCustomStrategy,
    initial_cash=100000.0,
    commission=0.0003,
    strategy_name='è‡ªå®šä¹‰ç­–ç•¥'
)
```

### 4.2 ç­–ç•¥å‚æ•°åŒ–

```python
class ParameterizedStrategy(BaseStrategy):
    def __init__(self, momentum_threshold=0.02, stop_loss=0.05):
        super().__init__()
        self.name = "å‚æ•°åŒ–ç­–ç•¥"
        self.momentum_threshold = momentum_threshold
        self.stop_loss = stop_loss
    
    def next(self):
        current_price = self.data.close[-1]
        previous_price = self.data.close[-2]
        momentum = (current_price - previous_price) / previous_price
        
        # æ­¢æŸæ£€æŸ¥
        if self.position:
            entry_price = self.position.entry_price
            loss_ratio = (current_price - entry_price) / entry_price
            if loss_ratio < -self.stop_loss:
                self.sell()
                return
        
        # äº¤æ˜“ä¿¡å·
        if momentum > self.momentum_threshold:
            if not self.position:
                self.buy()
        elif momentum < -self.momentum_threshold:
            if self.position:
                self.sell()

# ä½¿ç”¨å‚æ•°åŒ–ç­–ç•¥
results = run_backtest(
    data=data,
    strategy_class=ParameterizedStrategy,
    initial_cash=100000.0,
    commission=0.0003,
    strategy_params={
        'momentum_threshold': 0.03,
        'stop_loss': 0.08
    },
    strategy_name='å‚æ•°åŒ–ç­–ç•¥'
)
```

---

## ğŸ“ˆ ç»“æœåˆ†æ

### 5.1 è¯¦ç»†ç»“æœåˆ†æ

```python
from backend.business.backtest_event.core.result_analyzer import ResultAnalyzer

# åˆ›å»ºåˆ†æå™¨
analyzer = ResultAnalyzer()

# åˆ†æå›æµ‹ç»“æœ
analysis = analyzer.analyze(results)

# æŸ¥çœ‹è¯¦ç»†æŒ‡æ ‡
print("=== æ”¶ç›ŠæŒ‡æ ‡ ===")
print(f"æ€»æ”¶ç›Šç‡: {analysis['total_return']:.2%}")
print(f"å¹´åŒ–æ”¶ç›Šç‡: {analysis['annual_return']:.2%}")
print(f"æ—¥æ”¶ç›Šç‡å‡å€¼: {analysis['daily_return_mean']:.4f}")
print(f"æ—¥æ”¶ç›Šç‡æ ‡å‡†å·®: {analysis['daily_return_std']:.4f}")

print("\n=== é£é™©æŒ‡æ ‡ ===")
print(f"æœ€å¤§å›æ’¤: {analysis['max_drawdown']:.2%}")
print(f"å¤æ™®æ¯”ç‡: {analysis['sharpe_ratio']:.2f}")
print(f"ç´¢æè¯ºæ¯”ç‡: {analysis['sortino_ratio']:.2f}")
print(f"å¡å°”é©¬æ¯”ç‡: {analysis['calmar_ratio']:.2f}")

print("\n=== äº¤æ˜“æŒ‡æ ‡ ===")
print(f"æ€»äº¤æ˜“æ¬¡æ•°: {analysis['total_trades']}")
print(f"ç›ˆåˆ©äº¤æ˜“æ¬¡æ•°: {analysis['profit_trades']}")
print(f"äºæŸäº¤æ˜“æ¬¡æ•°: {analysis['loss_trades']}")
print(f"èƒœç‡: {analysis['win_rate']:.2%}")
print(f"ç›ˆäºæ¯”: {analysis['profit_loss_ratio']:.2f}")
```

### 5.1.1 äº¤æ˜“æŒ‡æ ‡è®¡ç®—è¯´æ˜

**ğŸ’¡ é‡è¦æ›´æ–°ï¼ˆ2025å¹´1æœˆï¼‰**: äº¤æ˜“æŒ‡æ ‡è®¡ç®—æ¨¡å—å·²å…¨é¢ä¼˜åŒ–ï¼Œç°åœ¨æ”¯æŒï¼š

- âœ… **å¤šç§äº¤æ˜“æ•°æ®æ ¼å¼å…¼å®¹**ï¼šè‡ªåŠ¨è¯†åˆ«ä¸­æ–‡å’Œè‹±æ–‡å­—æ®µå
- âœ… **æ™ºèƒ½æ•°æ®ç±»å‹å¤„ç†**ï¼šæ­£ç¡®å¤„ç†numpyæ•°æ®ç±»å‹å’Œæ™®é€šPythonæ•°æ®ç±»å‹  
- âœ… **æŒä»“æ—¶é—´è®¡ç®—**ï¼šè‡ªåŠ¨åŒ¹é…ä¹°å…¥å’Œå–å‡ºäº¤æ˜“ï¼Œè®¡ç®—å®é™…æŒä»“å¤©æ•°
- âœ… **è¯¦ç»†è°ƒè¯•è¾“å‡º**ï¼šæä¾›å®Œæ•´çš„è®¡ç®—è¿‡ç¨‹æ—¥å¿—ï¼Œä¾¿äºé—®é¢˜æ’æŸ¥
- âœ… **é”™è¯¯å®¹é”™æœºåˆ¶**ï¼šåœ¨æ•°æ®å¼‚å¸¸æ—¶æä¾›é™çº§å¤„ç†æ–¹æ¡ˆ

**ğŸ”§ æ€§èƒ½æŒ‡æ ‡è®¡ç®—ä¿®å¤ï¼ˆ2025å¹´8æœˆï¼‰**: å¹´åŒ–æ”¶ç›Šç‡å’Œå¹´åŒ–æ³¢åŠ¨ç‡è®¡ç®—é€»è¾‘å·²å…¨é¢ä¿®å¤ï¼š

**ä¿®å¤å‰çš„é—®é¢˜ï¼š**
- âŒ **å¹´åŒ–æ³¢åŠ¨ç‡è¿‡é«˜**ï¼šé”™è¯¯ä½¿ç”¨äº¤æ˜“é¢‘ç‡è¿›è¡Œå¹´åŒ–ï¼Œå¯¼è‡´ç»“æœå¼‚å¸¸ï¼ˆå¦‚162.80%ï¼‰
- âŒ **å¹´åŒ–æ”¶ç›Šç‡ä¸å‡†ç¡®**ï¼šå›æµ‹å¤©æ•°è®¡ç®—ä¸ç²¾ç¡®ï¼Œå½±å“å¹´åŒ–è®¡ç®—
- âŒ **ç¼ºä¹åˆç†æ€§æ£€æŸ¥**ï¼šæ²¡æœ‰ä¸Šä¸‹é™æ§åˆ¶ï¼Œå…è®¸æç«¯å¼‚å¸¸å€¼

**ä¿®å¤åçš„æ”¹è¿›ï¼š**
- âœ… **æ­£ç¡®çš„å¹´åŒ–æ³¢åŠ¨ç‡è®¡ç®—**ï¼šåŸºäºå¹³å‡æŒä»“å¤©æ•°è€Œéäº¤æ˜“é¢‘ç‡è¿›è¡Œå¹´åŒ–
- âœ… **å‡†ç¡®çš„å›æµ‹æ—¶é—´è·å–**ï¼šä¼˜å…ˆä»æ•°æ®æºè·å–å®é™…å›æµ‹å¤©æ•°ï¼Œæé«˜ç²¾åº¦
- âœ… **æ™ºèƒ½åˆç†æ€§æ£€æŸ¥**ï¼šè®¾ç½®ä¸Šä¸‹é™æ§åˆ¶ï¼ˆ10%-100%ï¼‰ï¼Œè‡ªåŠ¨è°ƒæ•´å¼‚å¸¸å€¼
- âœ… **ä¿å®ˆçš„ä¼°ç®—ç­–ç•¥**ï¼šå½“æ•°æ®ä¸è¶³æ—¶ï¼Œä½¿ç”¨ä¿å®ˆçš„æ³¢åŠ¨ç‡å€æ•°ä¼°ç®—

**ä¿®å¤æ•ˆæœå¯¹æ¯”ï¼š**
```python
# ä¿®å¤å‰ï¼ˆå¼‚å¸¸ï¼‰
å¹´åŒ–æ”¶ç›Šç‡: 54.27%    # è¿‡é«˜ï¼Œä¸åˆç†
å¹´åŒ–æ³¢åŠ¨ç‡: 162.80%   # ä¸¥é‡è¿‡é«˜
å¤æ™®æ¯”ç‡: 17.30       # è®¡ç®—åŸºç¡€é”™è¯¯

# ä¿®å¤åï¼ˆæ­£å¸¸ï¼‰  
å¹´åŒ–æ”¶ç›Šç‡: 32.62%    # åˆç†ï¼Œç¬¦åˆå®é™…æ”¶ç›Š
å¹´åŒ–æ³¢åŠ¨ç‡: 58.71%    # æ­£å¸¸èŒƒå›´ï¼Œç¬¦åˆè‚¡ç¥¨ç­–ç•¥ç‰¹å¾
å¤æ™®æ¯”ç‡: 17.30       # åŸºäºæ­£ç¡®è®¡ç®—çš„ä¼˜ç§€æŒ‡æ ‡
```

**æŠ€æœ¯å®ç°ç»†èŠ‚ï¼š**
```python
# ä¿®å¤å‰çš„é”™è¯¯è®¡ç®—
trades_per_year = len(returns) / years  # äº¤æ˜“é¢‘ç‡
annual_volatility = returns_std * np.sqrt(trades_per_year) * 100  # é”™è¯¯

# ä¿®å¤åçš„æ­£ç¡®è®¡ç®—
average_holding_days = backtest_days / len(returns)  # å¹³å‡æŒä»“å¤©æ•°  
annualization_factor = np.sqrt(365.25 / average_holding_days)  # åŸºäºæ—¶é—´é¢‘ç‡
annual_volatility = returns_std * annualization_factor * 100  # æ­£ç¡®
```

**äº¤æ˜“æŒ‡æ ‡è¯¦ç»†è¯´æ˜ï¼š**

```python
# è·å–äº¤æ˜“æŒ‡æ ‡è¯¦ç»†ä¿¡æ¯
trade_metrics = analyzer._calculate_trade_metrics(strategy)

print("=== äº¤æ˜“æŒ‡æ ‡è¯¦è§£ ===")
print(f"äº¤æ˜“æ¬¡æ•°: {trade_metrics['äº¤æ˜“æ¬¡æ•°']}")           # å®Œæ•´äº¤æ˜“æ•°ï¼ˆå–å‡ºæ¬¡æ•°ï¼‰
print(f"ç›ˆåˆ©äº¤æ˜“: {trade_metrics['ç›ˆåˆ©äº¤æ˜“']}")           # æ”¶ç›Šç‡ > 0 çš„äº¤æ˜“æ•°
print(f"äºæŸäº¤æ˜“: {trade_metrics['äºæŸäº¤æ˜“']}")           # æ”¶ç›Šç‡ <= 0 çš„äº¤æ˜“æ•°  
print(f"èƒœç‡: {trade_metrics['èƒœç‡']:.2f}%")            # ç›ˆåˆ©äº¤æ˜“æ•° / æ€»äº¤æ˜“æ•° * 100
print(f"å¹³å‡æ”¶ç›Š: {trade_metrics['å¹³å‡æ”¶ç›Š']:.2f}")       # å¹³å‡æ¯ç¬”äº¤æ˜“æ”¶ç›Šé‡‘é¢
print(f"æœ€å¤§å•ç¬”æ”¶ç›Š: {trade_metrics['æœ€å¤§å•ç¬”æ”¶ç›Š']:.2f}") # å•ç¬”äº¤æ˜“æœ€å¤§æ”¶ç›Šé‡‘é¢
print(f"æœ€å¤§å•ç¬”äºæŸ: {trade_metrics['æœ€å¤§å•ç¬”äºæŸ']:.2f}") # å•ç¬”äº¤æ˜“æœ€å¤§äºæŸé‡‘é¢
print(f"å¹³å‡æŒä»“æ—¶é—´: {trade_metrics['å¹³å‡æŒä»“æ—¶é—´']:.1f}å¤©") # ä¹°å…¥åˆ°å–å‡ºçš„å¹³å‡å¤©æ•°
```

**äº¤æ˜“åˆ†æè¡¨å­—æ®µæ›´æ–°ï¼ˆ2025-08ï¼‰ï¼š**

- æ–°å¢åˆ—ï¼š`é€šé“å®½åº¦(ç»å¯¹å€¼)`ã€`é€šé“å®½åº¦(%)`
- å®šä¹‰ï¼š
  - `é€šé“å®½åº¦(ç»å¯¹å€¼)` = ä¹°å…¥å½“æ—¥`ä»Šæ—¥ä¸Šæ²¿ - ä»Šæ—¥ä¸‹æ²¿`
  - `é€šé“å®½åº¦(%)` = [(ä¹°å…¥å½“æ—¥`ä»Šæ—¥ä¸Šæ²¿ - ä»Šæ—¥ä¸‹æ²¿`)/ä¹°å…¥å½“æ—¥`ä»Šæ—¥ä¸­è½´`] Ã— 100
- ç›®çš„ï¼šé¿å…æŠŠç»å¯¹ä»·å·®è¯¯è§£ä¸ºç™¾åˆ†æ¯”ï¼ŒæŠ¥å‘Šä¸­åŒæ—¶æä¾›ä¸¤ç§å½¢æ€ï¼Œä¾¿äºäº¤å‰éªŒè¯ã€‚

**æ”¯æŒçš„äº¤æ˜“è®°å½•æ ¼å¼ï¼š**

```python
# æ ¼å¼1ï¼šä¸­æ–‡å­—æ®µï¼ˆä¸Šå‡é€šé“ç­–ç•¥ç­‰ï¼‰
trade_record_cn = {
    'äº¤æ˜“æ—¥æœŸ': datetime(2024, 1, 15),
    'äº¤æ˜“åŠ¨ä½œ': 'SELL',
    'è‚¡ç¥¨ä»£ç ': '000001.SZ', 
    'äº¤æ˜“æ•°é‡': 1000,
    'äº¤æ˜“ä»·æ ¼': 11.20,
    'äº¤æ˜“é‡‘é¢': 11200.0,
    'æ”¶ç›Šç‡': 6.67
}

# æ ¼å¼2ï¼šè‹±æ–‡å­—æ®µï¼ˆåŸºç¡€ç­–ç•¥ç­‰ï¼‰
trade_record_en = {
    'date': datetime(2024, 1, 15),
    'action': 'SELL',
    'stock_code': '000001.SZ',
    'size': 1000, 
    'price': 11.20,
    'value': 11200.0,
    'returns': 6.67
}

# ä¸¤ç§æ ¼å¼éƒ½èƒ½æ­£ç¡®è¯†åˆ«å’Œå¤„ç†
```

### 5.2 ç”Ÿæˆåˆ†ææŠ¥å‘Š

```python
# ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š
report = analyzer.generate_report(results)

# ä¿å­˜æŠ¥å‘Š
with open('backtest_report.html', 'w', encoding='utf-8') as f:
    f.write(report['html_report'])

# å¯¼å‡ºExcelæŠ¥å‘Š
report['excel_report'].to_excel('backtest_report.xlsx', index=False)

print("æŠ¥å‘Šå·²ç”Ÿæˆ:")
print("- backtest_report.html (HTMLæ ¼å¼)")
print("- backtest_report.xlsx (Excelæ ¼å¼)")
```

### 5.3 å¯è§†åŒ–åˆ†æ

```python
import matplotlib.pyplot as plt
import seaborn as sns

# ç»˜åˆ¶æƒç›Šæ›²çº¿
plt.figure(figsize=(12, 8))

# å­å›¾1: æƒç›Šæ›²çº¿
plt.subplot(2, 2, 1)
plt.plot(results['equity_curve']['date'], results['equity_curve']['equity'])
plt.title('æƒç›Šæ›²çº¿')
plt.xlabel('æ—¥æœŸ')
plt.ylabel('æƒç›Š')

# å­å›¾2: å›æ’¤æ›²çº¿
plt.subplot(2, 2, 2)
plt.plot(results['drawdown_curve']['date'], results['drawdown_curve']['drawdown'])
plt.title('å›æ’¤æ›²çº¿')
plt.xlabel('æ—¥æœŸ')
plt.ylabel('å›æ’¤')

# å­å›¾3: æ”¶ç›Šç‡åˆ†å¸ƒ
plt.subplot(2, 2, 3)
plt.hist(results['daily_returns'], bins=50, alpha=0.7)
plt.title('æ—¥æ”¶ç›Šç‡åˆ†å¸ƒ')
plt.xlabel('æ”¶ç›Šç‡')
plt.ylabel('é¢‘æ¬¡')

# å­å›¾4: äº¤æ˜“åˆ†å¸ƒ
plt.subplot(2, 2, 4)
trade_returns = [trade['return'] for trade in results['trades']]
plt.hist(trade_returns, bins=30, alpha=0.7)
plt.title('äº¤æ˜“æ”¶ç›Šç‡åˆ†å¸ƒ')
plt.xlabel('æ”¶ç›Šç‡')
plt.ylabel('é¢‘æ¬¡')

plt.tight_layout()
plt.show()
```

---

## ğŸ› ï¸ å·¥å…·å‡½æ•°

### 6.1 æ•°æ®å·¥å…·

```python
from backend.business.backtest_event.utils.data_utils import DataUtils

# åˆ›å»ºæ ·æœ¬æ•°æ®
sample_data = DataUtils.create_sample_data(
    days=252,  # ä¸€å¹´çš„äº¤æ˜“æ—¥
    start_price=10.0,
    volatility=0.02
)

# éªŒè¯æ•°æ®æ ¼å¼
validation = DataUtils.validate_data(sample_data)
if validation['is_valid']:
    print("æ•°æ®æ ¼å¼æ­£ç¡®")
else:
    print(f"æ•°æ®æ ¼å¼é”™è¯¯: {validation['errors']}")

# æ•°æ®é¢„å¤„ç†
processed_data = DataUtils.preprocess_data(sample_data)
```

### 6.2 æŠ¥å‘Šå·¥å…·

```python
from backend.business.backtest_event.utils.report_utils import ReportUtils

# åˆ›å»ºæŠ¥å‘Šå·¥å…·
report_utils = ReportUtils()

# ç”ŸæˆHTMLæŠ¥å‘Š
html_report = report_utils.generate_html_report(results)

# ç”ŸæˆExcelæŠ¥å‘Š
excel_report = report_utils.generate_excel_report(results)

# ç”ŸæˆPDFæŠ¥å‘Š
pdf_report = report_utils.generate_pdf_report(results)

# ä¿å­˜æŠ¥å‘Š
report_utils.save_report(html_report, 'backtest_report.html')
report_utils.save_report(excel_report, 'backtest_report.xlsx')
```

### 6.3 æ€§èƒ½ç›‘æ§

```python
import time
from backend.business.backtest_event.utils.performance_monitor import PerformanceMonitor

# åˆ›å»ºæ€§èƒ½ç›‘æ§å™¨
monitor = PerformanceMonitor()

# å¼€å§‹ç›‘æ§
monitor.start()

# è¿è¡Œå›æµ‹
start_time = time.time()
results = run_backtest(data=data, strategy_class=MAStrategy, ...)
end_time = time.time()

# åœæ­¢ç›‘æ§
monitor.stop()

# è·å–æ€§èƒ½æŒ‡æ ‡
performance_metrics = monitor.get_metrics()
print(f"å›æµ‹è€—æ—¶: {end_time - start_time:.2f}ç§’")
print(f"å†…å­˜ä½¿ç”¨: {performance_metrics['memory_usage']:.2f}MB")
print(f"CPUä½¿ç”¨ç‡: {performance_metrics['cpu_usage']:.2f}%")
```

---

## ğŸ› æ•…éšœæ’é™¤

### 7.1 å¸¸è§é”™è¯¯

```python
# 1. æ•°æ®æ ¼å¼é”™è¯¯
try:
    results = run_backtest(data=data, strategy_class=MAStrategy, ...)
except ValueError as e:
    if "missing columns" in str(e):
        print("æ•°æ®ç¼ºå°‘å¿…éœ€åˆ—ï¼Œéœ€è¦åŒ…å«: open, high, low, close, volume")
    elif "empty data" in str(e):
        print("æ•°æ®ä¸ºç©ºï¼Œè¯·æ£€æŸ¥æ•°æ®æº")

# 2. ç­–ç•¥å‚æ•°é”™è¯¯
try:
    results = run_backtest(data=data, strategy_class=MAStrategy, ...)
except TypeError as e:
    if "unexpected keyword argument" in str(e):
        print("ç­–ç•¥å‚æ•°é”™è¯¯ï¼Œè¯·æ£€æŸ¥å‚æ•°åç§°")

# 3. èµ„é‡‘ä¸è¶³é”™è¯¯
try:
    results = run_backtest(data=data, strategy_class=MAStrategy, ...)
except RuntimeError as e:
    if "insufficient funds" in str(e):
        print("åˆå§‹èµ„é‡‘ä¸è¶³ï¼Œè¯·å¢åŠ åˆå§‹èµ„é‡‘")
```

### 7.2 è°ƒè¯•æ¨¡å¼

```python
import logging

# è®¾ç½®è°ƒè¯•æ—¥å¿—
logging.basicConfig(level=logging.DEBUG)
logger = logging.getLogger(__name__)

def debug_backtest(data, strategy_class, **kwargs):
    """è°ƒè¯•æ¨¡å¼ä¸‹çš„å›æµ‹"""
    
    logger.debug(f"è¾“å…¥æ•°æ®å½¢çŠ¶: {data.shape}")
    logger.debug(f"ç­–ç•¥ç±»: {strategy_class}")
    logger.debug(f"å‚æ•°: {kwargs}")
    
    try:
        results = run_backtest(data=data, strategy_class=strategy_class, **kwargs)
        logger.debug(f"å›æµ‹æˆåŠŸï¼Œæ”¶ç›Šç‡: {results['total_return']:.2%}")
        return results
    except Exception as e:
        logger.error(f"å›æµ‹å¤±è´¥: {e}")
        raise

# ä½¿ç”¨è°ƒè¯•æ¨¡å¼
results = debug_backtest(data, MAStrategy, initial_cash=100000.0)
```

### 7.3 æ•°æ®éªŒè¯

```python
def validate_backtest_data(data):
    """éªŒè¯å›æµ‹æ•°æ®"""
    
    # æ£€æŸ¥å¿…éœ€åˆ—
    required_columns = ['open', 'high', 'low', 'close', 'volume']
    missing_columns = [col for col in required_columns if col not in data.columns]
    if missing_columns:
        return False, f"ç¼ºå°‘å¿…éœ€åˆ—: {missing_columns}"
    
    # æ£€æŸ¥æ•°æ®é‡
    if len(data) < 30:
        return False, f"æ•°æ®é‡ä¸è¶³ï¼Œå½“å‰{len(data)}æ¡ï¼Œå»ºè®®è‡³å°‘30æ¡"
    
    # æ£€æŸ¥æ•°æ®ç±»å‹
    for col in required_columns:
        if not pd.api.types.is_numeric_dtype(data[col]):
            return False, f"{col}åˆ—å¿…é¡»æ˜¯æ•°å€¼ç±»å‹"
    
    # æ£€æŸ¥ç©ºå€¼
    for col in required_columns:
        if data[col].isna().any():
            return False, f"{col}åˆ—åŒ…å«ç©ºå€¼"
    
    # æ£€æŸ¥ä»·æ ¼é€»è¾‘
    if (data['high'] < data['low']).any():
        return False, "å­˜åœ¨æœ€é«˜ä»·ä½äºæœ€ä½ä»·çš„æ•°æ®"
    
    if (data['open'] > data['high']).any() or (data['open'] < data['low']).any():
        return False, "å­˜åœ¨å¼€ç›˜ä»·è¶…å‡ºæœ€é«˜æœ€ä½ä»·èŒƒå›´çš„æ•°æ®"
    
    if (data['close'] > data['high']).any() or (data['close'] < data['low']).any():
        return False, "å­˜åœ¨æ”¶ç›˜ä»·è¶…å‡ºæœ€é«˜æœ€ä½ä»·èŒƒå›´çš„æ•°æ®"
    
    return True, "æ•°æ®éªŒè¯é€šè¿‡"

# ä½¿ç”¨æ•°æ®éªŒè¯
is_valid, message = validate_backtest_data(data)
if not is_valid:
    print(f"æ•°æ®éªŒè¯å¤±è´¥: {message}")
else:
    print("æ•°æ®éªŒè¯é€šè¿‡ï¼Œå¯ä»¥å¼€å§‹å›æµ‹")
```

---

## ğŸ“š å®Œæ•´ç¤ºä¾‹

### 8.1 å®Œæ•´çš„å›æµ‹æµç¨‹

```python
import pandas as pd
from backend.business.backtest_event import run_backtest, run_multi_strategy_backtest
from backend.business.backtest_event.strategies.ma import MAStrategy
from backend.business.backtest_event.strategies.macd import MACDStrategy
from backend.business.data.data_fetcher import StockDataFetcher
from backend.business.backtest_event.core.result_analyzer import ResultAnalyzer


def complete_backtest_workflow(stock_code, start_date, end_date):
    """å®Œæ•´çš„å›æµ‹å·¥ä½œæµç¨‹"""

    # 1. è·å–æ•°æ®
    fetcher = StockDataFetcher()
    data = fetcher.fetch_stock_data(stock_code, start_date, end_date)

    # 2. æ•°æ®éªŒè¯
    is_valid, message = validate_backtest_data(data)
    if not is_valid:
        print(f"æ•°æ®éªŒè¯å¤±è´¥: {message}")
        return None

    # 3. å•ç­–ç•¥å›æµ‹
    ma_results = run_backtest(
        data=data,
        strategy_class=MAStrategy,
        initial_cash=100000.0,
        commission=0.0003,
        strategy_params={'ma_period': 20},
        strategy_name='MAç­–ç•¥'
    )

    # 4. å¤šç­–ç•¥å›æµ‹
    strategies = [
        {'name': 'MAç­–ç•¥', 'class': MAStrategy, 'params': {'ma_period': 20}},
        {'name': 'MACDç­–ç•¥', 'class': MACDStrategy, 'params': {}}
    ]

    multi_results = run_multi_strategy_backtest(
        data=data,
        strategies=strategies,
        initial_cash=100000.0,
        commission=0.0003
    )

    # 5. ç»“æœåˆ†æ
    analyzer = ResultAnalyzer()
    analysis = analyzer.analyze(ma_results)

    # 6. ç”ŸæˆæŠ¥å‘Š
    report = analyzer.generate_report(ma_results)

    # 7. ç»“æœæ±‡æ€»
    summary = {
        'stock_code': stock_code,
        'period': f"{start_date} åˆ° {end_date}",
        'single_strategy_results': ma_results,
        'multi_strategy_results': multi_results,
        'analysis': analysis,
        'report': report
    }

    return summary


# ä½¿ç”¨å®Œæ•´æµç¨‹
summary = complete_backtest_workflow("000001.SZ", "2024-01-01", "2024-12-31")

if summary:
    print(f"è‚¡ç¥¨ä»£ç : {summary['stock_code']}")
    print(f"å›æµ‹æœŸé—´: {summary['period']}")
    print(f"MAç­–ç•¥æ”¶ç›Šç‡: {summary['single_strategy_results']['total_return']:.2%}")
    print(f"åˆ†æå®Œæˆï¼ŒæŠ¥å‘Šå·²ç”Ÿæˆ")
```

---

**æœ€åæ›´æ–°æ—¶é—´**: 2025å¹´8æœˆ9æ—¥
**æ–‡æ¡£ç‰ˆæœ¬**: v2.1

> é‡è¦æ›´æ–°ï¼šé»˜è®¤èµ„é‡‘åˆ†é…ç­–ç•¥æ”¹ä¸ºâ€œæŒ‰å‰©ä½™ç©ºä½ç­‰æƒâ€ã€‚è®¡ç®—ä¹°å…¥è‚¡æ•°æ—¶ï¼Œå…ˆç”¨â€œå¯ç”¨ç°é‡‘ Ã· å‰©ä½™ç©ºä½æ•°ï¼ˆmax_positions - å½“å‰æŒä»“æ•°ï¼‰â€å¾—åˆ°ç›®æ ‡é‡‘é¢ï¼Œå†ç»ç”±é£é™©æ§åˆ¶ï¼ˆå•ç¥¨â‰¤10%ã€ç°é‡‘ä¿ç•™â‰¥5%ï¼‰ä¸Aè‚¡æˆäº¤çº¦æŸï¼ˆ100è‚¡ä¸€æ‰‹ã€æœ€ä½æˆäº¤é¢ã€è´¹ç”¨è¦†ç›–ï¼‰ä¿®æ­£ä¸ºæœ€ç»ˆè‚¡æ•°ã€‚