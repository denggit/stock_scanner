# å›æµ‹ç³»ç»Ÿä½¿ç”¨ç¤ºä¾‹

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0  
**æœ€åæ›´æ–°æ—¶é—´**: 2025å¹´8æœˆ5æ—¥

## ğŸ“‹ æ¦‚è¿°

æœ¬å›æµ‹ç³»ç»ŸåŸºäº `backtrader` æ„å»ºï¼Œé‡‡ç”¨è®¾è®¡æ¨¡å¼è®¾è®¡ï¼Œæä¾›çµæ´»ã€é«˜æ•ˆçš„å›æµ‹åŠŸèƒ½ã€‚æ”¯æŒå•ç­–ç•¥å›æµ‹ã€å¤šç­–ç•¥å¯¹æ¯”ã€å‚æ•°ä¼˜åŒ–ç­‰å¤šç§åœºæ™¯ã€‚

**æ ¸å¿ƒç‰¹ç‚¹ï¼š**

- âœ… **è®¾è®¡æ¨¡å¼é©±åŠ¨**ï¼šä½¿ç”¨ç­–ç•¥æ¨¡å¼ã€å·¥å‚æ¨¡å¼ç­‰è®¾è®¡æ¨¡å¼
- âœ… **çµæ´»æ‰©å±•**ï¼šæ˜“äºæ·»åŠ æ–°çš„äº¤æ˜“ç­–ç•¥
- âœ… **å¤šç§å›æµ‹æ¨¡å¼**ï¼šå•ç­–ç•¥ã€å¤šç­–ç•¥ã€å‚æ•°ä¼˜åŒ–
- âœ… **å®Œæ•´åˆ†æ**ï¼šæä¾›è¯¦ç»†çš„æ€§èƒ½æŒ‡æ ‡å’Œé£é™©åˆ†æ
- âœ… **å¯è§†åŒ–æ”¯æŒ**ï¼šæ”¯æŒå›¾è¡¨ç»˜åˆ¶å’Œç»“æœå±•ç¤º

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. åŸºç¡€å•ç­–ç•¥å›æµ‹

```python
import pandas as pd
from backend.business.backtest_event import run_backtest, MAStrategy
from backend.business.data.data_fetcher import StockDataFetcher

# è·å–è‚¡ç¥¨æ•°æ®
fetcher = StockDataFetcher()
df = fetcher.fetch_stock_data('sh.600900', start_date='2024-01-01', end_date='2024-12-31')

# è¿è¡Œç®€å•å›æµ‹
results = run_backtest(
    data=df,
    strategy_class=MAStrategy,
    initial_cash=100000,
    commission=0.0003,
    strategy_params={'short_period': 10, 'long_period': 30},
    strategy_name="MAç­–ç•¥",
    plot=True
)

print(f"æ€»æ”¶ç›Šç‡: {results['summary']['total_return']:.2%}")
print(f"å¤æ™®æ¯”ç‡: {results['summary']['sharpe_ratio']:.2f}")
print(f"æœ€å¤§å›æ’¤: {results['summary']['max_drawdown']:.2%}")
```

### 2. ä½¿ç”¨ä¾¿æ·å‡½æ•°

```python
from backend.business.backtest_event import run_backtest, MAStrategy, RSIStrategy

# è·å–æ•°æ®
df = fetcher.fetch_stock_data('sh.600900', start_date='2024-01-01', end_date='2024-12-31')

# è¿è¡ŒMAç­–ç•¥å›æµ‹
ma_results = run_backtest(
    data=df,
    strategy_class=MAStrategy,
    strategy_params={'short_period': 5, 'long_period': 20},
    strategy_name="çŸ­æœŸMAç­–ç•¥"
)

# è¿è¡ŒRSIç­–ç•¥å›æµ‹
rsi_results = run_backtest(
    data=df,
    strategy_class=RSIStrategy,
    strategy_params={'rsi_period': 14, 'oversold': 30, 'overbought': 70},
    strategy_name="RSIç­–ç•¥"
)

# å¯¹æ¯”ç»“æœ
print("MAç­–ç•¥æ”¶ç›Šç‡:", f"{ma_results['summary']['total_return']:.2%}")
print("RSIç­–ç•¥æ”¶ç›Šç‡:", f"{rsi_results['summary']['total_return']:.2%}")
```

## ğŸ”§ é«˜çº§åŠŸèƒ½

### 1. å¤šç­–ç•¥å›æµ‹

```python
from backend.business.backtest_event import run_multi_strategy_backtest

# å®šä¹‰å¤šä¸ªç­–ç•¥
strategies = [
    {
        'name': 'MAç­–ç•¥',
        'class': MAStrategy,
        'params': {'short_period': 10, 'long_period': 30}
    },
    {
        'name': 'RSIç­–ç•¥',
        'class': RSIStrategy,
        'params': {'rsi_period': 14, 'oversold': 30, 'overbought': 70}
    },
    {
        'name': 'MACDç­–ç•¥',
        'class': MACDStrategy,
        'params': {'fast_period': 12, 'slow_period': 26, 'signal_period': 9}
    }
]

# è¿è¡Œå¤šç­–ç•¥å›æµ‹
multi_results = run_multi_strategy_backtest(
    data=df,
    strategies=strategies,
    initial_cash=100000,
    commission=0.0003
)

# æŸ¥çœ‹å„ç­–ç•¥è¡¨ç°
for strategy_name, result in multi_results['strategies'].items():
    print(f"{strategy_name}: {result['summary']['total_return']:.2%}")
```

### 2. å‚æ•°ä¼˜åŒ–

```python
from backend.business.backtest_event import optimize_parameters

# å®šä¹‰å‚æ•°èŒƒå›´
parameter_ranges = {
    'short_period': [5, 10, 15, 20],
    'long_period': [20, 30, 40, 50]
}

# è¿è¡Œå‚æ•°ä¼˜åŒ–
optimization_results = optimize_parameters(
    data=df,
    strategy_class=MAStrategy,
    parameter_ranges=parameter_ranges,
    initial_cash=100000,
    commission=0.0003,
    optimization_target="æ€»æ”¶ç›Šç‡"
)

# æŸ¥çœ‹æœ€ä¼˜å‚æ•°
best_params = optimization_results['best_parameters']
best_return = optimization_results['best_return']
print(f"æœ€ä¼˜å‚æ•°: {best_params}")
print(f"æœ€ä¼˜æ”¶ç›Šç‡: {best_return:.2%}")
```

### 3. è‡ªå®šä¹‰ç­–ç•¥å¼€å‘

```python
from backend.business.backtest_event.core.base_strategy import BaseStrategy
import backtrader as bt

class MyCustomStrategy(BaseStrategy):
    """è‡ªå®šä¹‰ç­–ç•¥ç¤ºä¾‹"""
    
    def __init__(self, ma_period=20, rsi_period=14):
        super().__init__()
        
        # æŠ€æœ¯æŒ‡æ ‡
        self.ma = bt.indicators.SMA(self.dataclose, period=ma_period)
        self.rsi = bt.indicators.RSI(self.dataclose, period=rsi_period)
        
        # ç­–ç•¥å‚æ•°
        self.ma_period = ma_period
        self.rsi_period = rsi_period
    
    def next(self):
        """ç­–ç•¥é€»è¾‘"""
        if self.order:
            return
            
        if not self.position:
            # ä¹°å…¥æ¡ä»¶ï¼šä»·æ ¼åœ¨å‡çº¿ä¸Šæ–¹ä¸”RSI < 70
            if (self.dataclose[0] > self.ma[0] and 
                self.rsi[0] < 70):
                self.execute_buy()
        else:
            # å–å‡ºæ¡ä»¶ï¼šä»·æ ¼è·Œç ´å‡çº¿æˆ–RSI > 80
            if (self.dataclose[0] < self.ma[0] or 
                self.rsi[0] > 80):
                self.execute_sell()
    
    def _get_parameters(self):
        """è·å–ç­–ç•¥å‚æ•°"""
        return {
            'ma_period': self.ma_period,
            'rsi_period': self.rsi_period
        }

# ä½¿ç”¨è‡ªå®šä¹‰ç­–ç•¥
custom_results = run_backtest(
    data=df,
    strategy_class=MyCustomStrategy,
    strategy_params={'ma_period': 20, 'rsi_period': 14},
    strategy_name="è‡ªå®šä¹‰ç­–ç•¥"
)
```

## ğŸ“Š ç»“æœåˆ†æ

### 1. åŸºç¡€æ€§èƒ½æŒ‡æ ‡

```python
def analyze_results(results):
    """åˆ†æå›æµ‹ç»“æœ"""
    summary = results['summary']
    
    print("=== å›æµ‹ç»“æœåˆ†æ ===")
    print(f"æ€»æ”¶ç›Šç‡: {summary['total_return']:.2%}")
    print(f"å¹´åŒ–æ”¶ç›Šç‡: {summary['annual_return']:.2%}")
    print(f"å¤æ™®æ¯”ç‡: {summary['sharpe_ratio']:.2f}")
    print(f"æœ€å¤§å›æ’¤: {summary['max_drawdown']:.2%}")
    print(f"èƒœç‡: {summary['win_rate']:.2%}")
    print(f"æ€»äº¤æ˜“æ¬¡æ•°: {summary['total_trades']}")
    print(f"ç›ˆäºæ¯”: {summary['profit_factor']:.2f}")

# ä½¿ç”¨ç¤ºä¾‹
analyze_results(results)
```

### 2. è¯¦ç»†äº¤æ˜“è®°å½•

```python
def analyze_trades(results):
    """åˆ†æäº¤æ˜“è®°å½•"""
    trades = results['trades']
    
    print("=== äº¤æ˜“è®°å½•åˆ†æ ===")
    print(f"æ€»äº¤æ˜“æ¬¡æ•°: {len(trades)}")
    
    # ç»Ÿè®¡ç›ˆåˆ©å’ŒäºæŸäº¤æ˜“
    profitable_trades = [t for t in trades if t['pnl'] > 0]
    losing_trades = [t for t in trades if t['pnl'] < 0]
    
    print(f"ç›ˆåˆ©äº¤æ˜“: {len(profitable_trades)}")
    print(f"äºæŸäº¤æ˜“: {len(losing_trades)}")
    
    if profitable_trades:
        avg_profit = sum(t['pnl'] for t in profitable_trades) / len(profitable_trades)
        print(f"å¹³å‡ç›ˆåˆ©: {avg_profit:.2f}")
    
    if losing_trades:
        avg_loss = sum(t['pnl'] for t in losing_trades) / len(losing_trades)
        print(f"å¹³å‡äºæŸ: {avg_loss:.2f}")

# ä½¿ç”¨ç¤ºä¾‹
analyze_trades(results)
```

### 3. é£é™©åˆ†æ

```python
def analyze_risk(results):
    """é£é™©åˆ†æ"""
    risk_metrics = results['risk_metrics']
    
    print("=== é£é™©åˆ†æ ===")
    print(f"æ³¢åŠ¨ç‡: {risk_metrics['volatility']:.2%}")
    print(f"VaR(95%): {risk_metrics['var_95']:.2%}")
    print(f"CVaR(95%): {risk_metrics['cvar_95']:.2%}")
    print(f"Calmaræ¯”ç‡: {risk_metrics['calmar_ratio']:.2f}")

# ä½¿ç”¨ç¤ºä¾‹
analyze_risk(results)
```

## ğŸŒ Webç•Œé¢ä½¿ç”¨

### 1. é€šè¿‡å‰ç«¯ç•Œé¢ä½¿ç”¨

è®¿é—® `http://localhost:8501/backtest` ä½¿ç”¨Webç•Œé¢ï¼š

```python
# å‰ç«¯ç•Œé¢é…ç½®ç¤ºä¾‹
backtest_config = {
    "strategy": "MAç­–ç•¥",
    "start_date": "2024-01-01",
    "end_date": "2024-12-31",
    "params": {
        "short_period": 10,
        "long_period": 30
    },
    "backtest_init_params": {
        "stock_pool": "éSTè‚¡ç¥¨",
        "initial_capital": 100000,
        "max_positions": 4,
        "allocation_strategy": "ä¿¡å·å¼ºåº¦åŠ æƒ"
    }
}
```

### 2. APIæ¥å£è°ƒç”¨

```python
import requests
import json

def run_backtest_api(strategy, start_date, end_date, params, init_params):
    """é€šè¿‡APIè¿è¡Œå›æµ‹"""
    url = "http://localhost:8000/api/backtest/run"
    
    request_params = {
        "strategy": strategy,
        "start_date": start_date,
        "end_date": end_date,
        "params": json.dumps(params),
        "backtest_init_params": json.dumps(init_params)
    }
    
    response = requests.get(url, params=request_params)
    return response.json()

# ä½¿ç”¨ç¤ºä¾‹
results = run_backtest_api(
    strategy="MAç­–ç•¥",
    start_date="2024-01-01",
    end_date="2024-12-31",
    params={"short_period": 10, "long_period": 30},
    init_params={
        "stock_pool": "éSTè‚¡ç¥¨",
        "initial_capital": 100000,
        "max_positions": 4
    }
)
```

## ğŸ” å†…ç½®ç­–ç•¥è¯´æ˜

### 1. MAç­–ç•¥ (ç§»åŠ¨å¹³å‡ç­–ç•¥)

```python
class MAStrategy(BaseStrategy):
    """ç§»åŠ¨å¹³å‡ç­–ç•¥"""
    
    def __init__(self, short_period=10, long_period=30):
        # çŸ­æœŸå‡çº¿ä¸Šç©¿é•¿æœŸå‡çº¿ä¹°å…¥
        # çŸ­æœŸå‡çº¿ä¸‹ç©¿é•¿æœŸå‡çº¿å–å‡º
```

**å‚æ•°è¯´æ˜ï¼š**
- `short_period`: çŸ­æœŸç§»åŠ¨å¹³å‡å‘¨æœŸ (é»˜è®¤: 10)
- `long_period`: é•¿æœŸç§»åŠ¨å¹³å‡å‘¨æœŸ (é»˜è®¤: 30)

### 2. RSIç­–ç•¥ (ç›¸å¯¹å¼ºå¼±æŒ‡æ ‡ç­–ç•¥)

```python
class RSIStrategy(BaseStrategy):
    """RSIç­–ç•¥"""
    
    def __init__(self, rsi_period=14, oversold=30, overbought=70):
        # RSI < oversold ä¹°å…¥
        # RSI > overbought å–å‡º
```

**å‚æ•°è¯´æ˜ï¼š**
- `rsi_period`: RSIè®¡ç®—å‘¨æœŸ (é»˜è®¤: 14)
- `oversold`: è¶…å–é˜ˆå€¼ (é»˜è®¤: 30)
- `overbought`: è¶…ä¹°é˜ˆå€¼ (é»˜è®¤: 70)

### 3. MACDç­–ç•¥ (MACDæŒ‡æ ‡ç­–ç•¥)

```python
class MACDStrategy(BaseStrategy):
    """MACDç­–ç•¥"""
    
    def __init__(self, fast_period=12, slow_period=26, signal_period=9):
        # MACDé‡‘å‰ä¹°å…¥
        # MACDæ­»å‰å–å‡º
```

**å‚æ•°è¯´æ˜ï¼š**
- `fast_period`: å¿«çº¿å‘¨æœŸ (é»˜è®¤: 12)
- `slow_period`: æ…¢çº¿å‘¨æœŸ (é»˜è®¤: 26)
- `signal_period`: ä¿¡å·çº¿å‘¨æœŸ (é»˜è®¤: 9)

### 4. DualThrustç­–ç•¥ (åŒè½¨ç­–ç•¥)

```python
class DualThrustStrategy(BaseStrategy):
    """åŒè½¨ç­–ç•¥"""
    
    def __init__(self, period=20, k1=0.7, k2=0.7):
        # çªç ´ä¸Šè½¨ä¹°å…¥
        # çªç ´ä¸‹è½¨å–å‡º
```

**å‚æ•°è¯´æ˜ï¼š**
- `period`: è®¡ç®—å‘¨æœŸ (é»˜è®¤: 20)
- `k1`: ä¸Šè½¨ç³»æ•° (é»˜è®¤: 0.7)
- `k2`: ä¸‹è½¨ç³»æ•° (é»˜è®¤: 0.7)

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ•°æ®è¦æ±‚

```python
# æ•°æ®æ ¼å¼è¦æ±‚
required_columns = ['open', 'high', 'low', 'close', 'volume']
date_column = 'datetime'  # æˆ– 'date'

# æ•°æ®é¢„å¤„ç†
def prepare_data(df):
    """å‡†å¤‡å›æµ‹æ•°æ®"""
    # ç¡®ä¿åˆ—åæ­£ç¡®
    df = df.rename(columns={
        'trade_date': 'datetime',
        'amount': 'volume'
    })
    
    # è®¾ç½®ç´¢å¼•
    df['datetime'] = pd.to_datetime(df['datetime'])
    df.set_index('datetime', inplace=True)
    
    # ç¡®ä¿æ•°æ®ç±»å‹
    for col in ['open', 'high', 'low', 'close', 'volume']:
        df[col] = pd.to_numeric(df[col], errors='coerce')
    
    return df
```

### 2. æ€§èƒ½ä¼˜åŒ–

```python
# å¤§æ•°æ®é‡ä¼˜åŒ–
def optimize_for_large_data(df, strategy_class, **kwargs):
    """å¤§æ•°æ®é‡ä¼˜åŒ–"""
    # 1. æ•°æ®é‡‡æ ·
    if len(df) > 10000:
        df = df.resample('D').last().dropna()
    
    # 2. ä½¿ç”¨æ›´é«˜æ•ˆçš„å‚æ•°
    kwargs['plot'] = False  # å…³é—­ç»˜å›¾æé«˜é€Ÿåº¦
    
    # 3. åˆ†æ‰¹å¤„ç†
    results = run_backtest(df, strategy_class, **kwargs)
    return results
```

### 3. å¸¸è§é—®é¢˜è§£å†³

```python
# é—®é¢˜1: æ•°æ®ä¸è¶³
def check_data_sufficiency(df, min_days=100):
    """æ£€æŸ¥æ•°æ®æ˜¯å¦è¶³å¤Ÿ"""
    if len(df) < min_days:
        raise ValueError(f"æ•°æ®ä¸è¶³ï¼Œè‡³å°‘éœ€è¦{min_days}ä¸ªäº¤æ˜“æ—¥")

# é—®é¢˜2: å‚æ•°éªŒè¯
def validate_strategy_params(params):
    """éªŒè¯ç­–ç•¥å‚æ•°"""
    if 'short_period' in params and 'long_period' in params:
        if params['short_period'] >= params['long_period']:
            raise ValueError("çŸ­æœŸå‘¨æœŸå¿…é¡»å°äºé•¿æœŸå‘¨æœŸ")

# é—®é¢˜3: èµ„é‡‘ç®¡ç†
def check_capital_sufficiency(initial_cash, min_capital=10000):
    """æ£€æŸ¥åˆå§‹èµ„é‡‘æ˜¯å¦è¶³å¤Ÿ"""
    if initial_cash < min_capital:
        raise ValueError(f"åˆå§‹èµ„é‡‘ä¸è¶³ï¼Œè‡³å°‘éœ€è¦{min_capital}å…ƒ")
```

## ğŸ“ å®Œæ•´ç¤ºä¾‹

```python
#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
å›æµ‹ç³»ç»Ÿå®Œæ•´ä½¿ç”¨ç¤ºä¾‹
"""

import pandas as pd
from backend.business.backtest_event import (
    run_backtest, 
    run_multi_strategy_backtest,
    optimize_parameters,
    MAStrategy, 
    RSIStrategy, 
    MACDStrategy
)
from backend.business.data.data_fetcher import StockDataFetcher

def main():
    """ä¸»å‡½æ•°"""
    # 1. è·å–æ•°æ®
    fetcher = StockDataFetcher()
    df = fetcher.fetch_stock_data(
        'sh.600900', 
        start_date='2024-01-01', 
        end_date='2024-12-31'
    )
    
    print(f"è·å–æ•°æ®: {len(df)} æ¡è®°å½•")
    
    # 2. å•ç­–ç•¥å›æµ‹
    print("\n=== å•ç­–ç•¥å›æµ‹ ===")
    ma_results = run_backtest(
        data=df,
        strategy_class=MAStrategy,
        strategy_params={'short_period': 10, 'long_period': 30},
        strategy_name="MAç­–ç•¥"
    )
    
    print(f"MAç­–ç•¥æ”¶ç›Šç‡: {ma_results['summary']['total_return']:.2%}")
    
    # 3. å¤šç­–ç•¥å¯¹æ¯”
    print("\n=== å¤šç­–ç•¥å¯¹æ¯” ===")
    strategies = [
        {
            'name': 'MAç­–ç•¥',
            'class': MAStrategy,
            'params': {'short_period': 10, 'long_period': 30}
        },
        {
            'name': 'RSIç­–ç•¥',
            'class': RSIStrategy,
            'params': {'rsi_period': 14, 'oversold': 30, 'overbought': 70}
        },
        {
            'name': 'MACDç­–ç•¥',
            'class': MACDStrategy,
            'params': {'fast_period': 12, 'slow_period': 26, 'signal_period': 9}
        }
    ]
    
    multi_results = run_multi_strategy_backtest(
        data=df,
        strategies=strategies,
        initial_cash=100000
    )
    
    for strategy_name, result in multi_results['strategies'].items():
        print(f"{strategy_name}: {result['summary']['total_return']:.2%}")
    
    # 4. å‚æ•°ä¼˜åŒ–
    print("\n=== å‚æ•°ä¼˜åŒ– ===")
    parameter_ranges = {
        'short_period': [5, 10, 15],
        'long_period': [20, 30, 40]
    }
    
    opt_results = optimize_parameters(
        data=df,
        strategy_class=MAStrategy,
        parameter_ranges=parameter_ranges,
        optimization_target="æ€»æ”¶ç›Šç‡"
    )
    
    print(f"æœ€ä¼˜å‚æ•°: {opt_results['best_parameters']}")
    print(f"æœ€ä¼˜æ”¶ç›Šç‡: {opt_results['best_return']:.2%}")
    
    return ma_results, multi_results, opt_results

if __name__ == "__main__":
    ma_results, multi_results, opt_results = main()
```

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [å›æµ‹æ¡†æ¶å¼€å‘æ–‡æ¡£](../æ¨¡å—å¼€å‘æ–‡æ¡£/å›æµ‹æ¡†æ¶/å›æµ‹æ¡†æ¶å¼€å‘æ–‡æ¡£.md)
- [ç­–ç•¥å¼€å‘æŒ‡å—](../æ¨¡å—å¼€å‘æ–‡æ¡£/å›æµ‹æ¡†æ¶/ç­–ç•¥å¼€å‘æŒ‡å—.md)
- [APIæ¥å£æ–‡æ¡£](../../APIæ¥å£æ–‡æ¡£.md)

---

**æœ€åæ›´æ–°**: 2025å¹´8æœˆ9æ—¥  
**ç‰ˆæœ¬**: v2.1  
**é‡è¦å˜æ›´**: é»˜è®¤èµ„é‡‘åˆ†é…ç­–ç•¥å·²æ›´æ–°ä¸ºâ€œæŒ‰å‰©ä½™ç©ºä½ç­‰æƒâ€ã€‚

> èµ„é‡‘åˆ†é…è¯´æ˜ï¼šä¹°å…¥è‚¡æ•°çš„åˆå§‹è®¡ç®—åŸºäºâ€œå¯ç”¨ç°é‡‘ Ã· å‰©ä½™ç©ºä½æ•°ï¼ˆmax_positions - å½“å‰æŒä»“æ•°ï¼‰â€ï¼Œéšååº”ç”¨é£é™©æ§åˆ¶ï¼ˆå•ç¥¨å æ¯”ã€æœ€ä½ç°é‡‘ç•™å­˜ï¼‰ä¸Aè‚¡æˆäº¤çº¦æŸï¼ˆ100è‚¡ä¸€æ‰‹ã€æœ€ä½æˆäº¤é¢ã€è´¹ç”¨è¦†ç›–ï¼‰è¿›è¡Œè°ƒæ•´ã€‚