# 股票数据获取使用示例

## 概述

`DataUtils` 类提供了统一的股票数据获取接口，简化了回测系统中的数据获取流程。所有方法都支持从 `data_fetcher.py` 中获取数据，并包含数据验证和清理功能。

## 主要方法

### 1. 获取股票列表信息

```python
from backend.business.backtest.utils.data_utils import DataUtils

# 获取非ST股票列表
stock_list = DataUtils.get_stock_list_info("no_st")
print(f"非ST股票数量: {len(stock_list)}")
print(f"列名: {list(stock_list.columns)}")

# 获取上证50股票列表
sz50_list = DataUtils.get_stock_list_info("sz50")
print(f"上证50股票数量: {len(sz50_list)}")

# 获取沪深300股票列表
hs300_list = DataUtils.get_stock_list_info("hs300")
print(f"沪深300股票数量: {len(hs300_list)}")
```

**支持的股票池类型：**
- `"full"`: 全量股票
- `"no_st"`: 非ST股票（推荐）
- `"st"`: ST股票
- `"sz50"`: 上证50
- `"hs300"`: 沪深300
- `"zz500"`: 中证500

### 2. 获取单只股票数据

```python
# 获取单只股票的历史数据
stock_data = DataUtils.get_single_stock_data(
    stock_code="sh.600000",  # 浦发银行
    start_date="2024-01-01",
    end_date="2024-12-31",
    period="daily",  # 日线数据
    adjust="3"  # 不复权
)

print(f"数据条数: {len(stock_data)}")
print(f"数据列名: {list(stock_data.columns)}")
print(f"时间范围: {stock_data.index[0]} 到 {stock_data.index[-1]}")

# 数据包含以下列：
# - open: 开盘价
# - high: 最高价
# - low: 最低价
# - close: 收盘价
# - volume: 成交量
# - amount: 成交额
# - 其他技术指标...
```

### 3. 获取回测所需的所有股票数据

```python
# 定义进度回调函数（可选）
def progress_callback(progress, stock_code, success_count, failed_count):
    print(f"进度: {progress:.1%}, 当前: {stock_code}, 成功: {success_count}, 失败: {failed_count}")

# 获取回测数据
stock_data_dict = DataUtils.get_stock_data_for_backtest(
    stock_pool="no_st",           # 非ST股票
    start_date="2024-01-01",      # 开始日期
    end_date="2024-12-31",        # 结束日期
    period="daily",               # 日线数据
    adjust="3",                   # 不复权
    min_data_days=60,             # 最小数据天数
    max_stocks=100,               # 最大股票数量（可选）
    progress_callback=progress_callback  # 进度回调（可选）
)

print(f"成功获取 {len(stock_data_dict)} 只股票的数据")

# 数据结构：{股票代码: DataFrame}
for stock_code, data in stock_data_dict.items():
    print(f"股票 {stock_code}: {len(data)} 条数据")
```

### 4. 根据条件过滤股票

```python
# 获取股票列表
stock_list = DataUtils.get_stock_list_info("no_st")

# 根据成交额过滤
filtered_stocks = DataUtils.filter_stocks_by_condition(
    stock_list=stock_list,
    min_amount=1000000,  # 最小成交额100万
    min_volume=100000,   # 最小成交量10万
    start_date="2024-12-01",
    end_date="2024-12-31"
)

print(f"过滤前股票数量: {len(stock_list)}")
print(f"过滤后股票数量: {len(filtered_stocks)}")
```

## 在回测策略中使用

### 1. 在策略初始化时获取数据

```python
from backend.business.backtest.strategies.rising_channel import RisingChannelBacktestStrategy
from backend.business.backtest.utils.data_utils import DataUtils

class MyBacktestStrategy(RisingChannelBacktestStrategy):
    def __init__(self, **params):
        super().__init__(**params)
        
        # 获取所有股票数据
        self.all_stock_data = DataUtils.get_stock_data_for_backtest(
            stock_pool="no_st",
            start_date="2024-01-01",
            end_date="2024-12-31",
            max_stocks=50  # 限制数量以提高性能
        )
        
        print(f"策略初始化完成，获取到 {len(self.all_stock_data)} 只股票的数据")
    
    def _scan_candidate_stocks(self, current_date):
        """扫描候选股票"""
        candidate_stocks = []
        
        for stock_code, stock_data in self.all_stock_data.items():
            # 计算上升通道
            channel_result = self._calculate_rising_channel(stock_data)
            
            if channel_result['status'] == 'NORMAL':
                candidate_stocks.append({
                    'code': stock_code,
                    'channel_score': channel_result['score'],
                    'channel_status': channel_result['status']
                })
        
        self.candidate_stocks = candidate_stocks
```

### 2. 在回测服务中使用

```python
from backend.services.backtest_service import BacktestService
from backend.business.backtest.utils.data_utils import DataUtils

class EnhancedBacktestService(BacktestService):
    async def run_rising_channel_backtest(self, start_date, end_date, **params):
        """运行上升通道回测"""
        
        # 获取股票数据
        stock_data_dict = DataUtils.get_stock_data_for_backtest(
            stock_pool="no_st",
            start_date=start_date,
            end_date=end_date,
            max_stocks=100
        )
        
        # 创建策略实例
        strategy = RisingChannelBacktestStrategy(**params)
        strategy.all_stock_data = stock_data_dict
        
        # 运行回测
        # ... 回测逻辑
```

## 数据质量保证

### 1. 自动数据验证

所有获取的数据都会自动进行验证：

```python
# 验证数据质量
validation_result = DataUtils.validate_data(stock_data)

if validation_result["is_valid"]:
    print("数据验证通过")
else:
    print(f"数据验证失败: {validation_result['errors']}")
    print(f"警告信息: {validation_result['warnings']}")
```

### 2. 自动数据清理

```python
# 清理数据
cleaned_data = DataUtils.clean_data(stock_data)

# 计算收益率
data_with_returns = DataUtils.calculate_returns(cleaned_data)
```

## 性能优化建议

### 1. 合理设置参数

```python
# 对于快速测试
stock_data_dict = DataUtils.get_stock_data_for_backtest(
    stock_pool="sz50",      # 使用较小的股票池
    max_stocks=20,          # 限制股票数量
    min_data_days=30,       # 降低最小数据天数要求
    start_date="2024-12-01", # 使用较短的时间范围
    end_date="2024-12-31"
)

# 对于正式回测
stock_data_dict = DataUtils.get_stock_data_for_backtest(
    stock_pool="no_st",     # 使用完整的股票池
    max_stocks=None,        # 不限制股票数量
    min_data_days=120,      # 要求足够的历史数据
    start_date="2023-01-01", # 使用较长的时间范围
    end_date="2024-12-31"
)
```

### 2. 使用进度回调

```python
from tqdm import tqdm

# 创建进度条
pbar = tqdm(total=100, desc="获取股票数据")

def progress_callback(progress, stock_code, success_count, failed_count):
    pbar.update(1)
    pbar.set_postfix({
        'current': stock_code,
        'success': success_count,
        'failed': failed_count
    })

# 获取数据
stock_data_dict = DataUtils.get_stock_data_for_backtest(
    stock_pool="no_st",
    progress_callback=progress_callback
)

pbar.close()
```

## 错误处理

### 1. 处理数据获取失败

```python
try:
    stock_data_dict = DataUtils.get_stock_data_for_backtest(
        stock_pool="no_st",
        start_date="2024-01-01",
        end_date="2024-12-31"
    )
except ValueError as e:
    print(f"数据获取失败: {e}")
    # 使用备用数据或调整参数
except ImportError as e:
    print(f"模块导入失败: {e}")
    # 检查依赖是否正确安装
```

### 2. 处理空数据

```python
stock_data = DataUtils.get_single_stock_data("sh.600000")

if stock_data.empty:
    print("数据为空，可能的原因：")
    print("1. 数据库中不存在该股票")
    print("2. 指定时间范围内没有数据")
    print("3. 股票已退市")
else:
    print(f"成功获取 {len(stock_data)} 条数据")
```

## 注意事项

1. **数据更新**: 确保数据库中的数据是最新的
2. **内存使用**: 大量股票数据会占用较多内存，建议合理设置 `max_stocks`
3. **网络连接**: 某些数据源需要网络连接
4. **数据格式**: 所有返回的数据都是 pandas DataFrame 格式
5. **时间格式**: 日期参数使用 "YYYY-MM-DD" 格式

## 总结

使用 `DataUtils` 的数据获取方法可以：

- ✅ 统一数据获取接口
- ✅ 自动数据验证和清理
- ✅ 支持进度监控
- ✅ 提供错误处理
- ✅ 优化性能参数
- ✅ 简化回测代码

这些方法大大简化了回测系统的数据获取流程，提高了开发效率。 