# 上升通道回归模块开发文档 (Ascending Channel Regression Module)

*Version 0.2 — 2025‑07‑17*

---

## 1 · 模块概述

本模块针对单只股票（过去 1 年 ≈ 252 根日线）自动检测、维护并输出最新**上升回归通道**信息。

**输入**
• `DataFrame` 含列 `date, open, high, low, close, volume`，时间升序，长度≥252。

**输出**

```
{
  "beta":         <float>,   # 最新斜率 β_t
  "mid_today":    <float>,   # 今日中轴价
  "upper_today":  <float>,   # 今日上沿价
  "lower_today":  <float>,   # 今日下沿价
  "mid_tomorrow":   …        # 预估下一交易日位置(按 β_t 外推 1 日)
  "upper_tomorrow": …
  "lower_tomorrow": …
  "channel_status": <str>    # NORMAL | ACCEL_BREAKOUT | BREAKDOWN | BROKEN
}
```

---

## 2 · 核心参数

| 名称                  | 默认   | 说明                                          |
| ------------------- | ---- | ------------------------------------------- |
| `k`                 | 2.0  | 通道宽度倍数 (±k·σ)                               |
| `L_max`             | 120  | 窗口最长天数（超出后向右滑动）                             |
| `Δ_cut`             | 5    | 滑动时一次剔除最早 Δ\_cut 天                          |
| `pivot_m`           | 3    | 判断 pivot low 宽度 (m 左 m 右更高)                 |
| `gain_trigger`      | 0.30 | 累计涨幅触发重锚                                    |
| `β_delta`           | 0.15 | 斜率变化阈值 (±15 %)                              |
| `break_days`        | 3    | 连续 n 日突破上下沿视为失效                             |
| `reanchor_fail_max` | 2    | 连续 n 次重锚仍突破/跌破时进入极端状态                       |
| `R2_min`            | 0.20 | **最小回归拟合优度**，若 R² < 该阈值则判定趋势不可靠，直接置为 BROKEN |
| `width_pct_min`     | 0.04 | **通道宽度下限** (上沿-下沿)/mid\_today，小于该值表示过窄，易假突破 |
| `width_pct_max`     | 0.12 | **通道宽度上限**，超过该值表示过宽，趋势噪声大                   |

\------|-------|------|
\| `k` | 2.0 | 通道宽度倍数 (±k·σ) |
\| `L_max` | 120 | 窗口最长天数（超出后向右滑动） |
\| `Δ_cut` | 5 | 滑动时一次剔除最早 Δ\_cut 天 |
\| `pivot_m` | 3 | 判断 pivot low 宽度 (m 左 m 右更高) |
\| `gain_trigger` | 0.30 | 累计涨幅触发重锚 |
\| `β_delta` | 0.15 | 斜率变化阈值 (±15 %) |
\| `break_days` | 3 | 连续 n 日突破上下沿视为失效 |
\| `reanchor_fail_max` | 2 | 连续 n 次重锚仍突破/跌破时进入极端状态 |

---

## 3 · 算法流程

```
初始化 → 找首个 anchor
每日收盘:
    • 更新窗口 (anchor → today)
    • 线性回归 → β_t, σ_t
    • 计算 mid / upper / lower
    • 检查 price 位置
          ╭─ 连续 break 上沿? ─╮
          │ yes                │
          │  re_anchor_fail_up +=1
          │                   ┌──────────────┐
          │                   │  fail_up==2? │─► ACCEL_BREAKOUT & 冻结
          │                   └──────────────┘
          └─ no → reset count
          (下沿同理计数 → BREAKDOWN)
    • 检查重锚触发 (窗超长/涨幅≥30%/β 变化/首次突破)
          ├─ 若触发 → find_new_anchor()
          └─ 若三天连续破下沿 & 无新 pivot → BROKEN
```

### 3.1  重锚触发条件

1. `len(window) > L_max`  →  删最早 `Δ_cut` 天。
2. `gain_t ≥ gain_trigger` (30 %)。
3. 连续 `break_days` 日收盘 > 上沿或 < 下沿。
4. `β_t` 与上一周期相比变化幅度 ≥ `β_delta`。
5. *手动/外部* 事件可显式调用 `force_reanchor()`。

### 3.2  连续突破/跌破保护

* 维护两个计数器：`re_anchor_fail_up`, `re_anchor_fail_down`。
* 每触发一次重锚后立即 **清 0** 对应计数器。
* 若同方向再次连续突破/跌破导致计数器 == `reanchor_fail_max` → 不再重锚，通道状态置为：

  * `ACCEL_BREAKOUT` （加速突破，上沿无约束）
  * 或 `BREAKDOWN` （跌破下沿，趋势反转）
* 模块将在 **出现新 pivot low/high & β > 0** 或 **回到通道内 `break_days` 日** 后自动解除极端状态并重新锚定。

---

## 4 · 主要函数接口（一览）

| 函数                      | 摘要                             |
| ----------------------- | ------------------------------ |
| `fit_channel(df)`       | 传入一年数据，内部自动找初始锚点并返回 `state` 对象 |
| `update(state, bar)`    | 每日调用，输入新 K 线，返回最新输出字典          |
| `force_reanchor(state)` | 外部强制重锚（可接交易员 UI）               |

**state 对象字段**

```
anchor_date, anchor_price, window_df,
β_t, σ_t, mid, upper, lower,
break_cnt_up, break_cnt_down,
channel_status
```

---

## 5 · 输出示例

```json
{
  "beta": 0.0427,
  "mid_today": 34.89,
  "upper_today": 36.51,
  "lower_today": 33.28,
  "mid_tomorrow": 34.93,
  "upper_tomorrow": 36.55,
  "lower_tomorrow": 33.31,
  "channel_status": "NORMAL"
}
```

状态可能值：

* **NORMAL** – 通道有效
* **ACCEL\_BREAKOUT** – 连续两次重锚仍破上沿 → 抛物线加速段
* **BREAKDOWN** – 连续两次重锚仍破下沿 → 反转/下跌
* **BROKEN** – 连续跌破下沿 3 日且无有效新锚

---

## 6 · 异常 & 日志

* 若输入不足 60 条数据 → 抛 `InsufficientDataError`。
* 每次进入极端状态输出 **WARN** 日志：
  `WARN [ACCEL_BREAKOUT] <symbol> <date> 连续重锚失败(up)`。
* `channel_status != NORMAL` 时，`beta / σ` 仍计算但仅供参考。

---

## 7 · 测试要求

1. **单元测试**：模拟不同价轨迹验证状态转换。
2. **回测对照**：与传统滚动回归通道比较，确认信号稳定性。
3. **性能**：对 4000 只股票全量跑完一年 ≦ 30 s（8 核）。

---

> **备注**：所有阈值 (`L_max`, `gain_trigger` 等) 支持 YAML 配置 & 实时热更新，方便策略调参。
