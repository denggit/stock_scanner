# 回测框架日志管理规范

## 概述

回测框架采用统一的日志管理策略，所有回测相关的模块都使用名为"backtest"的日志记录器，确保日志的一致性和可追踪性。

## 日志记录器统一性

### 1. 统一日志记录器名称

所有回测模块都使用 `logging.getLogger("backtest")` 来获取日志记录器：

```python
# 正确的用法
logger = logging.getLogger("backtest")

# 错误的用法
logger = logging.getLogger(__name__)  # 会产生不同的日志记录器名称
```

### 2. 已统一的模块

以下模块已经统一使用"backtest"日志记录器：

#### 核心模块
- `BacktestEngine`: 回测引擎
- `DataManager`: 数据管理器
- `ResultAnalyzer`: 结果分析器

#### 策略模块
- `RisingChannelBacktestStrategy`: 上升通道策略
- 其他所有策略类

#### 工具模块
- `DataUtils`: 数据工具类
- `ReportUtils`: 报告工具类

### 3. 日志记录器配置示例

```python
class BacktestEngine:
    def __init__(self):
        # 统一使用backtest主日志记录器，便于全局日志管理和追踪
        self.logger = logging.getLogger("backtest")
        
class DataManager:
    def __init__(self):
        # 统一使用backtest主日志记录器，便于全局日志管理和追踪
        self.logger = logging.getLogger("backtest")
        
class RisingChannelBacktestStrategy(BaseStrategy):
    def __init__(self, **params):
        super().__init__(**params)
        
        # 统一使用backtest主日志记录器，便于全局日志管理和追踪
        self.logger = logging.getLogger("backtest")
```

## 日志级别规范

### 1. 日志级别定义

```python
# DEBUG: 详细的调试信息
logger.debug("详细的调试信息")

# INFO: 一般信息
logger.info("开始回测流程")

# WARNING: 警告信息
logger.warning("股票数据为空")

# ERROR: 错误信息
logger.error("数据获取失败")

# CRITICAL: 严重错误
logger.critical("系统严重错误")
```

### 2. 使用场景

#### DEBUG级别
- 详细的算法计算过程
- 数据处理的中间步骤
- 策略决策的详细逻辑

#### INFO级别
- 回测流程的开始和结束
- 重要操作的完成状态
- 数据加载和处理的进度

#### WARNING级别
- 数据质量问题
- 策略参数异常
- 非致命的错误情况

#### ERROR级别
- 数据获取失败
- 策略执行错误
- 系统配置问题

## 日志格式规范

### 1. 标准日志格式

```python
formatter = logging.Formatter(
    '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
```

### 2. 日志输出示例

```
2024-01-15 10:30:15,123 - backtest - INFO - 开始回测流程
2024-01-15 10:30:15,124 - backtest - INFO - 数据管理器初始化完成
2024-01-15 10:30:15,125 - backtest - INFO - 策略初始化完成
2024-01-15 10:30:15,126 - backtest - WARNING - 股票 000001.SZ 数据为空
2024-01-15 10:30:15,127 - backtest - INFO - 回测完成
```

## 日志文件管理

### 1. 日志文件命名

```python
# 使用setup_logger函数创建日志记录器
from backend.utils.logger import setup_logger

# 创建backtest日志记录器
logger = setup_logger("backtest", log_dir="logs")
```

### 2. 日志文件结构

```
logs/
└── backtest/
    ├── backtest_2024-01-15.log
    ├── backtest_2024-01-16.log
    └── backtest_2024-01-17.log
```

### 3. 日志轮转

- 按日期自动轮转
- 保留历史日志文件
- 支持日志压缩和清理

## 最佳实践

### 1. 日志记录原则

#### 记录关键信息
```python
# 好的做法
logger.info(f"开始处理股票池: {stock_pool}, 股票数量: {len(stock_list)}")

# 避免过度记录
logger.debug(f"处理第 {i} 只股票: {stock_code}")  # 只在DEBUG级别记录
```

#### 使用结构化信息
```python
# 好的做法
logger.info("策略执行完成", extra={
    'strategy_name': 'RisingChannel',
    'trade_count': 10,
    'total_return': 0.15
})
```

### 2. 错误处理

```python
try:
    # 执行操作
    result = perform_operation()
    logger.info("操作执行成功")
except Exception as e:
    logger.error(f"操作执行失败: {e}", exc_info=True)
    # 继续处理或抛出异常
```

### 3. 性能考虑

```python
# 避免在循环中频繁记录
for i, stock in enumerate(stocks):
    if i % 100 == 0:  # 每100只股票记录一次进度
        logger.info(f"处理进度: {i}/{len(stocks)}")
    
    # 处理股票数据
    process_stock(stock)
```

## 日志监控和分析

### 1. 日志分析工具

可以使用以下工具分析日志：

- **grep**: 搜索特定信息
- **awk**: 提取和统计日志数据
- **Python脚本**: 自定义日志分析

### 2. 常见分析场景

#### 错误统计
```bash
grep "ERROR" logs/backtest/backtest_2024-01-15.log | wc -l
```

#### 性能分析
```bash
grep "执行时间" logs/backtest/backtest_2024-01-15.log
```

#### 策略执行统计
```bash
grep "策略执行" logs/backtest/backtest_2024-01-15.log
```

## 配置示例

### 1. 开发环境配置

```python
import logging

# 设置日志级别
logging.getLogger("backtest").setLevel(logging.DEBUG)

# 添加控制台处理器
console_handler = logging.StreamHandler()
console_handler.setLevel(logging.INFO)
formatter = logging.Formatter('%(asctime)s - %(name)s - %(levelname)s - %(message)s')
console_handler.setFormatter(formatter)
logging.getLogger("backtest").addHandler(console_handler)
```

### 2. 生产环境配置

```python
from backend.utils.logger import setup_logger

# 创建生产环境日志记录器
logger = setup_logger("backtest", log_level=logging.INFO)
```

## 注意事项

### 1. 避免的问题

- ❌ 使用 `__name__` 作为日志记录器名称
- ❌ 在循环中频繁记录日志
- ❌ 记录敏感信息（如密码、API密钥）
- ❌ 日志级别设置不当

### 2. 推荐做法

- ✅ 统一使用"backtest"日志记录器
- ✅ 合理设置日志级别
- ✅ 记录有意义的上下文信息
- ✅ 使用异常处理记录错误
- ✅ 定期清理旧日志文件

## 总结

通过统一的日志管理规范，回测框架实现了：

1. **一致性**: 所有模块使用相同的日志记录器
2. **可追踪性**: 完整的操作流程记录
3. **可维护性**: 统一的日志格式和管理
4. **可扩展性**: 支持不同环境的日志配置

这种统一的日志管理方式大大提高了系统的可观测性和问题排查效率。 