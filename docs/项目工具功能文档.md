# 🚀 股票扫描器 - 工具功能文档

## 📋 目录

- [🏗️ 项目概述](#-项目概述)
- [🔧 核心模块](#-核心模块)
- [📊 数据层](#-数据层)
- [🎯 策略系统](#-策略系统)
- [📈 回测系统](#-回测系统)
- [🧠 机器学习](#-机器学习)
- [🔍 因子分析](#-因子分析)
- [🌐 服务层](#-服务层)
- [📱 前端界面](#-前端界面)
- [🛠️ 工具类](#️-工具类)
- [📚 使用示例](#-使用示例)
- [🚀 部署指南](#-部署指南)

---

## 🏗️ 项目概述

这是一个功能完整的量化交易平台，采用前后端分离架构，提供股票数据获取、策略开发、回测分析、实时监控等功能。

### 🎯 核心特性

- **多数据源支持**: AKShare、宝硕数据源
- **丰富策略库**: 8种预置交易策略
- **完整回测框架**: 支持单策略和多策略回测
- **机器学习集成**: 爆发式股票预测模型
- **因子分析**: 上升通道回归分析
- **交互式界面**: Streamlit构建的Web界面
- **RESTful API**: FastAPI提供标准化接口

### 🛠️ 技术栈

- **后端**: FastAPI + Python 3.11+
- **前端**: Streamlit + Plotly
- **数据源**: AKShare + Baostock
- **机器学习**: scikit-learn + XGBoost
- **数据处理**: Pandas + NumPy
- **可视化**: Plotly + Matplotlib
- **日志**: Python logging

---

## 🔧 核心模块

### 1. 业务层架构 (`backend/business/`)

项目采用分层架构设计，业务逻辑统一管理：

```
business/
├── backtest/     # 回测业务
├── data/         # 数据业务
├── factor/       # 因子业务
├── ml/           # 机器学习业务
└── strategies/   # 策略业务
```

### 2. 服务层 (`backend/services/`)

- **StockService**: 股票数据服务
- **StrategyService**: 策略执行服务
- **BacktestService**: 回测服务

### 3. 接口层 (`backend/interface/`)

- **stock_interface**: 股票数据API
- **strategy_interface**: 策略API
- **backtest_interface**: 回测API

---

## 📊 数据层

### 1. 数据获取器 (`backend/business/data/data_fetcher.py`)

```python
from backend.business.data.data_fetcher import StockDataFetcher

# 创建数据获取器
fetcher = StockDataFetcher()

# 获取股票数据
data = fetcher.fetch_stock_data(
    code="000001.SZ",
    start_date="2024-01-01",
    end_date="2024-12-31",
    period="daily"
)

# 获取股票列表
stock_list = fetcher.get_stock_list_with_cond(
    pool_name="sz50",
    ipo_date="2020-01-01",
    min_amount=100000000
)
```

### 2. 多数据源支持

#### AKShare数据源

```python
from backend.business.data.source.akshare_src import AKShareSource

# 获取财务数据
financial_data = AKShareSource.get_financial_data("000001", "income")

# 获取机构参与度
institution_data = AKShareSource.get_institution_participation("000001")

# 获取行业数据
industry_data = AKShareSource.get_industry_data()
```

#### 宝硕数据源

```python
from backend.business.data.source.baostock_src import BaostockSource

# 获取股票数据
data = BaostockSource.get_stock_data(
    code="000001.SZ",
    start_date="2024-01-01",
    end_date="2024-12-31",
    frequency="daily"
)

# 获取财务数据
profit_data = BaostockSource.get_profit_data(code="000001.SZ", year=2024)
balance_data = BaostockSource.get_balance_data(code="000001.SZ", year=2024)
```

### 3. 数据管理器 (`backend/business/data/data_manager.py`)

```python
from backend.business.data.data_manager import DatabaseManager

# 数据库操作
db = DatabaseManager()

# 保存股票数据
db.save_stock_data(data, "000001.SZ")

# 查询历史数据
history_data = db.get_stock_history("000001.SZ", "2024-01-01", "2024-12-31")

# 更新数据状态
db.update_data_status("000001.SZ", "daily", "2024-12-31")
```

---

## 🎯 策略系统

### 1. 策略基类 (`backend/business/strategies/base.py`)

```python
from backend.business.strategies.base import BaseStrategy

class MyStrategy(BaseStrategy):
    def __init__(self):
        super().__init__()
        self.name = "我的策略"
        self.description = "策略描述"
    
    def generate_signal(self, data):
        # 实现策略逻辑
        signal = {
            'signal': 85.5,
            'buy_signal': '建议买入',
            'risk_level': '中等风险'
        }
        return signal
    
    def validate_parameters(self, params):
        # 参数验证
        required_params = ['signal', 'volume_ratio']
        for param in required_params:
            if param not in params:
                raise ValueError(f"缺少必需参数: {param}")
```

### 2. 爆发式选股策略

```python
from backend.business.strategies.explosive_stock import ExplosiveStockStrategy

# 初始化策略
strategy = ExplosiveStockStrategy()

# 设置参数
strategy.set_parameters({
    "signal": 70.0,           # 信号强度阈值
    "volume_ratio": 1.5,      # 成交量比率
    "rsi_range": (45, 65),    # RSI范围
    "explosion_probability": 0.5,  # 爆发概率阈值
    "weights": {
        "volume": 0.35,       # 成交量权重
        "momentum": 0.30,     # 动量权重
        "pattern": 0.20,      # 形态权重
        "volatility": 0.15    # 波动率权重
    }
})

# 生成信号
signal = strategy.generate_signal(stock_data)
print(f"信号强度: {signal['signal']}")
print(f"买入建议: {signal['buy_signal']}")
print(f"风险等级: {signal['risk_level']}")
```

### 3. 均线回踩策略

```python
from backend.business.strategies.ma_pullback import MAPullbackStrategy

strategy = MAPullbackStrategy()
strategy.set_parameters({
    "ma_period": 20,          # 均线周期
    "lookback_period": 20,    # 回看周期
    "price_margin": 0.01,     # 价格容差
    "volume_ratio": 1.2       # 成交量比率
})

signal = strategy.generate_signal(stock_data)
```

### 4. 上升通道策略

```python
from backend.business.strategies.rising_channel import RisingChannelStrategy

strategy = RisingChannelStrategy()
strategy.set_parameters({
    "k": 2.0,                 # 通道宽度倍数
    "L_max": 120,             # 最大窗口长度
    "gain_trigger": 0.30,     # 重锚涨幅触发
    "beta_delta": 0.15        # 斜率变化阈值
})

signal = strategy.generate_signal(stock_data)
```

### 5. 其他策略

- **突破策略** (`breakout.py`): 价格突破识别
- **波段交易策略** (`swing_trading.py`): 波段操作
- **翻倍策略** (`double_up.py`): 寻找翻倍潜力股
- **长期上涨策略** (`long_term_uptrend.py`): 长期趋势识别
- **头肩底策略** (`hs_bottom.py`): 头肩底形态识别
- **放量上涨策略** (`continuous_rise.py`): 放量上涨识别

---

## 📈 回测系统

### 1. 回测引擎 (`backend/business/backtest/core/backtest_engine.py`)

```python
from backend.business.backtest_event.core.backtest_engine import BacktestEngine

# 创建回测引擎
engine = BacktestEngine(initial_cash=100000.0, commission=0.0003)

# 添加数据
engine.add_data(stock_data)

# 添加策略
engine.add_strategy(MAStrategy, ma_period=20)

# 运行回测
results = engine.run("MA策略")

# 获取结果
print(f"总收益率: {results['total_return']:.2%}")
print(f"年化收益率: {results['annual_return']:.2%}")
print(f"最大回撤: {results['max_drawdown']:.2%}")
print(f"夏普比率: {results['sharpe_ratio']:.2f}")
```

### 2. 便捷回测函数

```python
from backend.business.backtest_event import run_backtest, run_multi_strategy_backtest

# 单策略回测
results = run_backtest(
    data=stock_data,
    strategy_class=MAStrategy,
    initial_cash=100000.0,
    commission=0.0003,
    strategy_params={"ma_period": 20},
    strategy_name="MA策略"
)

# 多策略回测
strategies = [
    {"name": "MA策略", "class": MAStrategy, "params": {"ma_period": 20}},
    {"name": "MACD策略", "class": MACDStrategy, "params": {}}
]

results = run_multi_strategy_backtest(
    data=stock_data,
    strategies=strategies,
    initial_cash=100000.0
)
```

### 3. 结果分析器 (`backend/business/backtest/core/result_analyzer.py`)

```python
from backend.business.backtest_event.core.result_analyzer import ResultAnalyzer

# 创建分析器
analyzer = ResultAnalyzer()

# 分析回测结果
analysis = analyzer.analyze(results)

# 生成报告
report = analyzer.generate_report(results)

# 比较策略
comparison = analyzer.compare_strategies([results1, results2])
```

---

## 🧠 机器学习

### 1. 数据收集器 (`backend/business/ml/data_collector.py`)

```python
from backend.business.ml.data_collector import ExplosiveStockDataCollector

# 创建数据收集器
collector = ExplosiveStockDataCollector()

# 收集训练数据
data = collector.collect_data(
    stock_pool="sz50",
    start_date="2020-01-01",
    end_date="2024-12-31"
)

# 特征工程
features = collector.extract_features(data)

# 标签生成
labels = collector.generate_labels(data, threshold=0.3)
```

### 2. 模型训练器 (`backend/business/ml/model_trainer.py`)

```python
from backend.business.ml.model_trainer import ExplosiveStockModelTrainer

# 创建训练器
trainer = ExplosiveStockModelTrainer()

# 训练模型
model = trainer.train_model(
    stock_pool="sz50",
    start_date="2020-01-01",
    end_date="2024-12-31"
)

# 模型评估
evaluation = trainer.evaluate_model(model, test_data)

# 保存模型
trainer.save_model(model, "models/explosive_stock_model.pkl")
```

### 3. 预测服务

```python
# 加载模型
model = trainer.load_model("models/explosive_stock_model.pkl")

# 预测
prediction = model.predict_proba(features)
explosion_probability = prediction[0][1]

print(f"爆发概率: {explosion_probability:.2%}")
```

---

## 🔍 因子分析

### 1. 上升通道因子 (`backend/business/factor/core/engine/library/channel_analysis/`)

```python
from backend.business.factor.core.engine.library.channel_analysis import AscendingChannelRegression

# 创建分析器
analyzer = AscendingChannelRegression()

# 拟合通道
state = analyzer.fit_channel(df)

# 获取通道信息
channel_info = state.to_dict()

print(f"斜率: {channel_info['beta']:.4f}")
print(f"通道状态: {channel_info['channel_status']}")
print(f"今日中轴: {channel_info['mid_today']:.2f}")
print(f"今日上沿: {channel_info['upper_today']:.2f}")
print(f"今日下沿: {channel_info['lower_today']:.2f}")
```

### 2. 历史通道数据计算

```python
# 计算历史通道数据
history_df = analyzer.fit_channel_history(df, min_window_size=60)

# 优化计算（按步长）
history_df = analyzer.fit_channel_history_optimized(
    df, 
    min_window_size=60, 
    step_days=5
)

# 增量更新
updated_df = analyzer.update_channel_history_incremental(
    history_df, 
    new_data
)
```

### 3. 因子性能分析

```python
from backend.business.factor.backtest.performance_analyzer import analyze_single_factor

# 分析因子性能
results = analyze_single_factor(
    factor_data=factor_data,
    returns=returns,
    factor_name="上升通道因子"
)

print(f"IC值: {results['ic']:.4f}")
print(f"IR值: {results['ir']:.4f}")
print(f"胜率: {results['win_rate']:.2%}")
```

---

## 🌐 服务层

### 1. 股票服务 (`backend/services/stock_service.py`)

```python
from backend.services.stock_service import StockService

# 创建服务
service = StockService()

# 获取股票数据
data = await service.get_stock_data(
    code="000001",
    period="daily",
    start_date="2024-01-01",
    end_date="2024-12-31",
    ma_periods=[5, 10, 20]
)

# 获取指标数据
indicators = await service.get_stock_indicators(
    code="000001",
    indicators=["MA", "MACD", "RSI"],
    date="2024-12-31"
)
```

### 2. 策略服务 (`backend/services/strategy_service.py`)

```python
from backend.services.strategy_service import StrategyService

# 创建服务
service = StrategyService()

# 扫描股票
results = await service.scan_stocks(
    strategy="爆发式选股策略",
    params={
        "stock_pool": "非ST股票",
        "signal": 70.0,
        "volume_ratio": 1.5
    }
)

# 获取策略列表
strategies = await service.list_strategies()
```

### 3. 回测服务 (`backend/services/backtest_service.py`)

```python
from backend.services.backtest_service import BacktestService

# 创建服务
service = BacktestService()

# 运行回测
results = await service.run_backtest(
    strategy="MA策略",
    start_date="2024-01-01",
    end_date="2024-12-31",
    backtest_init_params={
        "stock_pool": "非ST股票",
        "initial_capital": 100000,
        "max_positions": 4
    },
    params={"ma_period": 20}
)

# 获取回测结果
backtest_results = await service.get_backtest_results("backtest_id")
```

---

## 📱 前端界面

### 1. 数据查看器 (`pages/data_viewer.py`)

访问 `http://localhost:8501/data_viewer` 使用数据查看器：

**功能特性**:
- 交互式K线图（支持拖动、缩放）
- 多技术指标叠加（均线、MACD、RSI、布林带）
- 上升通道分析（实时状态和质量评估）
- 数据搜索和筛选
- 详细的数据统计信息

**使用示例**:
```python
# 通过URL参数直接访问特定股票
http://localhost:8501/data_viewer?code=000001&name=平安银行&strategy=爆发式选股策略
```

### 2. 策略扫描器 (`pages/strategy_scanner.py`)

访问 `http://localhost:8501/strategy_scanner` 使用策略扫描器：

**功能特性**:
- 8种预置交易策略
- 可视化参数配置
- 实时结果展示
- 数据导出功能
- 策略性能对比

### 3. 回测页面 (`pages/backtest.py`)

访问 `http://localhost:8501/backtest` 使用回测功能：

**功能特性**:
- 策略回测验证
- 参数优化
- 详细回测报告
- 多策略性能对比
- 风险指标分析

---

## 🛠️ 工具类

### 1. 技术指标计算 (`backend/utils/indicators.py`)

```python
from backend.utils.indicators import CalIndicators

# 移动平均线
ma20 = CalIndicators.sma(df, 20, 'close')
ema20 = CalIndicators.ema(df, 20, 'close')

# RSI指标
rsi = CalIndicators.rsi(df, 14)

# MACD指标
macd, signal, hist = CalIndicators.macd(df, 12, 26, 9)

# 布林带
mid, upper, lower = CalIndicators.bollinger_bands(df, 20, 2.0)

# KDJ指标
k, d, j = CalIndicators.kdj(df, 9, 3)

# DMI指标
pdi, mdi, adx = CalIndicators.dmi(df, 14)

# 上升通道分析
channel_info = CalIndicators.ascending_channel(df, **params)
```

### 2. 数据格式化 (`backend/utils/format_info.py`)

```python
from backend.utils.format_info import stock_code_dot, stock_code_plain

# 格式化股票代码
code_with_dot = stock_code_dot("000001")  # 返回 "sz.000001"
code_plain = stock_code_plain("sz.000001")  # 返回 "000001"
```

### 3. API响应处理 (`backend/utils/api_response.py`)

```python
from backend.utils.api_response import convert_to_python_types

# 转换数据类型为Python原生类型
result = convert_to_python_types(dataframe_or_dict)
```

### 4. 日志工具 (`backend/utils/logger.py`)

```python
from backend.utils.logger import setup_logger

# 设置日志记录器
logger = setup_logger("my_module", log_level=logging.INFO)

# 记录日志
logger.info("信息日志")
logger.warning("警告日志")
logger.error("错误日志")
```

---

## 📚 使用示例

### 1. 完整的策略扫描流程

```python
import asyncio
from backend.services.strategy_service import StrategyService
from backend.services.stock_service import StockService

async def main():
    # 创建服务
    strategy_service = StrategyService()
    stock_service = StockService()
    
    # 扫描股票
    results = await strategy_service.scan_stocks(
        strategy="爆发式选股策略",
        params={
            "stock_pool": "非ST股票",
            "signal": 70.0,
            "volume_ratio": 1.5
        }
    )
    
    print(f"扫描到 {len(results)} 只股票")
    
    # 获取详细信息
    for result in results[:5]:  # 前5只股票
        code = result['code']
        data = await stock_service.get_stock_data(
            code=code,
            period="daily",
            start_date="2024-12-01",
            end_date="2024-12-31"
        )
        print(f"{code}: {result['name']} - 信号强度: {result['signal']}")

# 运行
asyncio.run(main())
```

### 2. 回测分析流程

```python
from backend.business.backtest_event import run_backtest
from backend.business.backtest_event.strategies.ma import MAStrategy
from backend.business.data.data_fetcher import StockDataFetcher

# 获取数据
fetcher = StockDataFetcher()
data = fetcher.fetch_stock_data("000001.SZ", "2024-01-01", "2024-12-31")

# 运行回测
results = run_backtest(
  data=data,
  strategy_class=MAStrategy,
  initial_cash=100000.0,
  commission=0.0003,
  strategy_params={"ma_period": 20},
  strategy_name="MA策略"
)

# 分析结果
print(f"总收益率: {results['total_return']:.2%}")
print(f"年化收益率: {results['annual_return']:.2%}")
print(f"最大回撤: {results['max_drawdown']:.2%}")
print(f"夏普比率: {results['sharpe_ratio']:.2f}")
print(f"胜率: {results['win_rate']:.2%}")
```

### 3. 因子分析流程

```python
from backend.business.factor.core.engine.library.channel_analysis import AscendingChannelRegression
from backend.business.data.data_fetcher import StockDataFetcher

# 获取数据
fetcher = StockDataFetcher()
data = fetcher.fetch_stock_data("000001.SZ", "2024-01-01", "2024-12-31")

# 上升通道分析
analyzer = AscendingChannelRegression()
state = analyzer.fit_channel(data)

# 获取通道信息
channel_info = state.to_dict()

print(f"斜率: {channel_info['beta']:.4f}")
print(f"通道状态: {channel_info['channel_status']}")
print(f"拟合质量: {channel_info['r2']:.3f}")
print(f"通道宽度: {channel_info['width_pct']:.2%}")
```

---

## 🚀 部署指南

### 1. 环境准备

```bash
# 克隆项目
git clone <repository_url>
cd stock_scanner

# 创建虚拟环境
python -m venv venv
source venv/bin/activate  # Linux/Mac
# 或
venv\Scripts\activate  # Windows

# 安装依赖
pip install -r requirements.txt
```

### 2. 启动服务

```bash
# 启动后端服务
python run_backend.py

# 启动前端界面
python run_frontend.py
```

### 3. 访问地址

- **前端界面**: http://localhost:8501
- **后端API**: http://localhost:8000
- **API文档**: http://localhost:8000/docs

### 4. 环境变量配置

创建 `.env` 文件：

```bash
# 后端配置
BACKEND_URL=localhost
BACKEND_PORT=8000

# 数据库配置
MYSQL_HOST=localhost
MYSQL_PORT=3306
MYSQL_USER=your_username
MYSQL_PASSWORD=your_password
MYSQL_DATABASE=stock_scanner

# Redis配置
REDIS_HOST=localhost
REDIS_PORT=6379
```

### 5. 生产环境部署

```bash
# 使用Gunicorn启动后端
gunicorn backend.app:app -w 4 -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000

# 使用Nginx反向代理
# 配置Nginx配置文件
```

---

## 📞 技术支持

### 常见问题

1. **数据获取失败**
   - 检查网络连接
   - 验证数据源配置
   - 查看日志文件

2. **策略执行错误**
   - 检查参数配置
   - 验证数据格式
   - 查看错误日志

3. **回测结果异常**
   - 检查日期范围
   - 验证策略参数
   - 查看数据质量

### 日志位置

- **应用日志**: `logs/app.log`
- **服务日志**: `logs/*/`
- **错误日志**: 控制台输出

### 联系方式

- **项目文档**: `docs/` 目录
- **API文档**: http://localhost:8000/docs
- **使用示例**: `docs/模块使用示例/`

---

**最后更新时间**: 2025年8月5日
**文档版本**: v2.0 