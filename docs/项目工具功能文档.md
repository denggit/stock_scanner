# 股票筛选系统 - 工具功能文档

## 📋 目录

- [项目概述](#项目概述)
- [核心模块](#核心模块)
- [工具类](#工具类)
- [配置管理](#配置管理)
- [缓存系统](#缓存系统)
- [性能监控](#性能监控)
- [数据源](#数据源)
- [策略系统](#策略系统)
- [回测系统](#回测系统)
- [前端界面](#前端界面)
- [部署指南](#部署指南)

---

## 🏗️ 项目概述

这是一个功能完整的量化交易平台，包含股票数据获取、策略开发、回测分析、实时监控等功能。

### 技术栈

- **后端**: FastAPI + Python
- **前端**: Streamlit
- **数据库**: MySQL + Redis
- **数据源**: Baostock + AKShare
- **机器学习**: scikit-learn + XGBoost

---

## 🔧 核心模块

### 1. 数据源模块 (`backend/data_source/`)

#### BaostockSource

```python
from backend.data.source.baostock_src import BaostockSource

# 初始化数据源
source = BaostockSource()

# 获取股票列表
stocks = source.get_stock_list()

# 获取股票数据
data = source.get_stock_data(
  code="000001.SZ",
  start_date="2024-01-01",
  end_date="2024-12-31",
  frequency="daily"
)

# 获取财务数据
profit_data = source.get_profit_data(code="000001.SZ", year=2024)
balance_data = source.get_balance_data(code="000001.SZ", year=2024)
```

#### AKShareSource

```python
from backend.data.source.akshare_src import AKShareSource

# 获取财务数据
financial_data = AKShareSource.get_financial_data("000001", "income")

# 获取机构参与度
institution_data = AKShareSource.get_institution_participation("000001")
```

### 2. 策略系统 (`backend/strategies/`)

#### 爆发式选股策略

```python
from backend.strategies.explosive_stock import ExplosiveStockStrategy

# 初始化策略
strategy = ExplosiveStockStrategy()

# 设置参数
strategy.set_parameters({
    "volume_ma": 20,
    "rsi_period": 14,
    "signal": 70.0,
    "volume_ratio": 1.5
})

# 生成信号
signal = strategy.generate_signal(stock_data)
print(f"信号强度: {signal['signal']}")
print(f"买入建议: {signal['buy_signal']}")
```

#### 均线回踩策略

```python
from backend.strategies.ma_pullback import MAPullbackStrategy

strategy = MAPullbackStrategy()
strategy.set_parameters({
    "ma_period": 20,
    "lookback_period": 20,
    "price_margin": 0.01
})
```

#### 波段交易策略

```python
from backend.strategies.swing_trading import SwingTradingStrategy

strategy = SwingTradingStrategy()
strategy.set_parameters({
    "short_ma_period": 5,
    "long_ma_period": 20,
    "rsi_period": 14
})
```

---

## 🛠️ 工具类

### 1. 缓存管理器 (`backend/utils/cache_manager.py`)

#### 基本使用

```python
from backend.utils.cache_manager import get_cache_manager, cached

# 获取缓存管理器
cache = get_cache_manager()

# 设置缓存
cache.set("stock_data_000001", data, expire=1800)  # 30分钟过期

# 获取缓存
data = cache.get("stock_data_000001")

# 删除缓存
cache.delete("stock_data_000001")

# 清理所有缓存
cache.clear()
```

#### 缓存装饰器

```python
from backend.utils.cache_manager import stock_data_cache, strategy_result_cache

@stock_data_cache(expire=1800)
def get_stock_data(code: str, start_date: str, end_date: str):
    # 获取股票数据的逻辑
    return data

@strategy_result_cache(expire=3600)
def run_strategy(strategy_name: str, params: dict):
    # 运行策略的逻辑
    return results
```

### 2. 性能监控 (`backend/utils/performance_monitor.py`)

#### 启动监控

```python
from backend.utils.performance_monitor import get_performance_monitor, monitor_api

# 获取监控器
monitor = get_performance_monitor()

# 启动监控
monitor.start_monitoring()

# 获取当前指标
metrics = monitor.get_current_metrics()
health = monitor.get_current_health()

# 获取统计信息
stats = monitor.get_statistics()
```

#### 性能监控装饰器

```python
from backend.utils.performance_monitor import monitor_api, monitor_database, monitor_strategy

@monitor_api
def api_endpoint():
    # API逻辑
    pass

@monitor_database
def database_query():
    # 数据库查询逻辑
    pass

@monitor_strategy
def strategy_execution():
    # 策略执行逻辑
    pass
```

### 3. 技术指标计算 (`backend/utils/indicators.py`)

```python
from backend.utils.indicators import CalIndicators

# 计算移动平均线
ma20 = CalIndicators.ema(df, 20, 'close')

# 计算RSI
rsi = CalIndicators.rsi(df, 14)

# 计算MACD
macd, signal, hist = CalIndicators.macd(df)

# 计算布林带
mid, upper, lower = CalIndicators.bollinger_bands(df, 20, 2.0)
```

---

## ⚙️ 配置管理

### 应用配置 (`backend/configs/app_config.py`)

```python
from backend.configs.app_config import get_config

# 获取配置
config = get_config()

# 数据库配置
db_url = config.get_database_url()
db_config = config.database

# Redis配置
redis_url = config.get_redis_url()

# 策略配置
strategy_config = config.strategy
min_signal_score = strategy_config.min_signal_score

# 缓存配置
cache_config = config.cache
stock_data_expire = cache_config.stock_data_expire

# 环境判断
if config.is_production():
    # 生产环境逻辑
    pass
elif config.is_development():
    # 开发环境逻辑
    pass
```

### 环境变量配置

```bash
# 数据库配置
MYSQL_HOST=localhost
MYSQL_PORT=3306
MYSQL_USER=your_username
MYSQL_PASSWORD=your_password
MYSQL_DATABASE=stock_scanner

# Redis配置
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0

# 后端配置
BACKEND_URL=localhost
BACKEND_PORT=8000

# 环境配置
ENVIRONMENT=development
DEBUG=true
```

---

## 📊 数据管理

### 数据库管理器 (`backend/data/database.py`)

```python
from backend.data.data_manager import DatabaseManager

# 初始化数据库管理器
db = DatabaseManager()

# 获取股票数据
data = db.get_stock_daily("000001.SZ", "2024-01-01", "2024-12-31")

# 更新股票数据
db.update_stock_daily("000001.SZ", stock_df, adjust="3")

# 获取股票列表
stock_list = db.get_stock_list()

# 保存财务数据
db.save_financial_data(financial_df, "profit")
```

### 数据更新管理器 (`backend/data/data_manager.py`)

```python
from backend.data.data_update import DataUpdateManager

# 初始化数据更新管理器
manager = DataUpdateManager()

# 更新股票列表
manager.update_stock_list()

# 更新日线数据
manager.update_daily_data(start_date="2024-01-01", end_date="2024-12-31")

# 更新财务数据
manager.update_financial_data(year=2024)
```

---

## 🎯 策略开发

### 策略基类 (`backend/strategies/base.py`)

```python
from backend.strategies.base import BaseStrategy

class MyStrategy(BaseStrategy):
    def __init__(self):
        super().__init__(name="我的策略", description="策略描述")
        self._init_params()
    
    def _init_params(self):
        self._params = {
            "param1": 10,
            "param2": 20
        }
    
    def generate_signal(self, data: pd.DataFrame) -> pd.Series:
        # 实现策略逻辑
        # 返回信号Series
        return signal
```

### 策略服务 (`backend/services/strategy_service.py`)

```python
from backend.services.strategy_service import StrategyService

# 初始化策略服务
service = StrategyService()

# 扫描股票
results = await service.scan_stocks("爆发式选股策略", {
    "volume_ma": 20,
    "signal": 70.0
})

# 获取策略列表
strategies = await service.list_strategies()
```

---

## 📈 回测系统

### 回测服务 (`backend/services/backtest_service.py`)

```python
from backend.services.backtest_service import BacktestService

# 初始化回测服务
backtest = BacktestService()

# 运行回测
results = await backtest.run_backtest(
    strategy="爆发式选股策略",
    start_date="2024-01-01",
    end_date="2024-12-31",
    backtest_init_params={
        "stock_pool": "非ST股票",
        "initial_capital": 100000,
        "max_positions": 4,
        "allocation_strategy": "信号强度加权"
    },
    params={
        "volume_ma": 20,
        "signal": 70.0
    }
)
```

### 回测结果分析

```python
# 获取回测指标
total_return = results['total_return']
max_drawdown = results['max_drawdown']
sharpe_ratio = results['sharpe_ratio']

# 获取交易记录
trades = results['trades']

# 获取持仓记录
positions = results['positions']
```

---

## 🌐 前端界面

### 数据查看器 (`pages/data_viewer.py`)

访问 `http://localhost:8501` 进入数据查看器：

- **股票代码输入**: 输入股票代码（如：000001.SZ）
- **时间范围选择**: 选择开始和结束日期
- **技术指标显示**:
    - K线图
    - 移动平均线
    - MACD指标
    - RSI指标
    - 布林带
    - 成交量

### 策略扫描器 (`pages/strategy_scanner.py`)

访问策略扫描器页面：

- **策略选择**: 选择要使用的策略
- **参数配置**: 设置策略参数
- **股票池选择**: 选择扫描的股票范围
- **结果展示**: 显示符合条件的股票列表

### 回测系统 (`pages/backtest.py`)

访问回测系统页面：

- **回测参数设置**: 设置回测时间、资金等
- **策略参数配置**: 配置策略参数
- **结果分析**: 查看回测结果和图表

---

## 🚀 部署指南

### 1. 环境准备

```bash
# 创建虚拟环境
python -m venv venv
source venv/bin/activate  # Linux/Mac
# 或
venv\Scripts\activate  # Windows

# 安装依赖
pip install -r requirements.txt
```

### 2. 数据库配置

```bash
# 安装MySQL
# 创建数据库
CREATE DATABASE stock_scanner;

# 安装Redis
# 启动Redis服务
redis-server
```

### 3. 环境变量配置

创建 `.env` 文件：

```env
MYSQL_HOST=localhost
MYSQL_PORT=3306
MYSQL_USER=your_username
MYSQL_PASSWORD=your_password
MYSQL_DATABASE=stock_scanner

REDIS_HOST=localhost
REDIS_PORT=6379

BACKEND_URL=localhost
BACKEND_PORT=8000

ENVIRONMENT=development
DEBUG=true
```

### 4. 启动服务

```bash
# 启动后端服务
python run_backend.py

# 启动前端服务
python run_frontend.py
```

### 5. 数据初始化

```python
from backend.data.data_update import DataUpdateManager

# 初始化数据
manager = DataUpdateManager()
manager.update_stock_list()
manager.update_daily_data()
```

---

## 📝 常用工具函数

### 1. 日志工具 (`backend/utils/logger.py`)

```python
from backend.utils.logger import setup_logger

# 设置日志
logger = setup_logger("my_module")

# 使用日志
logger.info("信息日志")
logger.warning("警告日志")
logger.error("错误日志")
logger.debug("调试日志")
```

### 2. 文件工具 (`backend/utils/file_check.py`)

```python
from backend.utils.file_check import ensure_dir

# 确保目录存在
ensure_dir("path/to/directory")
```

### 3. 格式化工具 (`backend/utils/format_info.py`)

```python
from backend.utils import format_info

# 格式化股票代码
formatted_code = format_info.stock_code("000001")
```

---

## 🔍 调试和监控

### 1. 性能监控

```python
# 查看当前性能指标
monitor = get_performance_monitor()
metrics = monitor.get_current_metrics()
print(f"CPU使用率: {metrics.cpu_percent}%")
print(f"内存使用率: {metrics.memory_percent}%")

# 查看健康状态
health = monitor.get_current_health()
print(f"系统状态: {health.status}")
print(f"问题信息: {health.message}")
```

### 2. 缓存监控

```python
# 查看缓存使用情况
cache = get_cache_manager()
usage = cache.get_memory_usage()
print(f"内存缓存大小: {usage['memory_cache_size']}")
print(f"Redis键数量: {usage['redis_keys']}")

# 清理过期缓存
cleaned = cache.cleanup_expired()
print(f"清理了 {cleaned} 个过期缓存")
```

### 3. 数据库监控

```python
# 检查数据库连接
db = DatabaseManager()
try:
    db.conn.ping()
    print("数据库连接正常")
except:
    print("数据库连接异常")
```

---

## 📚 最佳实践

### 1. 策略开发

- 继承 `BaseStrategy` 类
- 实现 `generate_signal` 方法
- 使用参数化配置
- 添加适当的日志记录

### 2. 数据处理

- 使用缓存装饰器提高性能
- 处理异常情况
- 验证数据完整性

### 3. 性能优化

- 使用批量处理
- 合理设置缓存过期时间
- 监控系统资源使用

### 4. 错误处理

- 使用具体的异常类型
- 添加重试机制
- 记录详细的错误信息

---

## 🆘 常见问题

### 1. 数据源连接失败

```python
# 检查网络连接
# 检查API密钥
# 查看错误日志
```

### 2. 数据库连接问题

```python
# 检查数据库服务状态
# 验证连接参数
# 检查防火墙设置
```

### 3. 策略执行缓慢

```python
# 使用缓存
# 优化算法
# 减少数据量
```

### 4. 内存使用过高

```python
# 清理缓存
# 优化数据结构
# 分批处理数据
```

---

## 📞 技术支持

如果您在使用过程中遇到问题，可以：

1. 查看日志文件 (`logs/app.log`)
2. 检查系统监控指标
3. 查看错误堆栈信息
4. 参考本文档

---

*最后更新时间: 2025年2月4日* 